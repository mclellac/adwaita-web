{% extends "base.html" %}

{% block title %}Create New Post{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .tiptap-toolbar {
    display: flex;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-s);
    flex-wrap: wrap;
  }
  .tiptap-toolbar button {
    background-color: var(--button-secondary-background-color);
    color: var(--button-secondary-text-color);
    border: 1px solid var(--button-secondary-border-color);
    border-radius: var(--radius-s);
    padding: var(--spacing-xxs) var(--spacing-xs);
    cursor: pointer;
    font-weight: bold;
  }
  /* Ensure labels for checkboxes are clickable and aligned */
  .adw-checkbox-row label {
    vertical-align: middle;
    margin-left: var(--spacing-s); /* Spacing between checkbox and label text */
  }
  .adw-checkbox-row .adw-action-row__title { /* If using title slot for label */
    margin-left: var(--spacing-s);
  }
  .adw-checkbox-row {
    /* If you want the whole row to be clickable to toggle the checkbox: */
    /* cursor: pointer; */
  }
  .adw-preferences-group .errors { /* Common error styling */
    color: var(--error-color);
    font-size: var(--font-size-small);
    margin-top: var(--spacing-xxs);
    padding-left: var(--spacing-m); /* Align with content if inside a listbox/row structure */
  }
  .adw-list-box.has-error {
      /* Maybe a border or background to indicate error in the group */
  }
  .adw-entry-row.has-error, .adw-action-row.has-error {
      /* Standard error indication for rows already applies via subtitle or Adwaita's own styling */
  }
  .adw-textarea-standalone {
    display: block !important;
    visibility: visible !important;
    background-color: var(--entry-background-color, var(--view-bg-color)) !important;
    color: var(--text-color, var(--view-fg-color)) !important;
    border: 1px solid var(--border-color, var(--borders-color)) !important;
    border-radius: var(--radius-m) !important;
    padding: var(--spacing-s) !important;
    font-family: inherit !important;
    font-size: inherit !important;
    line-height: var(--body-line-height) !important;
    min-height: 150px !important; /* Reduced min-height slightly for testing */
    width: 100% !important; /* Ensure it takes width */
    box-sizing: border-box !important; /* Ensure padding/border included in width/height */
  }
  .adw-textarea-standalone:focus {
    outline: 2px solid var(--accent-color) !important;
    outline-offset: -1px !important; /* Adjust to be inside or on the border */
    border-color: var(--accent-color) !important; /* Also change border color on focus */
  }
</style>
{% endblock %}

{% block content %}
<adw-clamp class="main-content-clamped">
  <adw-preferences-page title="Create New Post">
    <form method="POST" action="{{ url_for('create_post') }}" novalidate>
        {{ form.hidden_tag() }} {# CSRF token #}

        <!-- Temporary placement for content textarea for isolation testing -->
        <div style="padding: 10px; border: 1px dashed red; margin-bottom: 10px;">
            <label for="{{ form.content.id or 'content_field' }}">{{ form.content.label.text }} (Test Placement)</label>
            {{ form.content(
                id=form.content.id or 'content_field',
                class='adw-textarea-standalone',
                style='width: 100%; min-height: 100px; resize: vertical; box-sizing: border-box;', {# Reduced min-height for test #}
                rows='5'
            ) }}
            {% if form.content.errors %}
                <div class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xxs);">
                    {% for error in form.content.errors %}{{ error }}<br>{% endfor %}
                </div>
            {% endif %}
        </div>
        <!-- End temporary placement -->

        <adw-preferences-group title="Post Details">
            <adw-list-box>
                <adw-entry-row
                    title="{{ form.title.label.text }}"
                    name="{{ form.title.name }}"
                    id="{{ form.title.id or 'title_field' }}"
                    placeholder="Enter post title"
                    value="{{ form.title.data or '' }}"
                    {% if form.title.flags.required %}required{% endif %}
                    subtitle="{{ form.title.errors[0] if form.title.errors else '' }}"
                    class="{{ 'has-error' if form.title.errors else '' }}">
                </adw-entry-row>

                <adw-action-row title="{{ form.content.label.text }}" subtitle="Enter your post content below.">
                    <div slot="suffix" style="width:100%; padding-top: var(--spacing-xs);"> {# Added padding-top for spacing #}
                        {{ form.content(
                            id=form.content.id or 'content_field',
                            class='adw-textarea-standalone',
                            style='width: 100%; min-height: 200px; resize: vertical; box-sizing: border-box;',
                            rows='10'
                        ) }}
                        {% if form.content.errors %}
                            <div class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xxs);">
                                {% for error in form.content.errors %}{{ error }}<br>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </adw-action-row>
            </adw-list-box>
        </adw-preferences-group>

        <adw-preferences-group title="{{ form.categories.label.text }}">
            <adw-list-box class="{{ 'has-error' if form.categories.errors else '' }}">
                {% for subfield in form.categories %}
                <adw-action-row class="adw-checkbox-row">
                    {# Using prefix slot for better control over layout with label #}
                    <div slot="prefix" style="display:flex; align-items:center;">
                      {{ subfield(class_="adw-checkbox", id=subfield.id) }}
                      <label for="{{ subfield.id }}" style="margin-left: var(--spacing-s);">{{ subfield.label.text }}</label>
                    </div>
                </adw-action-row>
                {% endfor %}
            </adw-list-box>
            {% if form.categories.errors %}
            <adw-list-box> <adw-action-row subtitle="{{ form.categories.errors|join(' ') }}" class="error-row"></adw-action-row> </adw-list-box>
            {% endif %}
        </adw-preferences-group>

        <adw-preferences-group title="Tags">
            <adw-list-box>
                <adw-entry-row
                    title="{{ form.tags_string.label.text }}"
                    name="{{ form.tags_string.name }}"
                    id="{{ form.tags_string.id or 'tags_string_field' }}"
                    placeholder="e.g., tech, travel, food"
                    value="{{ form.tags_string.data or '' }}"
                    subtitle="{{ form.tags_string.errors[0] if form.tags_string.errors else 'Comma-separated values.' }}"
                    class="{{ 'has-error' if form.tags_string.errors else '' }}">
                </adw-entry-row>
            </adw-list-box>
        </adw-preferences-group>

        <adw-action-row>
            <div slot="suffix" style="display: flex; justify-content: flex-end; gap: var(--spacing-s); width: 100%;">
                <adw-button type="submit" class="suggested-action" label="{{ form.submit.label.text if form.submit.label else 'Submit Post' }}"></adw-button>
            </div>
        </adw-action-row>
    </form>
  </adw-preferences-page>
</adw-clamp>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Tiptap JavaScript removed. #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG_TEXTAREA] DOMContentLoaded event fired.');
    const textareaId = '{{ form.content.id or "content_field" }}';
    const textarea = document.getElementById(textareaId);
    let suffixDiv = null;
    let actionRow = null;

    if (textarea) {
        suffixDiv = textarea.parentElement; // Assuming textarea is direct child of the suffix div
        if (suffixDiv && suffixDiv.slot === 'suffix') {
            actionRow = suffixDiv.parentElement; // Assuming suffixDiv is direct child of adw-action-row
        } else {
            // If textarea is not in a suffix div, try to find action row differently if needed
            // For now, this handles the expected structure.
            console.warn('[DEBUG_TEXTAREA] Textarea parent is not the expected suffix div:', suffixDiv);
            // Try to find the specific adw-action-row for content if direct parentage isn't as expected
            // This is a fallback selector, adjust if create_post.html structure for content is different
            let allActionRows = document.querySelectorAll('adw-action-row');
            allActionRows.forEach(row => {
                if (row.querySelector('#' + textareaId)) {
                    actionRow = row;
                    // If suffixDiv wasn't found via direct parent, try to find it within this actionRow
                    if (!suffixDiv || suffixDiv.slot !== 'suffix') {
                       let potentialSuffix = row.querySelector('div[slot="suffix"]');
                       if (potentialSuffix && potentialSuffix.contains(textarea)) {
                           suffixDiv = potentialSuffix;
                       }
                    }
                }
            });
        }
    } else {
        console.error('[DEBUG_TEXTAREA] Textarea with ID ' + textareaId + ' not found!');
    }

    function logElementDetails(element, name) {
        if (element) {
            console.log(`[DEBUG_TEXTAREA] --- ${name} ---`);
            console.log(`[DEBUG_TEXTAREA] ${name} Element:`, element);
            console.log(`[DEBUG_TEXTAREA] ${name} Inline Styles - display: '${element.style.display}', visibility: '${element.style.visibility}', opacity: '${element.style.opacity}'`);
            console.log(`[DEBUG_TEXTAREA] ${name} Dimensions - offsetWidth: ${element.offsetWidth}, offsetHeight: ${element.offsetHeight}, clientWidth: ${element.clientWidth}, clientHeight: ${element.clientHeight}`);
            const computedStyles = window.getComputedStyle(element);
            console.log(`[DEBUG_TEXTAREA] ${name} Computed Styles - display: '${computedStyles.display}', visibility: '${computedStyles.visibility}', opacity: '${computedStyles.opacity}'`);
            console.log(`[DEBUG_TEXTAREA] ${name} OuterHTML:`, element.outerHTML);
            console.log(`[DEBUG_TEXTAREA] --- End ${name} ---`);
        } else {
            console.warn(`[DEBUG_TEXTAREA] ${name} element not found or not correctly identified.`);
        }
    }

    logElementDetails(textarea, 'Textarea');
    if (suffixDiv) { // Only log if suffixDiv was found
        logElementDetails(suffixDiv, 'Suffix Div (Parent of Textarea)');
    } else {
        console.warn('[DEBUG_TEXTAREA] Suffix Div not found, cannot log details.');
    }
    if (actionRow && actionRow.matches && actionRow.matches('adw-action-row')) { // Check if it's an adw-action-row
        logElementDetails(actionRow, 'AdwActionRow (Parent of Suffix Div)');
    } else {
         console.warn('[DEBUG_TEXTAREA] AdwActionRow not found or not correctly identified, cannot log details. Found:', actionRow);
    }
    console.log('[DEBUG_TEXTAREA] Debug script execution finished.');
});
</script>
{% endblock %}
