<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}My Libadwaita Blog{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adwaita-web.css') }}">
        <script src="{{ url_for('static', filename='js/components.js') }}"></script>
    <script src="{{ url_for('static', filename='js/adw-initializer.js') }}" defer></script>
</head>
<body
  {% if current_user and current_user.is_authenticated %}
    data-server-theme="{{ current_user.theme or 'system' }}"
    data-server-accent-color="{{ current_user.accent_color or 'default' }}"
  {% else %}
    data-server-theme="system"
    data-server-accent-color="default"
  {% endif %}
>
    <adw-application-window>
        <adw-header-bar>
            <adw-window-title slot="title">Blog CMS</adw-window-title>
            <a href="{{ url_for('index') }}" class="adw-button" slot="start">Home</a>
            <a href="{{ url_for('about_page') }}" class="adw-button" slot="start">About</a>
            <a href="{{ url_for('contact_page') }}" class="adw-button" slot="start">Contact</a>
            <a href="{{ url_for('adwaita_showcase_page') }}" class="adw-button" slot="start">Showcase</a>

        {% if current_user.is_authenticated %}
            <a href="{{ url_for('profile', username=current_user.username) }}" slot="start" class="adw-button flat circular" title="View Profile" style="padding: var(--spacing-xxs); margin-right: var(--spacing-xs);">
                {% if current_user.profile_photo_url %}
                    <span class="adw-avatar size-small"> <!-- 24px -->
                        <img src="{{ url_for('static', filename=current_user.profile_photo_url) }}" alt="Avatar" class="avatar-image">
                    </span>
                {% else %}
                    <span class="adw-avatar size-small">
                        <span class="adw-avatar-text"> <!-- Adjust font size for small avatar -->
                            {% set name_parts = current_user.username.split() %}
                            {% if name_parts|length >= 1 and name_parts[0] %}
                                {{ name_parts[0][0]|upper }}
                            {% else %}
                                U
                            {% endif %}
                        </span>
                    </span>
                {% endif %}
            </a>
            <a href="{{ url_for('settings_page') }}" class="adw-button" slot="end">Settings</a>
            <a href="{{ url_for('logout') }}" class="adw-button" slot="end">Logout</a>
            <a href="{{ url_for('create_post') }}" class="adw-button suggested-action" slot="end">New Post</a>
        {% else %}
            <a href="{{ url_for('login') }}" class="adw-button" slot="end">Login</a>
        {% endif %}
        </adw-header-bar>
        <main class="adw-page">
            <div id="flash-banner-container" style="position: sticky; top: 0; z-index: 1050; padding: var(--spacing-s) 0;">
                {# Banners will be injected here by the script below #}
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    if (!window.Adw || !window.Adw.createAdwBanner || !window.Adw.createAdwToast) {
                      console.error('Adw.createAdwBanner or Adw.createAdwToast function not found.');
                      return;
                    }
                    const flashMessages = {{ messages|tojson|safe }};
                    const bannerContainer = document.getElementById('flash-banner-container'); // Still needed for banners

                    if (flashMessages) { // bannerContainer check is only relevant for banners
                      flashMessages.forEach(flashMessage => {
                        let category = flashMessage[0]; // Flask category (e.g., 'success', 'danger', 'warning', 'message')
                        const message = flashMessage[1];  // Message text

                        if (category === 'success') {
                          Adw.createAdwToast(message, { type: 'success', timeout: 5000 });
                        } else if (category === 'info' || category === 'message') { // Flask's default category is 'message'
                          Adw.createAdwToast(message, { type: 'info', timeout: 5000 });
                        } else if (category === 'danger') {
                          if (bannerContainer) {
                            Adw.createAdwBanner(message, {
                              type: 'error', // AdwBanner uses 'error' for danger
                              dismissible: true,
                              container: bannerContainer
                            });
                          } else {
                            console.error('bannerContainer not found for danger message:', message);
                          }
                        } else if (category === 'warning') {
                          if (bannerContainer) {
                            Adw.createAdwBanner(message, {
                              type: 'warning',
                              dismissible: true,
                              container: bannerContainer
                            });
                          } else {
                            console.error('bannerContainer not found for warning message:', message);
                          }
                        } else {
                          // Fallback for any other category, perhaps use a default toast or banner
                          Adw.createAdwToast(message, { timeout: 5000 }); // Default to a generic toast
                        }
                      });
                    }
                  });
                </script>
              {% endif %}
            {% endwith %}
            <div class="main-content-clamped">
                {% block content %}{% endblock %}
            </div>
        </main>
    </adw-application-window>
    {% block scripts %}{% endblock %}
</body>
</html>
