<!DOCTYPE html>
<html lang="en">
<head>
    {# Global JS Error and Unhandled Promise Rejection Handlers REMOVED #}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}My Libadwaita Blog{% endblock %}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    {# Anti-flicker theme script REMOVED - Rely on components.js and body data attributes #}
    <script>
        // Initialize Adw.config for components
        window.Adw = window.Adw || {};
        window.Adw.config = {
            // cssPath should be relative to the HTML file served by Flask.
            cssPath: "{{ url_for('static', filename='css/adwaita-web.css') }}",
            // iconBasePath should also be relative to the HTML file.
            iconBasePath: "{{ url_for('static', filename='data/icons/symbolic/') }}"
        };
        console.log('[Debug] Adw.config initialized:', JSON.stringify(window.Adw.config));
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adwaita-web.css') }}">
    <style>
      /* General error text styling for form validation */
      .form-error-text,
      .error-row .adw-action-row__subtitle, /* Target subtitle within an error-row */
      adw-entry-row[data-error] .adw-entry-row__subtitle, /* Target subtitle of entry row with error */
      .errors /* Legacy class from create_post, ensure it uses Adwaita vars */ {
        color: var(--error-fg-color, var(--destructive-color)); /* Use --error-fg-color, fallback to --destructive-color */
        font-size: var(--font-size-small);
      }
      adw-entry-row[data-error] .adw-entry {
        border-color: var(--error-bg-color, var(--destructive-bg-color)); /* Highlight entry border */
      }
      /* Ensure subtitles in adw-entry-row that are errors get the error color */
      adw-entry-row.has-error .adw-entry-row__subtitle {
        color: var(--error-fg-color, var(--destructive-color));
      }

      /* Styles for flashed messages to align with Adwaita */
      .flash-message-base {
        padding: var(--spacing-m);
        margin-bottom: var(--spacing-m);
        border-radius: var(--border-radius-lg);
        border: 1px solid transparent;
        font-size: var(--font-size-body);
      }
      .flash-message-danger, .flash-message-error { /* Flask uses 'danger' for errors */
        background-color: var(--error-bg-color, #e01b24);
        color: var(--error-fg-color, #ffffff);
        border-color: var(--error-shade-color, var(--destructive-color));
      }
      .flash-message-success {
        background-color: var(--success-bg-color, #2ec27e);
        color: var(--success-fg-color, #ffffff);
        border-color: var(--success-shade-color, var(--success-color));
      }
      .flash-message-warning {
        background-color: var(--warning-bg-color, #e5a50a);
        color: var(--warning-fg-color, rgba(0,0,0,0.8));
        border-color: var(--warning-shade-color, var(--warning-color));
      }
      .flash-message-info, .flash-message-message { /* Flask uses 'message' for info */
        background-color: var(--accent-bg-color, #3584e4); /* Or a more neutral info color if available */
        color: var(--accent-fg-color, #ffffff);
        border-color: var(--accent-shade-color, var(--accent-color));
      }
    </style>
    {# components.js should contain Adw object initialization and initial theme/accent application #}
    <script type="module" src="{{ url_for('static', filename='js/components.js') }}"></script>

    {# Tiptap Editor - Core (for rich text editing) - REMOVED #}
    <style>
        /* Tiptap styles removed */
    </style>
    <style>
      /* Initially hide Adwaita content to prevent FOUC */
      .adw-initializing {
        visibility: hidden;
      }
    </style>
</head>
<body
  {# Pass server-side preferences for Adw.js to pick up if needed #}
  {% if current_user and current_user.is_authenticated and current_user.theme %}
    data-theme-preference="{{ current_user.theme }}"
  {% endif %}
  {% if current_user and current_user.is_authenticated and current_user.accent_color %}
    data-accent-preference="{{ current_user.accent_color }}"
  {% endif %}
>
    {# Initial theme and accent application script.
       This should ideally be part of Adw.js initialization logic (components.js)
       but added here explicitly to ensure it runs.
       It relies on Adw.js being loaded and Adw object available.
    #}
    <!--
      The DOMContentLoaded script that was here to apply DB theme/accent preferences
      has been removed. This logic is now centralized within Adw.applyFinalThemeAndAccent()
      which is called by components.js.
      The data-theme-preference and data-accent-preference attributes on the <body> tag
      will be read by Adw.applyFinalThemeAndAccent().
    -->
    <adw-application-window class="adw-initializing">
        <adw-header-bar>
            <adw-window-title slot="title">Blog CMS</adw-window-title>
            <adw-button href="{{ url_for('index') }}" slot="start">Home</adw-button>
            <adw-button href="{{ url_for('about_page') }}" slot="start">About</adw-button>
            <adw-button href="{{ url_for('contact_page') }}" slot="start">Contact</adw-button>
            <form action="{{ url_for('search_results') }}" method="GET" slot="start" style="display: flex; align-items: center; gap: var(--spacing-xs); margin-left: var(--spacing-s);">
                <adw-entry name="q" placeholder="Search posts..." value="{{ request.args.get('q', '') }}" style="min-width: 150px;"></adw-entry> {# Added min-width for better appearance #}
                <adw-button type="submit" flat aria-label="Search">
                    Search
                </adw-button>
            </form>

        {% if current_user.is_authenticated %}
            <adw-button href="{{ url_for('profile', username=current_user.username) }}" slot="start" flat circular title="View Profile" style="padding: var(--spacing-xxs); margin-right: var(--spacing-xs);">
                {% if current_user.profile_photo_url %}
                    <span class="adw-avatar size-small"> <!-- 24px -->
                        <img src="{{ url_for('static', filename=current_user.profile_photo_url) }}" alt="Avatar" class="avatar-image">
                    </span>
                {% else %}
                    <span class="adw-avatar size-small">
                        <span class="adw-avatar-text"> <!-- Adjust font size for small avatar -->
                            {% set name_parts = current_user.username.split() %}
                            {% if name_parts|length >= 1 and name_parts[0] %}
                                {{ name_parts[0][0]|upper }}
                            {% else %}
                                U
                            {% endif %}
                        </span>
                    </span>
                {% endif %}
            </adw-button>
            <adw-button href="{{ url_for('settings_page') }}" slot="end">Settings</adw-button>
            <adw-button href="{{ url_for('logout') }}" slot="end">Logout</adw-button>
            <adw-button href="{{ url_for('create_post') }}" suggested slot="end">New Post</adw-button>
        {% else %}
            <adw-button href="{{ url_for('login') }}" slot="end">Login</adw-button>
        {% endif %}
        </adw-header-bar>
        <main class="adw-page">
            <div id="flash-banner-container" style="position: sticky; top: 0; z-index: 1050; padding: var(--spacing-s) 0;">
                {# Banners will be injected here by the script below #}
            </div>

            {# Flashed messages script REMOVED for aggressive JS reduction #}
            {# Fallback: Render flashed messages directly if needed, without JS #}
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div id="manual-flash-messages" style="position: sticky; top: 0; z-index: 1050; padding: var(--spacing-m) var(--spacing-xl) 0;"> {# Adjusted padding #}
                  {% for category, message in messages %}
                    {% set category_class = 'flash-message-' ~ (category if category != 'message' else 'info') %}
                    <div class="flash-message-base {{ category_class }}" role="alert">
                      {{ message }}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <div class="main-content-clamped">
                {% block content %}{% endblock %}
            </div>
        </main>
    </adw-application-window>
    {% block scripts %}{% endblock %}
    {# Final console log REMOVED #}
</body>
</html>
