<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('[Debug] Global JS Error:', message, 'at', source, 'line:', lineno, 'col:', colno, 'Error object:', error);
            var errorBanner = document.getElementById('js-error-banner');
            if (!errorBanner) {
                errorBanner = document.createElement('div');
                errorBanner.id = 'js-error-banner';
                errorBanner.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:var(--error-bg-color, #d32f2f);color:var(--error-fg-color, white);padding:10px;z-index:9999;font-family:monospace;font-size:14px;';
                // Prepend to body if body exists, otherwise wait for DOMContentLoaded
                if (document.body) {
                    document.body.prepend(errorBanner);
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        if(document.body) document.body.prepend(errorBanner);
                    });
                }
            }
            // Add new error to the banner, rather than replacing
            const errorText = document.createElement('p');
            errorText.style.margin = '2px 0';
            errorText.textContent = `ERROR: ${message} (at ${source.substring(source.lastIndexOf('/')+1)}:${lineno})`;
            errorBanner.appendChild(errorText);
            return false; // False to prevent default browser error handling (e.g., stopping other scripts)
        };

        window.onunhandledrejection = function(event) {
            console.error('[Debug] Unhandled Promise Rejection:', event.reason);
            var rejectionBanner = document.getElementById('js-rejection-banner');
             if (!rejectionBanner) {
                rejectionBanner = document.createElement('div');
                rejectionBanner.id = 'js-rejection-banner';
                rejectionBanner.style.cssText = 'position:fixed;top:100px;left:0;width:100%;background:var(--warning-bg-color, #ffa000);color:var(--warning-fg-color, black);padding:10px;z-index:9998;font-family:monospace;font-size:14px;';
                 if (document.body) {
                    document.body.prepend(rejectionBanner);
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                       if(document.body) document.body.prepend(rejectionBanner);
                    });
                }
            }
            const rejectionText = document.createElement('p');
            rejectionText.style.margin = '2px 0';
            let reasonText = 'Unknown reason';
            if (event.reason instanceof Error) {
                reasonText = `${event.reason.message} (Stack: ${event.reason.stack ? event.reason.stack.split('\n')[0] : 'N/A'})`;
            } else if (typeof event.reason === 'string') {
                reasonText = event.reason;
            } else {
                try {reasonText = JSON.stringify(event.reason);} catch(e){reasonText = 'Non-serializable object';}
            }
            rejectionText.textContent = `UNHANDLED PROMISE REJECTION: ${reasonText}`;
            rejectionBanner.appendChild(rejectionText);
        };
        console.log('[Debug] Global error handlers registered.');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}My Libadwaita Blog{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adwaita-web.css') }}">
    <style>
      /* General error text styling for form validation */
      .form-error-text,
      .error-row .adw-action-row__subtitle, /* Target subtitle within an error-row */
      adw-entry-row[data-error] .adw-entry-row__subtitle, /* Target subtitle of entry row with error */
      .errors /* Legacy class from create_post, ensure it uses Adwaita vars */ {
        color: var(--error-fg-color, var(--destructive-color)); /* Use --error-fg-color, fallback to --destructive-color */
        font-size: var(--font-size-small);
      }
      adw-entry-row[data-error] .adw-entry {
        border-color: var(--error-bg-color, var(--destructive-bg-color)); /* Highlight entry border */
      }
      /* Ensure subtitles in adw-entry-row that are errors get the error color */
      adw-entry-row.has-error .adw-entry-row__subtitle {
        color: var(--error-fg-color, var(--destructive-color));
      }
    </style>
    {# components.js should contain Adw object initialization and initial theme/accent application #}
    <script type="module" src="{{ url_for('static', filename='js/components.js') }}"></script>

    {# Tiptap Editor - Core (for rich text editing) #}
    <script type="module">
        // This will make Tiptap's modules available globally for inline scripts in create_post/edit_post
        // In a bundled environment, you'd import them directly in your JS files.
        try {
            // Using JSDelivr with +esm for better ES Module support
            const TiptapCore = await import('https://cdn.jsdelivr.net/npm/@tiptap/core/+esm');
            const TiptapStarterKit = await import('https://cdn.jsdelivr.net/npm/@tiptap/starter-kit/+esm');
            const TiptapPlaceholder = await import('https://cdn.jsdelivr.net/npm/@tiptap/extension-placeholder/+esm');

            window.Tiptap = {
                Core: TiptapCore,
                // .default is common for UMD/CJS modules wrapped as ESM, check if needed for +esm versions
                StarterKit: TiptapStarterKit.StarterKit || TiptapStarterKit.default || TiptapStarterKit,
                Placeholder: TiptapPlaceholder.Placeholder || TiptapPlaceholder.default || TiptapPlaceholder,
            };

            // Verify that the main exports are functions/classes as expected
            if (typeof window.Tiptap.StarterKit !== 'function' && typeof window.Tiptap.StarterKit !== 'object') { // StarterKit is a class / object with configure
                 console.warn('[Debug] Tiptap StarterKit does not seem to be loaded correctly. Expected a class or object.', window.Tiptap.StarterKit);
            }
            if (typeof window.Tiptap.Placeholder !== 'function' && typeof window.Tiptap.Placeholder !== 'object') { // Placeholder is a class
                 console.warn('[Debug] Tiptap Placeholder does not seem to be loaded correctly. Expected a class or object.', window.Tiptap.Placeholder);
            }

            console.log('[Debug] Tiptap modules loaded via JSDelivr dynamic import.');
        } catch (error) {
            console.error('[Debug] Failed to load Tiptap modules from JSDelivr:', error);
            // Fallback or error message can be handled here
        }
    </script>
    <style>
        /* Basic Tiptap Styling */
        .tiptap {
            border: 1px solid var(--border-color, #ccc);
            border-radius: var(--border-radius-sm, 4px);
            padding: var(--spacing-s, 8px);
            min-height: 150px; /* Same as original textarea */
            background-color: var(--view-bg-color, white);
            color: var(--view-fg-color, black);
        }
        .tiptap:focus {
            outline: none;
            border-color: var(--accent-color, #3584e4); /* Adwaita accent blue */
            box-shadow: 0 0 0 2px var(--accent-color-transparent, rgba(53, 132, 228, 0.2));
        }
        .tiptap p.is-editor-empty:first-child::before {
          content: attr(data-placeholder);
          float: left;
          color: var(--secondary-text-color, #aaa);
          pointer-events: none;
          height: 0;
        }
        .tiptap-toolbar button {
            font-family: inherit;
            background: var(--button-bg-color, #f0f0f0);
            color: var(--button-fg-color, #222);
            border: 1px solid var(--button-border-color, #ccc);
            padding: var(--spacing-xs, 4px) var(--spacing-s, 8px);
            margin-right: var(--spacing-xs, 4px);
            border-radius: var(--border-radius-sm, 4px);
            cursor: pointer;
        }
        .tiptap-toolbar button.is-active {
            background: var(--accent-bg-color, #3584e4);
            color: var(--accent-fg-color, white);
        }
        .tiptap-toolbar {
            margin-bottom: var(--spacing-s, 8px);
            padding: var(--spacing-xs, 4px);
            background-color: var(--headerbar-bg-color, #fafafa);
            border: 1px solid var(--border-color, #ccc);
            border-radius: var(--border-radius-sm);
        }
    </style>
</head>
<body
  {# Pass server-side preferences for Adw.js to pick up if needed #}
  {% if current_user and current_user.is_authenticated and current_user.theme %}
    data-theme-preference="{{ current_user.theme }}"
  {% endif %}
  {% if current_user and current_user.is_authenticated and current_user.accent_color %}
    data-accent-preference="{{ current_user.accent_color }}"
  {% endif %}
>
    {# Initial theme and accent application script.
       This should ideally be part of Adw.js initialization logic (components.js)
       but added here explicitly to ensure it runs.
       It relies on Adw.js being loaded and Adw object available.
    #}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof Adw !== 'undefined' && Adw.AdwInitializer) {
            // AdwInitializer might already handle localStorage and system preferences.
            // We explicitly set based on server-provided user preference if available.
            const body = document.body;
            const userTheme = body.dataset.themePreference;
            const userAccent = body.dataset.accentPreference;

            if (userTheme) {
                // Adw.toggleTheme(theme, applyOnly=true) could be a potential API
                // For now, directly manipulate class if Adw.js doesn't auto-apply from data-*
                // Adw.js components.js likely already applies theme from localStorage or system.
                // This is to override with DB preference if it differs.
                console.log(`[Debug] Applying saved theme from DB: ${userTheme}`);
                if (userTheme === 'light') {
                    document.body.classList.add('light-theme');
                    document.body.classList.remove('dark-theme'); // Ensure dark is off
                } else if (userTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('light-theme'); // Ensure light is off
                } else { // 'system' or unspecified
                    // Let Adw.js default (localStorage or prefers-color-scheme) handle it
                    // Or explicitly call Adw.toggleTheme('system') if that's how it works
                }
            }

            if (userAccent && Adw.setAccentColor) {
                console.log(`[Debug] Applying saved accent color from DB: ${userAccent}`);
                Adw.setAccentColor(userAccent);
            }
        } else {
            console.warn('[Debug] Adw object or Adw.AdwInitializer not found on DOMContentLoaded for base.html theme/accent setup.');
        }
      });
    </script>
    <adw-application-window>
        <adw-header-bar>
            <adw-window-title slot="title">Blog CMS</adw-window-title>
            <a href="{{ url_for('index') }}" class="adw-button" slot="start">Home</a>
            <a href="{{ url_for('about_page') }}" class="adw-button" slot="start">About</a>
            <a href="{{ url_for('contact_page') }}" class="adw-button" slot="start">Contact</a>
            <form action="{{ url_for('search_results') }}" method="GET" slot="start" style="display: flex; align-items: center; gap: var(--spacing-xs); margin-left: var(--spacing-s);">
                <adw-entry name="q" placeholder="Search posts..." value="{{ request.args.get('q', '') }}" style="min-width: 150px;"></adw-entry> {# Added min-width for better appearance #}
                <adw-button type="submit" flat aria-label="Search">
                    Search
                </adw-button>
            </form>

        {% if current_user.is_authenticated %}
            <adw-button href="{{ url_for('profile', username=current_user.username) }}" slot="start" flat circular title="View Profile" style="padding: var(--spacing-xxs); margin-right: var(--spacing-xs);">
                {% if current_user.profile_photo_url %}
                    <span class="adw-avatar size-small"> <!-- 24px -->
                        <img src="{{ url_for('static', filename=current_user.profile_photo_url) }}" alt="Avatar" class="avatar-image">
                    </span>
                {% else %}
                    <span class="adw-avatar size-small">
                        <span class="adw-avatar-text"> <!-- Adjust font size for small avatar -->
                            {% set name_parts = current_user.username.split() %}
                            {% if name_parts|length >= 1 and name_parts[0] %}
                                {{ name_parts[0][0]|upper }}
                            {% else %}
                                U
                            {% endif %}
                        </span>
                    </span>
                {% endif %}
            </a>
            <a href="{{ url_for('settings_page') }}" class="adw-button" slot="end">Settings</a>
            <a href="{{ url_for('logout') }}" class="adw-button" slot="end">Logout</a>
            <a href="{{ url_for('create_post') }}" class="adw-button suggested-action" slot="end">New Post</a>
        {% else %}
            <a href="{{ url_for('login') }}" class="adw-button" slot="end">Login</a>
        {% endif %}
        </adw-header-bar>
        <main class="adw-page">
            <div id="flash-banner-container" style="position: sticky; top: 0; z-index: 1050; padding: var(--spacing-s) 0;">
                {# Banners will be injected here by the script below #}
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    if (!window.Adw || !window.Adw.createBanner || !window.Adw.createToast) {
                      console.error('Adw.createBanner or Adw.createToast function not found. Check components.js for correct export names.');
                      // Fallback to simple console logs if Adw functions are missing
                      const flashMessagesForFallback = {{ messages|tojson|safe }};
                      if (flashMessagesForFallback) {
                        flashMessagesForFallback.forEach(fm => console.log(`FALLBACK FLASH (${fm[0]}): ${fm[1]}`));
                      }
                      return;
                    }
                    const flashMessages = {{ messages|tojson|safe }};
                    const bannerContainer = document.getElementById('flash-banner-container'); // Still needed for banners

                    if (flashMessages) { // bannerContainer check is only relevant for banners
                      flashMessages.forEach(flashMessage => {
                        let category = flashMessage[0]; // Flask category (e.g., 'success', 'danger', 'warning', 'message')
                        const message = flashMessage[1];  // Message text

                        if (category === 'success') {
                          Adw.createToast(message, { type: 'success', timeout: 5000 });
                        } else if (category === 'info' || category === 'message') { // Flask's default category is 'message'
                          Adw.createToast(message, { type: 'info', timeout: 5000 });
                        } else if (category === 'danger') {
                          if (bannerContainer) {
                            const banner = Adw.createBanner(message, { // createBanner returns the element
                              type: 'error', // AdwBanner uses 'error' for danger
                              dismissible: true
                              // container: bannerContainer // Adw.createBanner doesn't take container, append it manually
                            });
                            bannerContainer.appendChild(banner);
                            banner.revealed = true; // Make it visible
                          } else {
                            console.error('bannerContainer not found for danger message:', message);
                             Adw.createToast(message, { type: 'error', timeout: 7000 }); // Fallback to toast
                          }
                        } else if (category === 'warning') {
                          if (bannerContainer) {
                             const banner = Adw.createBanner(message, {
                              type: 'warning',
                              dismissible: true
                            });
                            bannerContainer.appendChild(banner);
                            banner.revealed = true; // Make it visible
                          } else {
                            console.error('bannerContainer not found for warning message:', message);
                            Adw.createToast(message, { type: 'warning', timeout: 7000 }); // Fallback to toast
                          }
                        } else {
                          // Fallback for any other category, perhaps use a default toast or banner
                          Adw.createToast(message, { timeout: 5000 }); // Default to a generic toast
                        }
                      });
                    }
                  });
                </script>
              {% endif %}
            {% endwith %}
            <div class="main-content-clamped">
                {% block content %}{% endblock %}
            </div>
        </main>
    </adw-application-window>
    {% block scripts %}{% endblock %}
    <script>
      console.log('[Debug] HTML parsing complete. End of body reached.');
    </script>
</body>
</html>
