<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block page_title %}{% endblock %}{% if self.page_title() %} - {% endif %}{{ site_settings.get('site_title', 'My Libadwaita Blog') }}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adwaita-skin.css') }}">
</head>
<body>
  <script>
    (function() {
      const theme = "{% if current_user and current_user.is_authenticated and current_user.theme %}{{ current_user.theme }}{% else %}system{% endif %}"; // Default to system
      const accent = "{% if current_user and current_user.is_authenticated and current_user.accent_color %}{{ current_user.accent_color }}{% else %}default{% endif %}";

      let effectiveTheme = theme;
      if (theme === 'system') {
        effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      if (effectiveTheme === 'dark') {
        document.documentElement.classList.add('theme-dark');
        document.documentElement.classList.remove('theme-light');
      } else {
        document.documentElement.classList.add('theme-light');
        document.documentElement.classList.remove('theme-dark');
      }

      // For accent colors, Adwaita CSS typically handles this via body classes like accent-blue, accent-green etc.
      // The following is a conceptual way to apply it if the CSS is structured for it.
      // Ensure your adwaita-skin.css has rules for .accent-blue, .accent-red etc. on body or html.
      const validAccents = ['default', 'blue', 'green', 'yellow', 'orange', 'red', 'purple', 'pink']; // Updated list
      let accentClassFound = false;
      document.documentElement.classList.forEach(cls => {
        if (cls.startsWith('accent-')) {
          if (cls === `accent-${accent}`) {
            accentClassFound = true; // Current accent is already set
          } else {
            document.documentElement.classList.remove(cls); // Remove other accent classes
          }
        }
      });

      if (accent !== 'default' && validAccents.includes(accent) && !accentClassFound) {
        document.documentElement.classList.add(`accent-${accent}`);
      } else if (accent === 'default') {
        // All non-default accent classes should have been removed by the loop above.
        // The base :root styles (which default to blue) will apply.
      }
    })();
  </script>

<header class="adw-header-bar">
    <div class="adw-header-bar__start">
        <button class="adw-button flat circular app-sidebar-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="app-sidebar">
            <span class="adw-icon icon-actions-open-menu-symbolic"></span>
        </button>
        {# Profile button moves to start for authenticated users #}
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('profile.view_profile', username=current_user.username) }}" class="adw-button flat circular profile-avatar-button" title="View Profile">
                {% if current_user.profile_photo_url %}
                    <span class="adw-avatar size-small">
                        <img src="{{ url_for('static', filename=current_user.profile_photo_url) }}" alt="Avatar">
                    </span>
                {% else %}
                    <span class="adw-avatar size-small">
                        <span class="adw-avatar-text">
                            {{ current_user.username[0]|upper if current_user.username else 'U' }}
                        </span>
                    </span>
                {% endif %}
            </a>
        {% else %}
            {# Placeholder if needed when user is not authenticated, or leave start empty #}
            {# For example, a site icon could go here, but Home is in sidebar #}
            {# <a href="{{ url_for('index') }}" class="adw-button flat circular"><span class="adw-icon icon-emblem-web-symbolic"></span></a> #}
        {% endif %}
        {# Site title link removed from here, will be handled by centered title logic #}
    </div>
    <div class="adw-header-bar__center adw-header-bar-center-box"> {# Added adw-header-bar-center-box class #}
        <h1 class="adw-header-bar__title">
            {% block header_title %}{{ site_settings.get('site_title', 'Blog Demo') }}{% endblock %}
        </h1>
    </div>
    <div class="adw-header-bar__end">
        {% block header_actions_start %}{% endblock %} {# For buttons like "Edit Profile", keep this for contextual actions #}

        {# Search, Settings, Login/Logout remain at the end #}
        <form action="{{ url_for('general.search_results') }}" method="GET" class="header-search-form">
            <input type="search" name="q" placeholder="Search..." value="{{ request.args.get('q', '') }}" class="adw-entry">
            <button type="submit" class="adw-button flat circular" aria-label="Search">
                <span class="adw-icon icon-actions-system-search-symbolic"></span>
            </button>
        </form>

        {% if current_user.is_authenticated %}
            <a href="{{ url_for('general.settings_page') }}" class="adw-button flat" title="Settings">Settings</a>
            <a href="{{ url_for('auth.logout') }}" class="adw-button flat">Logout</a>
        {% else %}
            <a href="{{ url_for('auth.login') }}" class="adw-button">Login</a>
        {% endif %}
    </div>
</header>

<div class="app-body-container"> {# NEW: Main container for sidebar + content #}
    <aside class="app-sidebar" id="app-sidebar"> {# Added id for ARIA #}
        <nav class="sidebar-nav" aria-label="Main Navigation">
            <ul>
            {% block sidebar_nav %}
                <li><a href="{{ url_for('general.index') }}" class="{{ 'active' if request.endpoint == 'general.index' else '' }}">Home</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('post.create_post') }}" class="{{ 'active' if request.endpoint == 'post.create_post' else '' }}">New Post</a></li>
                <li><a href="{{ url_for('general.dashboard') }}" class="{{ 'active' if request.endpoint == 'general.dashboard' else '' }}">Dashboard</a></li>
            {% if current_user.is_admin %}
                <li><a href="{{ url_for('admin.view_flags') }}" class="{{ 'active' if request.endpoint == 'admin.view_flags' else '' }}">Review Flags</a></li>
                <li><a href="{{ url_for('admin.site_settings') }}" class="{{ 'active' if request.endpoint == 'admin.site_settings' else '' }}">Site Settings</a></li>
            {% endif %}
            {% endif %}
                <li><a href="{{ url_for('general.about_page') }}" class="{{ 'active' if request.endpoint == 'general.about_page' else '' }}">About</a></li>
                <li><a href="{{ url_for('general.contact_page') }}" class="{{ 'active' if request.endpoint == 'general.contact_page' else '' }}">Contact</a></li>
            {% endblock sidebar_nav %}
            </ul>
        </nav>
    </aside>

    <div class="app-content-area"> {# NEW: Wrapper for main content + its own potential footer #}
        <div class="page-content-wrapper"> {# Replaced adw-page for more control #}
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container" style="position: sticky; top: 0; z-index: 1050; padding: 0 var(--spacing-m) var(--spacing-s);">
                {% for category, message in messages %}
                    {% set banner_class = 'adw-banner' %}
                    {% if category == 'error' %}
                    {% set banner_class = banner_class ~ ' adw-banner-error' %}
                    {% elif category == 'success' %}
                    {% set banner_class = banner_class ~ ' adw-banner-success' %}
                    {# Default 'info' or 'message' categories will use the base .adw-banner style #}
                    {% endif %}
                    <div class="{{ banner_class }} visible" role="alert" style="position: relative; top: auto; left: auto; right: auto; transform: none; opacity: 1; margin-top: var(--spacing-s);">
                    <span class="adw-banner-title">{{ message }}</span>
                    {# Optionally add a close button here that JS can hide #}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
            {% endwith %}

            <main class="adw-clamp main-content"> {# Use adw-clamp for content width control #}
                {% block content %}{% endblock %}
            </main>
        </div>

        <footer class="app-footer adw-toolbar">
    {# Footer content is now minimal as nav links moved to sidebar #}
        <div class="adw-toolbar__start">
            <span class="adw-label caption">&copy; {{ current_year }} Blog Demo.</span>
        </div>
        <div class="adw-toolbar__center">
            {# Optional: social links or other footer content #}
        </div>
        <div class="adw-toolbar__end">
            {# About and Contact links removed from here #}
        </div>
    </footer>

    {% block scripts %}
    {# Theme and accent handling script is above, this is for other scripts #}
    <script src="{{ url_for('static', filename='js/app-layout.js') }}" defer></script>
    {# toast.js will be included via the build process of adwaita-web's JS #}
    {% endblock %}

    <div id="adw-toast-overlay" class="adw-toast-overlay">
        {# Toasts will be dynamically added here by JavaScript #}
    </div>
    <div class="app-sidebar-backdrop"></div> {# Added for mobile sidebar overlay #}
</body>
</html>
