{% extends "base.html" %}
{% block title %}Login{% endblock %}

{% block content %}
<div style="display: flex; justify-content: center; align-items: center; min-height: 70vh; padding-top: var(--spacing-xxl); padding-bottom: var(--spacing-xxl);">
  <div style="width: 400px; display: flex; flex-direction: column; gap: var(--spacing-lg);"> {# Outer container for centering and width, with gap for button spacing #}
    <h2 style="text-align: center; font-size: var(--font-size-h1);">Login</h2>

    {# Flashed messages will be handled by base.html's script #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {# This block itself doesn't render anything visible here #}
    {% endwith %}

    <form method="POST" action="{{ url_for('login') }}" id="login-form" style="display: flex; flex-direction: column; gap: var(--spacing-m);">
      {{ form.hidden_tag() }} {# CSRF token #}

      <adw-preferences-group title="Account Credentials">
        {# Username Field #}
        {# Render the actual input field for WTForms compatibility #}
        {{ form.username(class="adw-entry", placeholder="Enter your username", style="display:none;") }}
        <adw-entry-row title="{{ form.username.label.text }}"
                         id="username-row" {# Use a specific ID for JS targeting #}
                         required
                         placeholder="Enter your username"
                         value="{{ form.username.data or '' }}"
                         subtitle="{{ form.username.errors|join(' ') if form.username.errors else '' }}"
                         class="{{ 'has-error' if form.username.errors else '' }}">
        </adw-entry-row>

        {# Password Field - Use adw-password-entry-row #}
        {# Render the actual input field for WTForms compatibility #}
        {{ form.password(class="adw-entry", placeholder="Enter your password", style="display:none;") }}
        <adw-password-entry-row title="{{ form.password.label.text }}"
                                id="password-row" {# Use a specific ID for JS targeting #}
                                required
                                placeholder="Enter your password"
                                subtitle="{{ form.password.errors|join(' ') if form.password.errors else '' }}"
                                class="{{ 'has-error' if form.password.errors else '' }}">
        </adw-password-entry-row>
      </adw-preferences-group>

      {# Ensure the submit button is a standard HTML button to help with Enter key submission #}
      <button type="submit" class="adw-button suggested" style="width: 100%; margin-top: var(--spacing-m);">{{ form.submit.label.text }}</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const loginForm = document.getElementById('login-form');
    const usernameRow = document.getElementById('username-row');
    const passwordRow = document.getElementById('password-row');
    const actualUsernameInput = document.querySelector('input[name="{{ form.username.name }}"]');
    const actualPasswordInput = document.querySelector('input[name="{{ form.password.name }}"]');

    if (loginForm && usernameRow && passwordRow && actualUsernameInput && actualPasswordInput) {
        // Function to sync value from adw-entry-row to hidden input
        const syncValue = (sourceRow, targetInput) => {
            // Use the .value property of the custom element directly,
            // as AdwEntryRow/AdwPasswordEntryRow are designed to expose it.
            targetInput.value = sourceRow.value;
        };

        // Sync values before form submission
        loginForm.addEventListener('submit', function (event) {
            syncValue(usernameRow, actualUsernameInput);
            syncValue(passwordRow, actualPasswordInput);
            // console.log('Submitting with username:', actualUsernameInput.value, 'password:', actualPasswordInput.value);
        });

        // Optional: Sync on input/change from custom elements if they emit events
        // This depends on adw-entry-row and adw-password-entry-row implementation
        // For example, if they emit an 'input' or 'change' event:
        const setupSyncOnEvent = (sourceRow, targetInput, eventName = 'input') => {
            const adwInputElement = sourceRow.shadowRoot ? sourceRow.shadowRoot.querySelector('.adw-entry') : sourceRow.querySelector('.adw-entry');
            if (adwInputElement) {
                 adwInputElement.addEventListener(eventName, () => {
                    targetInput.value = adwInputElement.value;
                    // console.log(`Synced ${targetInput.name} on ${eventName}: ${targetInput.value}`);
                });
            } else {
                 // If direct input access isn't feasible, try observing attribute changes on the row itself.
                 // This is less ideal as 'value' attribute might not always reflect internal state.
                 new MutationObserver(() => {
                    targetInput.value = sourceRow.getAttribute('value') || '';
                 }).observe(sourceRow, { attributes: true, attributeFilter: ['value'] });
            }
        };

        setupSyncOnEvent(usernameRow, actualUsernameInput, 'input');
        setupSyncOnEvent(usernameRow, actualUsernameInput, 'change');
        setupSyncOnEvent(passwordRow, actualPasswordInput, 'input');
        setupSyncOnEvent(passwordRow, actualPasswordInput, 'change');


        // For Enter key submission:
        // The form should submit with Enter if a <button type="submit"> is present.
        // If still problematic, this ensures Enter key in the custom rows attempts submission.
        const handleEnterKey = (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent any default action of the input itself
                loginForm.requestSubmit ? loginForm.requestSubmit() : loginForm.submit();
            }
        };

        const usernameInternalInput = usernameRow.shadowRoot ? usernameRow.shadowRoot.querySelector('input, adw-entry') : usernameRow.querySelector('input, adw-entry');
        if (usernameInternalInput) usernameInternalInput.addEventListener('keypress', handleEnterKey);

        const passwordInternalInput = passwordRow.shadowRoot ? passwordRow.shadowRoot.querySelector('input, adw-entry') : passwordRow.querySelector('input, adw-entry');
        if (passwordInternalInput) passwordInternalInput.addEventListener('keypress', handleEnterKey);

    } else {
        console.error('Login form or custom input rows not found for JS enhancements.');
    }
});
</script>
{% endblock %}
