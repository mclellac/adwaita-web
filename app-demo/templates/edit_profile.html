{% extends "base.html" %}

{% block title %}Edit Profile - {{ super() }}{% endblock %}

{% block content %}
<adw-clamp class="profile-edit-view" style="max-width: 700px; margin: 20px auto;">
  <adw-preferences-page title="Edit Your Profile">
    <form method="POST" action="" enctype="multipart/form-data"> {# action="" to post to current URL #}
      {{ form.hidden_tag() }}

      <adw-preferences-group title="Public Information">
        {# Display Name #}
        <adw-entry-row title="{{ form.full_name.label.text }}"
                       name="{{ form.full_name.name }}"
                       value="{{ form.full_name.data or '' }}"
                       subtitle="{{ form.full_name.errors[0] if form.full_name.errors else (form.full_name.description or '') }}">
        </adw-entry-row>

        {# Bio #}
        <adw-expander-row title="{{ form.profile_info.label.text }}" subtitle="Tell us a bit about yourself. Supports basic HTML.">
          <textarea name="{{ form.profile_info.name }}" slot="rows" rows="5" style="width: 100%; min-height: 100px; margin-top: var(--spacing-s); margin-bottom: var(--spacing-s); padding: var(--spacing-s); border: 1px solid var(--border-color); border-radius: var(--border-radius-default); background-color: var(--input-bg-color, white); color: var(--text-color);" class="adw-entry">{{ form.profile_info.data or '' }}</textarea>
          {% if form.profile_info.errors %}
          <div class="adw-input-error" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs); padding-left: var(--spacing-m); slot: rows;">
              {% for error in form.profile_info.errors %}{{ error }}<br>{% endfor %}
          </div>
          {% endif %}
        </adw-expander-row>

        {# Location #}
        <adw-entry-row title="{{ form.location.label.text }}"
                       name="{{ form.location.name }}"
                       value="{{ form.location.data or '' }}"
                       subtitle="{{ form.location.errors[0] if form.location.errors else '' }}">
        </adw-entry-row>

        {# Website URL #}
        <adw-entry-row title="{{ form.website_url.label.text }}"
                       name="{{ form.website_url.name }}"
                       type="url"
                       placeholder="https://example.com"
                       value="{{ form.website_url.data or '' }}"
                       subtitle="{{ form.website_url.errors[0] if form.website_url.errors else '' }}">
        </adw-entry-row>

        {# Make Profile Public #}
        <adw-switch-row title="{{ form.is_profile_public.label.text }}"
                        subtitle="Allow others to see your profile page"
                        name="is_profile_public_display"
                        {% if form.is_profile_public.data %}active{% endif %}>
        </adw-switch-row>
        {% if form.is_profile_public.errors %}
        <div class="adw-row-error" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xxs); padding-left: calc(var(--spacing-m) + 24px + var(--spacing-s));">
            {% for error in form.is_profile_public.errors %}{{ error }}<br>{% endfor %}
        </div>
        {% endif %}
      </adw-preferences-group>

      <adw-preferences-group title="Profile Photo">
        <adw-action-row title="{{ form.profile_photo.label.text }}" subtitle="Upload a new photo. Max 2MB.">
          <div style="display: flex; flex-direction: column; gap: var(--spacing-s); padding-top: var(--spacing-s); padding-bottom: var(--spacing-s);">
            {{ form.profile_photo(class_="adw-entry") }} {# Added adw-entry for potential styling #}
            {% if form.profile_photo.errors %}
            <div class="adw-input-error" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs);">
                {% for error in form.profile_photo.errors %}{{ error }}<br>{% endfor %}
            </div>
            {% endif %}
            {% if user_profile and user_profile.profile_photo_url %}
              <div style="margin-top: var(--spacing-m);">
                <p style="font-size: var(--font-size-small); color: var(--secondary-text-color); margin-bottom: var(--spacing-xs);">Current photo:</p>
                <img src="{{ url_for('static', filename=user_profile.profile_photo_url) }}" alt="Current profile photo" style="max-width: 100px; max-height: 100px; border-radius: var(--border-radius-default); border: 1px solid var(--border-color);">
              </div>
            {% endif %}
          </div>
        </adw-action-row>
      </adw-preferences-group>

      <div style="margin-top: var(--spacing-xl); display: flex; justify-content: flex-end; gap: var(--spacing-s);">
        <a href="{{ url_for('profile', username=current_user.username) }}" class="adw-button">Cancel</a>
        {{ form.submit(class="adw-button suggested-action") }}
      </div>
    </form>
  </adw-preferences-page>
</adw-clamp>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const publicSwitchRow = document.querySelector('adw-switch-row[name="is_profile_public_display"]');
    if (publicSwitchRow) {
      let hiddenInput = document.querySelector('input[type="hidden"][name="is_profile_public"]');
      if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'is_profile_public';
        publicSwitchRow.closest('form').appendChild(hiddenInput);
      }
      // Set initial value for hidden input. WTForms BooleanField default handling:
      // 'y', 'true', 't', '1' are True. Others False.
      // An empty string or missing value is False.
      hiddenInput.value = publicSwitchRow.active ? 'y' : '';

      publicSwitchRow.addEventListener('state-set', function(event) {
        hiddenInput.value = event.detail.active ? 'y' : '';
      });
    }
  });
</script>
{% endblock %}
