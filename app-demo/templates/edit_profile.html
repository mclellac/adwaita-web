{% extends "base.html" %}
{% block title %}Edit Profile - {{ super() }}{% endblock %}
{% block content %}
<div class="main-content-clamped">
    <h2>Edit Profile</h2>
    <form method="POST" action="{{ url_for('edit_profile') }}" enctype="multipart/form-data" novalidate>
        {{ form.hidden_tag() }} {# CSRF token #}

        {# Using adw-expander-row for profile_info #}
        {# Note: WTForms rendering inside custom elements can be tricky.
           This assumes adw-expander-row can correctly render/contain standard HTML form elements. #}
        <adw-expander-row title="Profile Information" {% if form.profile_info.errors %}expanded{% endif %}>
            {# Assigning class directly to TextAreaField #}
            {{ form.profile_info(class_='adw-entry', rows='8', id=form.profile_info.id or 'profile_info_field', **{'aria-describedby': form.profile_info.id ~ '-errors' if form.profile_info.errors else None}) }}
            {% if form.profile_info.errors %}
                <div id="{{ form.profile_info.id or 'profile_info_field' }}-errors" class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs); padding-left: var(--spacing-m); padding-bottom: var(--spacing-s);">
                    {% for error in form.profile_info.errors %}<span>{{ error }}</span><br>{% endfor %}
                </div>
            {% endif %}
        </adw-expander-row>

        {# Using adw-action-row for profile_photo #}
        <adw-action-row title="Profile Photo"
                        subtitle="{{ 'Current photo below. Upload to change.' if current_user.profile_photo_url else 'Upload new photo' }}"
                        {% if form.profile_photo.errors %}class="has-error"{% endif %}>
            {% if current_user.profile_photo_url %}
            <span slot="prefix" class="adw-avatar size-large" style="margin-right: 12px; --adw-avatar-size: 48px;">
                <img src="{{ url_for('static', filename=current_user.profile_photo_url) }}" alt="Current profile photo" style="width: 100%; height: 100%; object-fit: cover;">
            </span>
            {% endif %}

            {# Custom styling for FileField: Render the field, but hide the default input. Style its label. #}
            {# This is a common pattern for custom file input styling. #}
            {{ form.profile_photo.label(for=form.profile_photo.id or 'profile_photo_field', class_='adw-button', style='align-self: center; margin: 0; cursor: pointer;', slot='suffix') }}
            {{ form.profile_photo(id=form.profile_photo.id or 'profile_photo_field', style='display:none;', **{'aria-describedby': form.profile_photo.id ~ '-errors' if form.profile_photo.errors else None}) }}
            {% if form.profile_photo.errors %}
                 {# Error display for file input might need to be outside or styled differently if it breaks layout #}
                 <div slot="suffix" id="{{ form.profile_photo.id or 'profile_photo_field' }}-errors" class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs); width: 100%; text-align: right;">
                     {% for error in form.profile_photo.errors %}<span>{{ error }}</span><br>{% endfor %}
                 </div>
            {% endif %}
        </adw-action-row>

        <adw-entry-row
            title="{{ form.full_name.label.text }}"
            name="{{ form.full_name.name }}"
            id="{{ form.full_name.id or 'full_name_field' }}"
            value="{{ form.full_name.data or '' }}"
            placeholder="Your full name"
            {% if form.full_name.flags.required %}required{% endif %}
            style="margin-bottom: var(--spacing-s); margin-top: var(--spacing-m);"> {# Added margin-top here #}
        </adw-entry-row>
        {% if form.full_name.errors %}
            <div id="{{ form.full_name.id or 'full_name_field' }}-errors" class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs); margin-bottom: var(--spacing-m);">
                {% for error in form.full_name.errors %}<span>{{ error }}</span><br>{% endfor %}
            </div>
        {% else %}
            <div style="margin-bottom: var(--spacing-m);"></div> {# Maintain spacing #}
        {% endif %}

        <adw-entry-row
            title="{{ form.location.label.text }}"
            name="{{ form.location.name }}"
            id="{{ form.location.id or 'location_field' }}"
            value="{{ form.location.data or '' }}"
            placeholder="City, Country"
            {% if form.location.flags.required %}required{% endif %}
            style="margin-bottom: var(--spacing-s);">
        </adw-entry-row>
        {% if form.location.errors %}
            <div id="{{ form.location.id or 'location_field' }}-errors" class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs); margin-bottom: var(--spacing-m);">
                {% for error in form.location.errors %}<span>{{ error }}</span><br>{% endfor %}
            </div>
        {% else %}
            <div style="margin-bottom: var(--spacing-m);"></div> {# Maintain spacing #}
        {% endif %}

        <adw-entry-row
            title="{{ form.website_url.label.text }}"
            name="{{ form.website_url.name }}"
            id="{{ form.website_url.id or 'website_url_field' }}"
            value="{{ form.website_url.data or '' }}"
            placeholder="https://yourwebsite.com"
            type="url"
            {% if form.website_url.flags.required %}required{% endif %}
            style="margin-bottom: var(--spacing-s);">
        </adw-entry-row>
        {% if form.website_url.errors %}
            <div id="{{ form.website_url.id or 'website_url_field' }}-errors" class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs); margin-bottom: var(--spacing-m);">
                {% for error in form.website_url.errors %}<span>{{ error }}</span><br>{% endfor %}
            </div>
        {% else %}
            <div style="margin-bottom: var(--spacing-m);"></div> {# Maintain spacing #}
        {% endif %}

        <div class="form-button-container">
            {{ form.submit(class_='adw-button suggested-action', value='Save Profile') }}
            <a href="{{ url_for('profile', username=current_user.username) }}" class="adw-button">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}
