{% extends "base.html" %}

{% block title %}Edit Profile - {{ super() }}{% endblock %}

{% block content %}
<adw-preferences-view style="max-width: 700px; margin: 20px auto;">
  <adw-preferences-page title="Edit Your Profile">
    <form method="POST" action="" enctype="multipart/form-data"> {# action="" to post to current URL #}
      {{ form.hidden_tag() }}

      <adw-preferences-group title="Public Information">
        {# Display Name #}
        <adw-entry-row title="{{ form.full_name.label.text }}"
                       name="{{ form.full_name.name }}"
                       value="{{ form.full_name.data or '' }}">
        </adw-entry-row>
        {# TODO: Add {{ form.full_name.errors }} display if needed #}

        {# Bio #}
        <adw-expander-row title="{{ form.profile_info.label.text }}" subtitle="Tell us a bit about yourself. Supports basic HTML.">
          {# Using a standard textarea within the slot for multi-line input.
             The 'adw-entry' class can be added for styling if it's defined in SCSS for textareas.
             For Adwaita Web Components, a dedicated <adw-textarea-row> might be preferred if available,
             but <adw-expander-row> with a <textarea> in the slot is a valid pattern. #}
          <textarea name="{{ form.profile_info.name }}" slot="rows" rows="5" style="width: 100%; min-height: 100px; margin-top: var(--spacing-s); margin-bottom: var(--spacing-s); padding: var(--spacing-s); border: 1px solid var(--border-color); border-radius: var(--border-radius-default); background-color: var(--input-bg-color, white); color: var(--text-color);" class="adw-entry">{{ form.profile_info.data or '' }}</textarea>
        </adw-expander-row>
        {# TODO: Add {{ form.profile_info.errors }} display if needed #}

        {# Location #}
        <adw-entry-row title="{{ form.location.label.text }}"
                       name="{{ form.location.name }}"
                       value="{{ form.location.data or '' }}">
        </adw-entry-row>
        {# TODO: Add {{ form.location.errors }} display if needed #}

        {# Website URL #}
        <adw-entry-row title="{{ form.website_url.label.text }}"
                       name="{{ form.website_url.name }}"
                       type="url"
                       placeholder="https://example.com"
                       value="{{ form.website_url.data or '' }}">
        </adw-entry-row>
        {# TODO: Add {{ form.website_url.errors }} display if needed #}

        {# Make Profile Public #}
        {# Hidden input will be created/managed by JS to ensure correct form submission for the boolean value #}
        <adw-switch-row title="{{ form.is_profile_public.label.text }}"
                        subtitle="Allow others to see your profile page"
                        name="is_profile_public_display" {# Name changed to avoid conflict with hidden input if JS fails early #}
                        {% if form.is_profile_public.data %}active{% endif %}>
        </adw-switch-row>
        {# Actual input for WTForms is form.is_profile_public, which we'll manage with a hidden field via JS #}
        {# TODO: Add {{ form.is_profile_public.errors }} display if needed #}

      </adw-preferences-group>

      <adw-preferences-group title="Profile Photo">
        <adw-action-row title="{{ form.profile_photo.label.text }}" subtitle="Upload a new photo. Max 2MB.">
          {# Standard file input. For better Adwaita styling, this might need a custom component or more CSS. #}
          {# For now, using the direct WTForms field rendering. #}
          <div style="display: flex; flex-direction: column; gap: var(--spacing-s); padding-top: var(--spacing-s); padding-bottom: var(--spacing-s);">
            {{ form.profile_photo() }} {# This will render <input type="file"> #}
            {% if user_profile and user_profile.profile_photo_url %}
              <div style="margin-top: var(--spacing-m);">
                <p style="font-size: var(--font-size-small); color: var(--secondary-text-color); margin-bottom: var(--spacing-xs);">Current photo:</p>
                <img src="{{ url_for('static', filename=user_profile.profile_photo_url) }}" alt="Current profile photo" style="max-width: 100px; max-height: 100px; border-radius: var(--border-radius-default); border: 1px solid var(--border-color);">
              </div>
            {% endif %}
          </div>
        </adw-action-row>
         {# TODO: Add {{ form.profile_photo.errors }} display if needed #}
      </adw-preferences-group>

      <div style="margin-top: var(--spacing-xl); display: flex; justify-content: flex-end; gap: var(--spacing-s);">
        <a href="{{ url_for('profile', username=current_user.username) }}" class="adw-button">Cancel</a>
        {{ form.submit(class="adw-button suggested-action") }}
      </div>
    </form>
  </adw-preferences-page>
</adw-preferences-view>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const publicSwitchRow = document.querySelector('adw-switch-row[name="is_profile_public_display"]');
    if (publicSwitchRow) {
      // Create a hidden input to ensure correct boolean value is submitted for WTForms
      let hiddenInput = document.querySelector('input[type="hidden"][name="is_profile_public"]');
      if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'is_profile_public'; // This name must match the WTForms field name
        // Insert before the form's submit button or at the end of the form for simplicity,
        // or more precisely before the switch row if it's part of a specific group.
        // For ProfileEditForm, it's fine to append to the form.
        publicSwitchRow.closest('form').appendChild(hiddenInput);
      }

      // Set initial value for hidden input based on the switch's state
      // WTForms BooleanField by default expects 'y' for True, and '' or no value for False
      // when using the standard CheckboxInput widget.
      // However, if data is directly populated, it might handle True/False.
      // To be safe, we'll submit 'y' or an empty string.
      hiddenInput.value = publicSwitchRow.active ? 'y' : '';

      publicSwitchRow.addEventListener('state-set', function(event) {
        hiddenInput.value = event.detail.active ? 'y' : '';
      });
    }
  });
</script>
{% endblock %}
