{% extends "base.html" %}

{% block title %}Edit Profile{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/2.0.0/cropper.min.css" integrity="sha512-hmRL32LGLwX7LqH1LXN6q6iI1Tw0KzC/a7h1r71tY9K1L34b4KcvMvP5p3+8sLp4sL/zCgU9XwXg_bsP21q9g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  /* Additional styles for the cropper container if needed */
  .cropper-container-wrapper {
    margin-top: var(--spacing-s);
    max-width: 100%; /* Ensure it fits within the layout */
    width: 300px; /* Example fixed width */
    height: 300px; /* Example fixed height */
  }
  .cropper-container-wrapper img {
    display: block;
    max-width: 100%; /* Ensure image is responsive within the cropper */
  }
</style>
{% endblock %}

{% block content %}
<adw-clamp style="max-width: 700px; margin: var(--spacing-xl) auto;">
  <adw-preferences-page title="Edit Your Profile">
    <form method="POST" action="{{ url_for('edit_profile') }}" enctype="multipart/form-data" id="edit-profile-form">
      {{ form.hidden_tag() }} {# CSRF token #}

      {# Hidden fields for crop data #}
      <input type="hidden" name="crop_x" id="crop_x">
      <input type="hidden" name="crop_y" id="crop_y">
      <input type="hidden" name="crop_width" id="crop_width">
      <input type="hidden" name="crop_height" id="crop_height">

      <adw-preferences-group title="Public Information">
        <adw-list-box>
          {# Full Name Entry Row #}
          <adw-entry-row
            title="{{ form.full_name.label.text }}"
            name="{{ form.full_name.name }}"
            value="{{ form.full_name.data or '' }}"
            placeholder="Your full name or display name"
            subtitle="{{ form.full_name.errors[0] if form.full_name.errors else '' }}"
            class="{{ 'has-error' if form.full_name.errors else '' }}">
          </adw-entry-row>
          {# The hidden CSRF token input is still needed by form.hidden_tag() #}
          {# Also, ensure form.full_name.id is available if labels need to point to it, though adw-entry-row handles its own title #}

          {# Bio/Profile Info - Custom Row for Text Area #}
          <adw-action-row
            title="{{ form.profile_info.label.text }}"
            subtitle="Tell us a bit about yourself. Supports basic HTML.">
            <div style="width: 100%;" slot="suffix">
              {# WTForms TextareaField, styled as adw-entry #}
              {{ form.profile_info(rows="6", class="adw-entry", style="width: 100%; min-height: 120px;", id=form.profile_info.id) }}
            </div>
          </adw-action-row>
          {% if form.profile_info.errors %}
          <adw-action-row subtitle="{{ form.profile_info.errors|join(' ') }}" class="error-row"></adw-action-row>
          {% endif %}

          {# Location Entry Row #}
          <adw-entry-row
            title="{{ form.location.label.text }}"
            name="{{ form.location.name }}"
            value="{{ form.location.data or '' }}"
            placeholder="e.g., City, Country"
            subtitle="{{ form.location.errors[0] if form.location.errors else '' }}"
            class="{{ 'has-error' if form.location.errors else '' }}">
          </adw-entry-row>

          {# Website URL Entry Row #}
          <adw-entry-row
            title="{{ form.website_url.label.text }}"
            name="{{ form.website_url.name }}"
            type="url" {# adw-entry-row should support type attribute if its internal input does #}
            value="{{ form.website_url.data or '' }}"
            placeholder="https://example.com"
            subtitle="{{ form.website_url.errors[0] if form.website_url.errors else '' }}"
            class="{{ 'has-error' if form.website_url.errors else '' }}">
          </adw-entry-row>

          {# is_profile_public Switch Row #}
          <adw-switch-row
            title="{{ form.is_profile_public.label.text }}"
            subtitle="Allow others to see your profile page."
            name="{{ form.is_profile_public.name }}"
            id="{{ form.is_profile_public.id }}"
            {% if form.is_profile_public.data %}checked{% endif %}
            class="{{ 'has-error' if form.is_profile_public.errors else '' }}">
          </adw-switch-row>
          {# No explicit error display here, assuming subtitle on has-error is enough or consistent with others #}
          {% if form.is_profile_public.errors %}
          {# This is a fallback, ideally the subtitle on the switch-row itself would show the error #}
          <adw-action-row subtitle="{{ form.is_profile_public.errors|join(' ') }}" class="error-row"></adw-action-row>
          {% endif %}

        </adw-list-box>
      </adw-preferences-group>

      <adw-preferences-group title="Profile Photo">
        <adw-list-box>
          <adw-action-row
            title="{{ form.profile_photo.label.text }}"
            subtitle="Upload a new photo. Max 2MB. Recommended: Square aspect ratio.">
            <div slot="suffix" style="display: flex; flex-direction: column; align-items: flex-start; gap: var(--spacing-s);">
              <adw-button appearance="outline" id="upload-photo-button">
                <span slot="label">Choose Photo</span>
              </adw-button>
              {# The actual file input, hidden. WTForms handles its name and id. #}
              {{ form.profile_photo(id=(form.profile_photo.id or 'profile_photo_field'), style="display: none;") }}

              <div class="cropper-container-wrapper" id="cropper-wrapper" style="display: none;">
                <img id="image-to-crop" src="#" alt="Image to crop">
              </div>

              {% if user_profile and user_profile.profile_photo_url %}
              <div style="margin-top: var(--spacing-s);">
                <adw-label is_caption="true">Current photo:</adw-label>
                <adw-avatar size="64" image-src="{{ url_for('static', filename=user_profile.profile_photo_url) if user_profile.profile_photo_url else default_avatar_url }}" text="{{ current_user.username }}"></adw-avatar>
              </div>
              {% elif default_avatar_url %}
              <div style="margin-top: var(--spacing-s);">
                <adw-label is_caption="true">Default photo:</adw-label>
                <adw-avatar size="64" image-src="{{ default_avatar_url }}" text="{{ current_user.username }}"></adw-avatar>
              </div>
              {% endif %}
            </div>
          </adw-action-row>
          {% if form.profile_photo.errors %}
          <adw-action-row subtitle="{{ form.profile_photo.errors|join(' ') }}" class="error-row"></adw-action-row>
          {% endif %}
        </adw-list-box>
      </adw-preferences-group>

      <adw-action-row> {# This was adw-box before, adw-action-row is more standard for buttons at the bottom of a preferences page group/list #}
        <div slot="suffix" style="display: flex; gap: var(--spacing-s); justify-content: flex-end; width: 100%;">
            <adw-button type="link" href="{{ url_for('profile', username=current_user.username) }}">Cancel</adw-button>
            <adw-button type="submit" class="suggested-action" label="{{ form.submit.label.text if form.submit.label else 'Update Profile' }}"></adw-button>
            {# {{ form.submit() }} is no longer needed if we use adw-button for submit #}
        </div>
      </adw-action-row>
    </form>
  </adw-preferences-page>
</adw-clamp>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/2.0.0/cropper.min.js" integrity="sha512-CVn9KFL7X9gKjgQvNFvR4S+eQ82U/zVwLz9O3ZJzN46BqXJ+jT1aDqJCYxU1KqXkYl7YvGBeYQxK1iuJk2n/Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Cropper.js logic
    const imageToCrop = document.getElementById('image-to-crop');
    const photoInput = document.getElementById('{{ form.profile_photo.id or "profile_photo_field" }}');
    const uploadPhotoButton = document.getElementById('upload-photo-button');
    const cropperWrapper = document.getElementById('cropper-wrapper');
    const form = document.getElementById('edit-profile-form');
    const cropXField = document.getElementById('crop_x');
    const cropYField = document.getElementById('crop_y');
    const cropWidthField = document.getElementById('crop_width');
    const cropHeightField = document.getElementById('crop_height');
    let cropper;

    if (uploadPhotoButton && photoInput) {
      console.log('[Debug Profile Edit] Upload photo button and photo input field found.');
      uploadPhotoButton.addEventListener('click', function() {
        try {
          photoInput.click(); // Trigger the hidden file input
        } catch (e) {
          console.error("Error triggering photo input click:", e);
          // Optionally, display a user-friendly message here
        }
      });
    }

    if (photoInput) {
      photoInput.addEventListener('change', function(event) {
        try {
          const files = event.target.files;
          if (files && files.length > 0) {
            const file = files[0];
            // Client-side file type check for early feedback
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
              console.warn("Invalid file type selected:", file.type);
              photoInput.value = ''; // Reset file input
              if (cropper) {
                  cropper.destroy();
                  cropper = null;
              }
              if(imageToCrop) imageToCrop.src = '#';
              if(cropperWrapper) cropperWrapper.style.display = 'none';
              if(cropXField) cropXField.value = '';
              if(cropYField) cropYField.value = '';
              if(cropWidthField) cropWidthField.value = '';
              if(cropHeightField) cropHeightField.value = '';
              alert("Invalid file type. Please select a PNG, JPG, or GIF image."); // Simple alert for now
              return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
              try {
                if(imageToCrop) imageToCrop.src = e.target.result;
                if(cropperWrapper) cropperWrapper.style.display = 'block';
                if (cropper) {
                  cropper.destroy();
                }
                if(imageToCrop){
                  cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1 / 1, // For a square avatar
                    viewMode: 1,        // Restrict crop box to canvas
                    responsive: true,
                  });
                } else {
                   console.error("imageToCrop element not found for Cropper.");
                }
              } catch (cropperError) {
                console.error("Error initializing Cropper:", cropperError);
                if(cropperWrapper) cropperWrapper.style.display = 'none';
              }
            };
            reader.onerror = function() {
              console.error("FileReader error:", reader.error);
            };
            reader.readAsDataURL(file);
          } else {
            // No file selected, or selection cancelled
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            if(imageToCrop) imageToCrop.src = '#';
            if(cropperWrapper) cropperWrapper.style.display = 'none';
            if(cropXField) cropXField.value = '';
            if(cropYField) cropYField.value = '';
            if(cropWidthField) cropWidthField.value = '';
            if(cropHeightField) cropHeightField.value = '';
          }
        } catch (e) {
          console.error("Error in photoInput change event:", e);
        }
      });
    } else {
        console.warn("Profile photo input field not found.");
    }


    if (form) {
      form.addEventListener('submit', function(event) {
        try {
          if (cropper && photoInput && photoInput.files && photoInput.files.length > 0) {
            const cropData = cropper.getData(true); // Get rounded data
            if(cropXField) cropXField.value = cropData.x;
            if(cropYField) cropYField.value = cropData.y;
            if(cropWidthField) cropWidthField.value = cropData.width;
            if(cropHeightField) cropHeightField.value = cropData.height;
          } else {
            if(cropXField) cropXField.value = '';
            if(cropYField) cropYField.value = '';
            if(cropWidthField) cropWidthField.value = '';
            if(cropHeightField) cropHeightField.value = '';
          }
        } catch (e) {
          console.error("Error in form submit event for cropper data:", e);
        }
      });
    } else {
        console.warn("Edit profile form not found.");
    }
  });
</script>
{% endblock %}
