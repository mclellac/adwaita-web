{% extends "base.html" %}

{% block title %}Your Notifications{% endblock %}

{% block header_title %}Notifications{% endblock %}

{% block content %}
<div class="adw-clamp adw-clamp-lg">
    {% if notifications_list and notifications_list|length > 0 %}
        <div class="adw-list-box notification-list-container">
            {% for notification in notifications_list %}
            <div class="adw-action-row notification-item-row {{ 'unread-notification' if not notification.is_read else '' }}">
                <div class="adw-action-row-start-content">
                    {# Icon based on notification type #}
                    {% if notification.type == 'new_follower' %}
                        <span class="adw-icon icon-status-user-available-symbolic notification-icon"></span>
                    {% elif notification.type == 'new_like' %}
                        <span class="adw-icon icon-actions-star-symbolic notification-icon"></span>
                    {% elif notification.type == 'new_comment' %}
                        <span class="adw-icon icon-content-message-symbolic notification-icon"></span>
                    {% elif notification.type == 'mention_in_post' or notification.type == 'mention_in_comment' %}
                        <span class="adw-icon icon-content-mail-reply-sender-symbolic notification-icon"></span> {# Icon for mention #}
                    {% else %}
                        <span class="adw-icon icon-emotes-face-smile-symbolic notification-icon"></span> {# Generic #}
                    {% endif %}
                </div>
                <div class="adw-action-row-text-content">
                    <span class="adw-action-row-title notification-text">
                        {% set actor_link = '<a href="' ~ url_for('profile.view_profile', user_id=notification.actor.id) ~ '" class="adw-link">' ~ (notification.actor.full_name or notification.actor.username) ~ '</a>' if notification.actor else 'Someone' %}

                        {% if notification.type == 'new_follower' %}
                            {{ actor_link | safe }} started following you.

                        {% elif notification.type == 'new_like' %} {# Like on a Post #}
                            {% if notification.target_type == 'post' and notification.target %}
                                {{ actor_link | safe }} liked your post: <a href="{{ url_for('post.view_post', post_id=notification.target.id) }}" class="adw-link">"{{ notification.target.content | striptags | truncate(50) }}"</a>.
                            {% else %}
                                {{ actor_link | safe }} liked something. {# Fallback #}
                            {% endif %}

                        {% elif notification.type == 'new_comment' %} {# Comment on a Post #}
                            {% if notification.target_type == 'comment' and notification.target and notification.context_post %}
                                {{ actor_link | safe }} commented on your post "<a href="{{ url_for('post.view_post', post_id=notification.context_post.id, _anchor='comment-' ~ notification.target.id) }}" class="adw-link">{{ notification.context_post.content | striptags | truncate(30) }}</a>": "{{ notification.target.text | striptags | truncate(30)}}"
                            {% else %}
                                {{ actor_link | safe }} commented on something. {# Fallback #}
                            {% endif %}

                        {% elif notification.type == 'mention_in_post' %}
                            {% if notification.target_type == 'post' and notification.target %}
                                {{ actor_link | safe }} mentioned you in the post: <a href="{{ url_for('post.view_post', post_id=notification.target.id) }}" class="adw-link">"{{ notification.target.content | striptags | truncate(50) }}"</a>.
                            {% else %}
                                {{ actor_link | safe }} mentioned you in a post. {# Fallback #}
                            {% endif %}

                        {% elif notification.type == 'mention_in_comment' %} {# Mention in a Post Comment #}
                            {% if notification.target_type == 'comment' and notification.target and notification.context_post %}
                                {{ actor_link | safe }} mentioned you in a <a href="{{ url_for('post.view_post', post_id=notification.context_post.id, _anchor='comment-' ~ notification.target.id) }}" class="adw-link">comment</a>: "{{ notification.target.text | striptags | truncate(30) }}" on {{ notification.context_post.author.full_name or notification.context_post.author.username }}'s post.
                            {% else %}
                                {{ actor_link | safe }} mentioned you in a comment. {# Fallback #}
                            {% endif %}

                        {% elif notification.type == 'new_photo_like' %}
                            {% if notification.target_type == 'photo' and notification.target %}
                                {{ actor_link | safe }} liked your <a href="{{ url_for('profile.view_gallery', user_id=notification.target.user_id) }}#photo-{{ notification.target.id }}" class="adw-link">photo</a>{% if notification.target.caption %}: "{{ notification.target.caption | striptags | truncate(30) }}"{% endif %}.
                            {% else %}
                                {{ actor_link | safe }} liked a photo. {# Fallback #}
                            {% endif %}

                        {% elif notification.type == 'new_photo_comment' %}
                             {% if notification.target_type == 'comment' and notification.target and notification.context_photo %}
                                {{ actor_link | safe }} commented on your <a href="{{ url_for('profile.view_gallery', user_id=notification.context_photo.user_id) }}#photo-{{ notification.context_photo.id }}" class="adw-link">photo</a>: "{{ notification.target.text | striptags | truncate(30) }}"
                            {% else %}
                                {{ actor_link | safe }} commented on a photo. {# Fallback #}
                            {% endif %}

                        {% elif notification.type == 'mention_in_photo_comment' %}
                            {% if notification.target_type == 'comment' and notification.target and notification.context_photo %}
                                {{ actor_link | safe }} mentioned you in a comment on a <a href="{{ url_for('profile.view_gallery', user_id=notification.context_photo.user_id) }}#photo-{{ notification.context_photo.id }}" class="adw-link">photo</a>: "{{ notification.target.text | striptags | truncate(30) }}"
                            {% else %}
                                {{ actor_link | safe }} mentioned you in a comment on a photo. {# Fallback #}
                            {% endif %}

                        {% else %}
                            {{ notification.type | replace('_', ' ') | title }} {# Generic display #}
                        {% endif %}
                    </span>
                    <span class="adw-action-row-subtitle notification-timestamp">
                        <time datetime="{{ notification.timestamp.isoformat() }}">{{ notification.timestamp | human_readable_date }}</time>
                        {% if not notification.is_read %}
                            <span class="unread-dot" title="Unread">•</span>
                        {% endif %}
                    </span>
                </div>
                {# No end content needed for now, could be "Mark as read/unread" button later #}
            </div>
            {% endfor %}
        </div>

        {# Pagination Controls #}
        {% if pagination and pagination.pages > 1 %}
        <div class="adw-box adw-box-horizontal justify-center list-pagination-box" style="margin-top: var(--spacing-l);">
            <div class="adw-toggle-group">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('notification.list_notifications', page=pagination.prev_num) }}" class="adw-button icon-only" aria-label="Previous page">
                        <span class="adw-icon icon-actions-go-previous-symbolic"></span>
                    </a>
                {% else %}
                    <button class="adw-button icon-only" disabled aria-label="Previous page">
                        <span class="adw-icon icon-actions-go-previous-symbolic"></span>
                    </button>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        {% if page_num == pagination.page %}
                            <button class="adw-button suggested-action" disabled aria-current="page">{{ page_num }}</button>
                        {% else %}
                            <a href="{{ url_for('notification.list_notifications', page=page_num) }}" class="adw-button">{{ page_num }}</a>
                        {% endif %}
                    {% elif loop.index != 1 and loop.index != pagination.pages + pagination.iter_pages()|length %}
                        <button class="adw-button flat" disabled>…</button>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                     <a href="{{ url_for('notification.list_notifications', page=pagination.next_num) }}" class="adw-button icon-only" aria-label="Next page">
                        <span class="adw-icon icon-actions-go-next-symbolic"></span>
                    </a>
                {% else %}
                    <button class="adw-button icon-only" disabled aria-label="Next page">
                        <span class="adw-icon icon-actions-go-next-symbolic"></span>
                    </button>
                {% endif %}
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="adw-status-page">
            <span class="adw-icon icon-status-weather-clear-night-symbolic adw-status-page-icon app-status-page-icon"></span> {# Example icon #}
            <h3 class="adw-status-page-title">No Notifications Yet</h3>
            <p class="adw-status-page-description">You currently have no notifications.</p>
        </div>
    {% endif %}
</div>
{% endblock %}
