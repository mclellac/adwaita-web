{% extends "base.html" %}

{% block title %}Settings - {{ super() }}{% endblock %}

{% block content %}
<div class="adw-preferences-view" style="max-width: 700px; margin: var(--spacing-xl) auto;">
  <div class="adw-preferences-page">
    <header class="adw-preferences-page__header">
      <h1 class="adw-preferences-page__title">Settings</h1>
    </header>

    <div class="adw-preferences-group" role="group" aria-labelledby="appearance-settings-title">
      <div class="adw-preferences-group__title-container">
        <h3 class="adw-preferences-group__title" id="appearance-settings-title">Appearance</h3>
      </div>

      {# Theme Combo Row #}
      <div class="adw-combo-row">
        <div class="adw-combo-row-text-content">
          <label for="theme-select" class="adw-combo-row-title">Theme</label>
          <span class="adw-combo-row-subtitle">Select your preferred interface theme</span>
        </div>
        <select id="theme-select" name="theme" class="adw-combo-row-select">
          {% set current_theme = current_user.theme or 'system' %}
          <option value="system" {% if current_theme == 'system' %}selected{% endif %}>System Default</option>
          <option value="light" {% if current_theme == 'light' %}selected{% endif %}>Light</option>
          <option value="dark" {% if current_theme == 'dark' %}selected{% endif %}>Dark</option>
        </select>
      </div>

      {# Accent Color Combo Row #}
      <div class="adw-combo-row">
        <div class="adw-combo-row-text-content">
          <label for="accent-color-select" class="adw-combo-row-title">Accent Color</label>
          <span class="adw-combo-row-subtitle">Choose a site-wide accent color</span>
        </div>
        <select id="accent-color-select" name="accent_color" class="adw-combo-row-select">
          {% set current_accent = current_user.accent_color or 'default' %}
          <option value="default" {% if current_accent == 'default' %}selected{% endif %}>Default (Blue)</option>
          <option value="green" {% if current_accent == 'green' %}selected{% endif %}>Green</option>
          <option value="orange" {% if current_accent == 'orange' %}selected{% endif %}>Orange</option>
          <option value="purple" {% if current_accent == 'purple' %}selected{% endif %}>Purple</option>
          <option value="red" {% if current_accent == 'red' %}selected{% endif %}>Red</option>
          <option value="yellow" {% if current_accent == 'yellow' %}selected{% endif %}>Yellow</option>
          <option value="pink" {% if current_accent == 'pink' %}selected{% endif %}>Pink</option>
        </select>
      </div>
    </div>

    <div class="adw-preferences-group" role="group" aria-labelledby="account-settings-title">
      <div class="adw-preferences-group__title-container">
        <h3 class="adw-preferences-group__title" id="account-settings-title">Account</h3>
      </div>
      <div class="adw-list-box">
        <a href="{{ url_for('change_password_page') }}" class="adw-action-row activatable">
          <div class="adw-action-row__text">
            <span class="adw-action-row__title">Change Password</span>
            <span class="adw-action-row__subtitle">Update your account password</span>
          </div>
          <span class="adw-action-row__chevron"></span>
        </a>
        <a href="{{ url_for('logout') }}" class="adw-action-row activatable destructive-action">
          <div class="adw-action-row__text">
            <span class="adw-action-row__title">Logout</span>
            <span class="adw-action-row__subtitle">Sign out of your account</span>
          </div>
          <span class="adw-action-row__chevron"></span>
        </a>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Removed link to non-existent settings.js.
   The theme selection is handled by base.html script.
   Accent color selection would require new JS to post to API and update CSS vars/body class.
#}
<script>
// Minimal JS to handle theme/accent changes via API if desired in the future.
// For now, these selects don't automatically apply changes without a form submission or dedicated JS.
document.addEventListener('DOMContentLoaded', function() {
    const themeSelect = document.getElementById('theme-select');
    const accentSelect = document.getElementById('accent-color-select');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (themeSelect) {
        themeSelect.addEventListener('change', function() {
            const newTheme = this.value;
            console.log('Theme changed to:', newTheme);
            // Example API call (currently only base.html handles initial load)
            if (csrfToken) {
                fetch("{{ url_for('save_theme_preference') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ theme: newTheme })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Theme save response:', data);
                    if (data.status === 'success') {
                        // Update body class for immediate effect
                        document.documentElement.classList.remove('theme-dark', 'theme-light'); // Clear existing
                        if (newTheme === 'dark') {
                            document.documentElement.classList.add('theme-dark');
                        } else if (newTheme === 'light') {
                            // document.documentElement.classList.add('theme-light'); // Assuming default is light
                        }
                        // Optionally show a toast or confirmation
                    }
                })
                .catch(error => console.error('Error saving theme:', error));
            }
        });
    }

    if (accentSelect) {
        accentSelect.addEventListener('change', function() {
            const newAccent = this.value;
            console.log('Accent color changed to:', newAccent);
            if (csrfToken) {
                fetch("{{ url_for('save_accent_color_preference') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ accent_color: newAccent })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Accent save response:', data);
                    // TODO: Add JS to dynamically update accent color CSS variables on :root or body
                    // This part is more complex as it depends on how adwaita-skin.css exposes accent variables.
                })
                .catch(error => console.error('Error saving accent color:', error));
            }
        });
    }
});
</script>
{% endblock %}
