{% extends "base.html" %}

{% block title %}Settings - {{ super() }}{% endblock %}

{% block content %}
<adw-preferences-page>
    <adw-preferences-group title="Appearance">
        <adw-action-row title="Accent Color" subtitle="Select your preferred accent color">
        </adw-action-row>
        <div id="accent-color-selector-container" class="settings-control-container accent-color-selector">
            <!-- Accent color buttons will be populated here by JavaScript -->
            <small>Loading accent colors...</small>
        </div>
    </adw-preferences-group>

    <adw-preferences-group title="Theme">
        <adw-action-row title="Dark Mode" subtitle="Toggle between light and dark themes">
        </adw-action-row>
        <div id="theme-switch-container" class="settings-control-container">
            <!-- Adwaita switch will be populated here -->
        </div>
    </adw-preferences-group>

    <adw-preferences-group title="Test Pages">
        <adw-action-row title="Test Widget Page" clickable href="{{ url_for('test_widget_page') }}"></adw-action-row>
        <adw-action-row title="Test New Widgets Page" clickable href="{{ url_for('test_new_widgets_page') }}"></adw-action-row>
    </adw-preferences-group>
</adw-preferences-page>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const accentContainer = document.getElementById('accent-color-selector-container');
        const themeSwitchContainer = document.getElementById('theme-switch-container');

        function renderAccentColorButtons() {
            if (!accentContainer) return;

            try {
                const colors = Adw.getAccentColors();
                // Use Adw.DEFAULT_ACCENT_COLOR which was exposed in js/components.js
                let currentAccent = localStorage.getItem('accentColor') || Adw.DEFAULT_ACCENT_COLOR || 'blue';

                if (!colors || colors.length === 0) {
                    accentContainer.innerHTML = '<small>No accent colors available.</small>';
                    return;
                }

                accentContainer.innerHTML = ''; // Clear previous buttons

                const isLightTheme = !document.body.classList.contains('dark-theme');
                const themeSuffix = isLightTheme ? '-light' : '-dark';

                colors.forEach(color => {
                    const button = document.createElement('button');
                    button.classList.add('adw-button');
                    // Use theme-specific variables for button's own display
                    button.style.backgroundColor = `var(--accent-${color}${themeSuffix}-bg, var(--adw-${color}-3))`; // Fallback to a base shade
                    button.style.color = `var(--accent-${color}${themeSuffix}-fg, #ffffff)`; // Fallback color

                    button.style.minWidth = '80px';
                    button.style.padding = 'var(--spacing-xs) var(--spacing-s)';
                    button.style.border = '2px solid transparent'; // Make border thicker for selection indication
                    button.style.borderRadius = 'var(--border-radius-default)';
                    button.textContent = color.charAt(0).toUpperCase() + color.slice(1);

                    if (color === currentAccent) {
                        // Highlight the selected button using the *current global* accent color for its border
                        button.style.borderColor = 'var(--accent-color)';
                        button.classList.add('suggested-action'); // Optional: make it more prominent
                    }

                    button.addEventListener('click', () => {
                        Adw.setAccentColor(color); // This will update --accent-color
                        currentAccent = color; // Update local currentAccent
                        // Re-render to update all button styles (especially the border of the selected one)
                        renderAccentColorButtons();
                    });
                    accentContainer.appendChild(button);
                });
            } catch (e) {
                accentContainer.innerHTML = '<small>Error loading accent colors.</small>';
                console.error("Error setting up accent colors:", e);
            }
        }

        // Initial setup for accent colors
        renderAccentColorButtons();

        // Theme Switch Setup
        if (themeSwitchContainer) {
            try {
                const isCurrentlyLight = document.body.classList.contains('light-theme');
                const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                // Initial state: if light-theme is set, it's light. If not, and system prefers dark, it's dark. Otherwise, default to light.
                // Adw.js loadSaveTheme handles the initial body class, so we can check that.
                const initialSwitchStateIsDark = !document.body.classList.contains('light-theme');


                const themeSwitch = Adw.createSwitch({
                    checked: initialSwitchStateIsDark, // true if dark mode is active
                    onChanged: () => {
                        Adw.toggleTheme(); // This will trigger the 'adwThemeChanged' event
                        // The event listener below will handle re-rendering accent buttons.
                    }
                });
                themeSwitchContainer.innerHTML = ''; // Clear placeholder
                themeSwitchContainer.appendChild(themeSwitch);

            } catch (e) {
                themeSwitchContainer.innerHTML = '<small>Error creating theme switch.</small>';
                console.error("Error setting up theme switch:", e);
            }
        }

        // Listen for theme changes to re-render accent color buttons
        document.addEventListener('adwThemeChanged', (event) => {
            renderAccentColorButtons();
            // Update theme switch state if needed (though Adw.toggleTheme might already handle its visual state if it re-reads body class)
            if (themeSwitchContainer && themeSwitchContainer.querySelector('input[type="checkbox"]')) {
                 themeSwitchContainer.querySelector('input[type="checkbox"]').checked = !event.detail.isLight;
            }
        });
    });
</script>
{% endblock %}
