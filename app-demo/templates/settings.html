{% extends "base.html" %}

{% block title %}Settings - {{ super() }}{% endblock %}

{% block content %}
<adw-preferences-page>
    <adw-preferences-group title="Appearance">
        <adw-expander-row title="Accent Color" subtitle="Select your preferred accent color">
            <div id="accent-color-selector-container" class="settings-control-container accent-color-selector" style="padding-left: 0;">
                <small>Loading accent colors...</small>
            </div>
        </adw-expander-row>
    </adw-preferences-group>

    <adw-preferences-group title="Theme">
        <adw-expander-row title="Dark Mode" subtitle="Toggle between light and dark themes">
            <div id="theme-switch-container" class="settings-control-container" style="padding-left: 0;">
            </div>
        </adw-expander-row>
    </adw-preferences-group>

    <adw-preferences-group title="Test Pages">
        <adw-action-row title="Test Widget Page" clickable href="{{ url_for('test_widget_page') }}"></adw-action-row>
        <adw-action-row title="Test New Widgets Page" clickable href="{{ url_for('test_new_widgets_page') }}"></adw-action-row>
    </adw-preferences-group>
</adw-preferences-page>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const accentContainer = document.getElementById('accent-color-selector-container');
        const themeSwitchContainer = document.getElementById('theme-switch-container');

        function renderAccentColorButtons() {
            if (!accentContainer) return;

            try {
                const colors = Adw.getAccentColors();
                let currentAccent = localStorage.getItem('accentColor') || Adw.DEFAULT_ACCENT_COLOR || 'blue';

                if (!colors || colors.length === 0) {
                    accentContainer.innerHTML = '<small>No accent colors available.</small>';
                    return;
                }

                accentContainer.innerHTML = '';

                const isLightTheme = document.body.classList.contains('light-theme');
                const themeSuffix = isLightTheme ? '-light' : '-dark';

                colors.forEach(color => {
                    const button = document.createElement('button');
                    button.classList.add('adw-button');
                    button.style.backgroundColor = `var(--accent-${color}${themeSuffix}-bg, var(--adw-${color}-3))`;
                    button.style.color = `var(--accent-${color}${themeSuffix}-fg, #ffffff)`;

                    button.style.minWidth = '80px';
                    button.style.padding = 'var(--spacing-xs) var(--spacing-s)';
                    button.style.border = '2px solid transparent';
                    button.style.borderRadius = 'var(--border-radius-default)';
                    button.textContent = color.charAt(0).toUpperCase() + color.slice(1);

                    if (color === currentAccent) {
                        button.style.borderColor = 'var(--accent-color)';
                        button.classList.add('suggested-action');
                    }

                    button.addEventListener('click', () => {
                        Adw.setAccentColor(color);
                        currentAccent = color;
                        renderAccentColorButtons();
                    });
                    accentContainer.appendChild(button);
                });
            } catch (e) {
                accentContainer.innerHTML = '<small>Error loading accent colors.</small>';
                console.error("Error setting up accent colors:", e);
            }
        }

        renderAccentColorButtons();

        if (themeSwitchContainer) {
            try {
                const isCurrentlyLight = document.body.classList.contains('light-theme');
                const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                // Adw.js loadSaveTheme handles the initial body class, so we can check that.
                const initialSwitchStateIsDark = !document.body.classList.contains('light-theme');


                const themeSwitch = Adw.createSwitch({
                    checked: initialSwitchStateIsDark,
                    onChanged: () => {
                        Adw.toggleTheme();
                    }
                });
                themeSwitchContainer.innerHTML = '';
                themeSwitchContainer.appendChild(themeSwitch);

            } catch (e) {
                themeSwitchContainer.innerHTML = '<small>Error creating theme switch.</small>';
                console.error("Error setting up theme switch:", e);
            }
        }

        document.addEventListener('adwThemeChanged', (event) => {
            renderAccentColorButtons();
            if (themeSwitchContainer && themeSwitchContainer.querySelector('input[type="checkbox"]')) {
                 themeSwitchContainer.querySelector('input[type="checkbox"]').checked = !event.detail.isLight;
            }
        });
    });
</script>
{% endblock %}
