{% extends "base.html" %}

{% block title %}Settings - {{ super() }}{% endblock %}

{% block headerbar %}
<adw-header-bar>
    <adw-window-title slot="title" title="Settings"></adw-window-title>
    <adw-button slot="start" icon-name="go-previous-symbolic" href="{{ url_for('index') }}" aria-label="Back to Home"></adw-button>
</adw-header-bar>
{% endblock %}

{% block content %}
<adw-preferences-view>
    <adw-preferences-page title="Settings">

        <adw-preferences-group title="Appearance">
            <adw-combo-row id="theme-combo-row" title="Theme" subtitle="Select your preferred interface theme">
                <select slot="suffix" name="theme">
                    {% set current_theme = current_user.theme or 'system' %}
                    <option value="system" {% if current_theme == 'system' %}selected{% endif %}>System Default</option>
                    <option value="light" {% if current_theme == 'light' %}selected{% endif %}>Light</option>
                    <option value="dark" {% if current_theme == 'dark' %}selected{% endif %}>Dark</option>
                </select>
            </adw-combo-row>

            <adw-combo-row id="accent-color-combo-row" title="Accent Color" subtitle="Choose a site-wide accent color">
                <select slot="suffix" name="accent_color">
                    {% set current_accent = current_user.accent_color or 'default' %}
                    {# These values should align with what Adw.setAccentColor() expects #}
                    <option value="default" {% if current_accent == 'default' %}selected{% endif %}>Default (Blue)</option>
                    <option value="green" {% if current_accent == 'green' %}selected{% endif %}>Green</option>
                    <option value="orange" {% if current_accent == 'orange' %}selected{% endif %}>Orange</option>
                    <option value="purple" {% if current_accent == 'purple' %}selected{% endif %}>Purple</option>
                    <option value="red" {% if current_accent == 'red' %}selected{% endif %}>Red</option>
                    <option value="yellow" {% if current_accent == 'yellow' %}selected{% endif %}>Yellow</option>
                    <option value="pink" {% if current_accent == 'pink' %}selected{% endif %}>Pink</option>
                </select>
            </adw-combo-row>
        </adw-preferences-group>

        <adw-preferences-group title="Account">
            <adw-action-row title="Change Password" subtitle="Update your account password" href="{{ url_for('change_password_page') }}" activatable></adw-action-row>
            <adw-action-row title="Logout" subtitle="Sign out of your account" href="{{ url_for('logout') }}" activatable class="destructive-action"></adw-action-row>
        </adw-preferences-group>

    </adw-preferences-page>
</adw-preferences-view>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const themeComboRow = document.getElementById('theme-combo-row');
    const accentComboRow = document.getElementById('accent-color-combo-row');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (themeComboRow) {
        const themeSelect = themeComboRow.querySelector('select');
        themeSelect.addEventListener('change', function() {
            const newTheme = this.value;
            console.log('Theme changed to:', newTheme);
            if (Adw && typeof Adw.setTheme === 'function') {
                Adw.setTheme(newTheme); // This should handle localStorage and class updates
            }

            if (csrfToken) {
                fetch("{{ url_for('save_theme_preference') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ theme: newTheme })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Theme save response:', data);
                    if (data.message) Adw.createToast(data.message, { type: data.status });
                })
                .catch(error => {
                    console.error('Error saving theme:', error);
                    Adw.createToast('Error saving theme preference.', { type: 'error' });
                });
            }
        });
    }

    if (accentComboRow) {
        const accentSelect = accentComboRow.querySelector('select');
        accentSelect.addEventListener('change', function() {
            const newAccent = this.value;
            console.log('Accent color changed to:', newAccent);
            if (Adw && typeof Adw.setAccentColor === 'function') {
                Adw.setAccentColor(newAccent); // This should handle localStorage and class updates
            }

            if (csrfToken) {
                fetch("{{ url_for('save_accent_color_preference') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ accent_color: newAccent })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Accent save response:', data);
                     if (data.message) Adw.createToast(data.message, { type: data.status });
                })
                .catch(error => {
                    console.error('Error saving accent color:', error);
                    Adw.createToast('Error saving accent color preference.', { type: 'error' });
                });
            }
        });
    }
});
</script>
{% endblock %}
