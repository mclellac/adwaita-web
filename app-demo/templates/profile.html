{% extends "base.html" %}

{% block title %}Profile: {{ user_profile.full_name or user_profile.username }}{% endblock %}

{% block header_title %}{{ user_profile.full_name or user_profile.username }}'s Profile{% endblock %}

{% block header_actions_start %}
    {% if current_user == user_profile %}
        <a href="{{ url_for('profile.edit_profile') }}" class="adw-button suggested-action">Edit Profile</a>
    {% elif current_user.is_authenticated %} {# Only show follow/unfollow if logged in and not viewing own profile #}
        {% if current_user.is_following(user_profile) %}
            <form action="{{ url_for('profile.unfollow_user', user_id=user_profile.id) }}" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="adw-button">Unfollow</button>
            </form>
        {% else %}
            <form action="{{ url_for('profile.follow_user', user_id=user_profile.id) }}" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="adw-button suggested-action">Follow</button>
            </form>
        {% endif %}
    {% endif %}
{% endblock %}

{% block content %}

{# Dialog for Full-Size Profile Photo #}
<adw-dialog id="profile-photo-dialog" title="Profile Photo">
    <div slot="content" class="dialog-image-content" style="text-align: center; padding: var(--spacing-m);">
        <img id="full-profile-photo-img" src="" alt="Full-size profile photo" style="max-width: 100%; max-height: 80vh; display: block; margin: auto;">
    </div>
    {# No explicit buttons needed, header close button is sufficient #}
</adw-dialog>

{# Dialog for Full-Size Gallery Photo #}
<adw-dialog id="gallery-photo-dialog" title="Gallery Photo">
    <div slot="content" class="dialog-image-content" style="text-align: center; padding: var(--spacing-m); position: relative;"> {# Added position: relative for nav buttons #}
        {# Loading Spinner for Image #}
        <div id="gallery-image-loader" class="adw-spinner large" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;"></div>

        <img id="full-gallery-photo-img" src="" alt="Full-size gallery photo" style="max-width: 100%; max-height: 70vh; display: block; margin: auto; opacity: 1;"> {# Reduced max-height for comment space #}

        {# Navigation Buttons #}
        <button id="gallery-nav-prev" class="adw-button circular flat gallery-nav-button prev" aria-label="Previous photo" style="display:none;">
            <span class="adw-icon icon-actions-go-previous-symbolic"></span>
        </button>
        <button id="gallery-nav-next" class="adw-button circular flat gallery-nav-button next" aria-label="Next photo" style="display:none;">
            <span class="adw-icon icon-actions-go-next-symbolic"></span>
        </button>

        <p id="full-gallery-photo-caption" class="adw-label body-1" style="margin-top: var(--spacing-s); margin-bottom: var(--spacing-m);"></p>

        <hr style="margin: var(--spacing-m) 0;">

        <div class="photo-comments-area" style="max-height: 30vh; overflow-y: auto; text-align: left; margin-bottom: var(--spacing-m);">
            <h3 class="adw-title-4" style="margin-bottom: var(--spacing-s);">Comments</h3>
            <div id="gallery-photo-comments-list" class="adw-list-box flat compact">
                {# Comments will be loaded here by JS #}
                <div class="adw-action-row placeholder-comment" style="display: none;">
                     <span class="adw-action-row-subtitle">No comments yet, or loading...</span>
                </div>
            </div>
        </div>

        {% if current_user.is_authenticated %}
        <form id="new-gallery-comment-form" class="stacked-form" style="text-align: left;">
            <input type="hidden" id="gallery-comment-photo-id" name="photo_id" value="">
            <div class="adw-action-row column-layout">
                 <label for="gallery-comment-text" class="adw-action-row-title" style="margin-bottom: var(--spacing-xs);">Your Comment</label>
                <textarea id="gallery-comment-text" name="text" class="adw-entry" rows="2" placeholder="Write a comment..." required style="width: 100%; min-height: 60px; box-sizing: border-box;"></textarea>
                <div id="gallery-comment-error" class="error-text adw-label caption" style="display:none; margin-top: var(--spacing-xs);"></div>
            </div>
            <div class="form-actions-end" style="margin-top: var(--spacing-s);">
                <button type="submit" class="adw-button suggested-action">Post Comment</button>
            </div>
        </form>
        {% else %}
        <p class="adw-label body-1"><a href="{{ url_for('auth.login', next=request.url) }}" class="adw-link">Login</a> to comment.</p>
        {% endif %}
    </div>
</adw-dialog>

<div class="adw-clamp adw-clamp-xl">
    <div class="adw-box adw-box-vertical adw-box-spacing-l profile-page-main-box">

        {# User Header Info #}
        <div class="adw-box adw-box-spacing-xl align-center"> {# Horizontal by default #}
            <div class="adw-avatar size-huge" id="profile-page-avatar-container" style="cursor: pointer;" title="View full-size photo"> {# size-huge for 96px, added ID and style #}
                {% if user_profile.profile_photo_url %}
                <img id="profile-page-avatar-img" src="{{ url_for('static', filename=user_profile.profile_photo_url) }}" alt="{{ user_profile.full_name or user_profile.username }} avatar">
                {% else %}
                <img id="profile-page-avatar-img" src="{{ default_avatar_url }}" alt="{{ user_profile.full_name or user_profile.username }} default avatar">
                {% endif %}
            </div>
            <div class="adw-box adw-box-vertical adw-box-spacing-xs">
                <h1 class="adw-label title-1">{{ user_profile.full_name }}</h1>
                {% if user_profile.full_name %}
                <div><span class="adw-label adw-caption">@{{ user_profile.full_name }}</span></div>
                {% endif %}
                <div class="adw-box adw-box-horizontal adw-box-spacing-s profile-follow-stats">
                    <a href="{{ url_for('profile.followers_list', user_id=user_profile.id) }}" class="adw-link">
                        <span class="adw-label body-2"><strong>{{ user_profile.followers.count() }}</strong> Followers</span>
                    </a>
                    <a href="{{ url_for('profile.following_list', user_id=user_profile.id) }}" class="adw-link">
                        <span class="adw-label body-2"><strong>{{ user_profile.followed.count() }}</strong> Following</span>
                    </a>
                </div>
            </div>
        </div>

        {# Profile Details Group #}
        <div class="adw-preferences-group" role="group" aria-labelledby="profile-details-title-{{user_profile.id}}">
             <div class="adw-preferences-group__title-container">
                <h2 class="adw-preferences-group__title title-2" id="profile-details-title-{{user_profile.id}}">About {{user_profile.full_name or user_profile.username}}</h2>
            </div>
            <div class="adw-list-box">
                {% if user_profile.profile_info %}
                <div class="adw-expander-row profile-bio-expander"> {# Use div structure, add custom class for JS hook if needed #}
                    <div class="adw-action-row activatable" role="button" tabindex="0" aria-expanded="false" aria-controls="profile-bio-content-{{user_profile.id}}">
                        <span class="adw-action-row-text-content">
                            <span class="adw-action-row-title">Biography</span>
                            {# Subtitle can be removed or changed, e.g., to show a preview if desired later #}
                        </span>
                        <span class="adw-expander-row-icon"></span> {# Standard chevron element #}
                    </div>
                    <div class="adw-expander-row-content" id="profile-bio-content-{{user_profile.id}}" style="padding: var(--spacing-s) var(--spacing-m);">
                        <div class="styled-text-content"> {# Wrap bio in styled-text-content for prose styling #}
                             {{ user_profile.profile_info | safe }}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Biography</span>
                    <span class="adw-action-row__subtitle">No bio provided.</span>
                </div>
                {% endif %}

                {% if calculated_age is not none %} {# Use calculated_age passed from route #}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Age</span>
                    <span class="adw-action-row__subtitle">{{ calculated_age }}</span>
                </div>
                {% endif %}

                {# Detailed Address Fields #}
                {% if user_profile.street_address %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Street Address</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.street_address }}</span>
                </div>
                {% endif %}
                {% if user_profile.city %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">City</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.city }}</span>
                </div>
                {% endif %}
                {% if user_profile.state_province %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">State/Province</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.state_province }}</span>
                </div>
                {% endif %}
                {% if user_profile.postal_code %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Postal/Zip Code</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.postal_code }}</span>
                </div>
                {% endif %}
                {% if user_profile.country %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Country</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.country }}</span>
                </div>
                {% endif %}

                {# Detailed Phone Fields #}
                {% if user_profile.home_phone %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Home Phone</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.home_phone }}</span>
                </div>
                {% endif %}
                {% if user_profile.mobile_phone %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Mobile Phone</span>
                    <span class="adw-action-row__subtitle">{{ user_profile.mobile_phone }}</span>
                </div>
                {% endif %}

                {% if user_profile.website_url %}
                    {% if user_profile.website_url.startswith('http://') or user_profile.website_url.startswith('https://') %}
                    <a href="{{ user_profile.website_url }}" target="_blank" class="adw-action-row activatable">
                        <span class="adw-action-row__title">Website</span>
                        <span class="adw-action-row__subtitle">{{ user_profile.website_url }}</span>
                        <span class="adw-action-row__chevron"></span>
                    </a>
                    {% else %}
                    <div class="adw-action-row">
                        <span class="adw-action-row__title">Website</span>
                        <span class="adw-action-row__subtitle">{{ user_profile.website_url }} (Not a valid link)</span>
                    </div>
                    {% endif %}
                {% endif %}

                {% if current_user == user_profile %}
                <div class="adw-action-row">
                    <span class="adw-action-row__title">Profile Privacy</span>
                    <span class="adw-action-row__subtitle">{{ 'Public' if user_profile.is_profile_public else 'Private (Only you can see full details)' }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        {# User Posts Section #}
        <div class="adw-preferences-group" role="group" aria-labelledby="user-posts-title-{{user_profile.id}}">
            <div class="adw-preferences-group__title-container">
                <h2 class="adw-preferences-group__title title-2" id="user-posts-title-{{user_profile.id}}">Posts by {{ user_profile.full_name or user_profile.username }}</h2>
            </div>
            {% if posts_pagination and posts_pagination.items %}
                <div class="blog-posts-container"> {# Use new card container #}
                    {% for post in posts_pagination.items %}
                    <article class="adw-card blog-post-item-card">
                        <header class="blog-post-card__header">
                            {# Post title removed, content will be linked in footer or by making card clickable if desired #}
                            <div class="blog-post-card__meta adw-label caption">
                                {%- if post.published_at -%}
                                    Published: <time datetime="{{ post.published_at.isoformat() }}">{{ post.published_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>
                                {%- else -%} {# Should ideally not happen for new posts, but fallback for old data #}
                                    Created: <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>
                                {%- endif -%}
                            </div>
                        </header>
                        {# No excerpt shown on profile post list for brevity, or could add a short one #}
                        <footer class="blog-post-card__footer">
                             <div class="blog-post-card__terms">
                                {# Terms (categories/tags) could be added here if desired #}
                            </div>
                            <a href="{{ url_for('post.view_post', post_id=post.id) }}" class="adw-button flat read-more-link">View Post <span class="adw-icon icon-actions-go-next-symbolic"></span></a>
                        </footer>
                        <div class="adw-card__actions card-secondary-actions">
                            {% from "_macros.html" import like_button_and_count %}
                            {{ like_button_and_count(post, current_user, csrf_token()) }}
                        </div>
                    </article>
                    {% endfor %}
                </div>

                {# Pagination Controls - Using Adwaita ToggleGroup for a more native feel #}
                {% if posts_pagination.pages > 1 %}
                <div class="adw-box adw-box-horizontal justify-center profile-pagination-box">
                    <div class="adw-toggle-group">
                        {% if posts_pagination.has_prev %}
                            <a href="{{ url_for('profile.view_profile', user_id=user_profile.id, page=posts_pagination.prev_num) }}" class="adw-button icon-only" aria-label="Previous page">
                                <span class="adw-icon icon-actions-go-previous-symbolic"></span>
                            </a>
                        {% else %}
                            <button class="adw-button icon-only" disabled aria-label="Previous page">
                                <span class="adw-icon icon-actions-go-previous-symbolic"></span>
                            </button>
                        {% endif %}

                        {% for page_num in posts_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num == posts_pagination.page %}
                                    <button class="adw-button suggested" disabled aria-current="page">{{ page_num }}</button>
                                {% else %}
                                    <a href="{{ url_for('profile.view_profile', user_id=user_profile.id, page=page_num) }}" class="adw-button">{{ page_num }}</a>
                                {% endif %}
                            {% elif loop.index != 1 and loop.index != posts_pagination.pages + posts_pagination.iter_pages()|length %}
                                <button class="adw-button flat" disabled>…</button>
                            {% endif %}
                        {% endfor %}

                        {% if posts_pagination.has_next %}
                             <a href="{{ url_for('profile.view_profile', user_id=user_profile.id, page=posts_pagination.next_num) }}" class="adw-button icon-only" aria-label="Next page">
                                <span class="adw-icon icon-actions-go-next-symbolic"></span>
                            </a>
                        {% else %}
                            <button class="adw-button icon-only" disabled aria-label="Next page">
                                <span class="adw-icon icon-actions-go-next-symbolic"></span>
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="adw-status-page">
                    <span class="adw-icon icon-content-document-new-symbolic adw-status-page-icon app-status-page-icon"></span>
                    <h3 class="adw-status-page-title">No Posts Yet</h3>
                    <p class="adw-status-page-description">{{ user_profile.full_name or user_profile.username }} has not made any posts.</p>
                </div>
            {% endif %}
        </div>

        {# User Comments Section #}
        <div class="adw-preferences-group" role="group" aria-labelledby="user-comments-title-{{user_profile.id}}">
            <div class="adw-preferences-group__title-container">
                <h2 class="adw-preferences-group__title title-2" id="user-comments-title-{{user_profile.id}}">Comments by {{ user_profile.full_name or user_profile.username }}</h2>
            </div>
            {% if comments_pagination and comments_pagination.items %}
                <div class="adw-list-box">
                    {% for comment in comments_pagination.items %}
                    <a href="{{ url_for('post.view_post', post_id=comment.post_id, _anchor='comment-' ~ comment.id) }}" class="adw-action-row activatable">
                        <div class="adw-action-row__text">
                            <span class="adw-action-row__title">Comment on post by {{ comment.post.author.full_name or comment.post.author.username }}</span>
                            <span class="adw-action-row__subtitle">"{{ comment.text | truncate(100, True) }}"</span>
                            <small class="adw-label caption">
                                <time datetime="{{ comment.created_at.isoformat() }}">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>
                            </small>
                        </div>
                        <span class="adw-action-row__chevron"></span>
                    </a>
                    {% endfor %}
                </div>

                {# Pagination Controls for Comments #}
                {% if comments_pagination.pages > 1 %}
                <div class="adw-box adw-box-horizontal justify-center profile-pagination-box">
                    <div class="adw-toggle-group">
                        {% if comments_pagination.has_prev %}
                            <a href="{{ url_for('profile.view_profile', user_id=user_profile.id, comments_page=comments_pagination.prev_num) }}" class="adw-button icon-only" aria-label="Previous comments page">
                                <span class="adw-icon icon-actions-go-previous-symbolic"></span>
                            </a>
                        {% else %}
                            <button class="adw-button icon-only" disabled aria-label="Previous comments page">
                                <span class="adw-icon icon-actions-go-previous-symbolic"></span>
                            </button>
                        {% endif %}

                        {% for page_num in comments_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num == comments_pagination.page %}
                                    <button class="adw-button suggested" disabled aria-current="page">{{ page_num }}</button>
                                {% else %}
                                    <a href="{{ url_for('profile.view_profile', user_id=user_profile.id, comments_page=page_num) }}" class="adw-button">{{ page_num }}</a>
                                {% endif %}
                            {% elif loop.index != 1 and loop.index != comments_pagination.pages + comments_pagination.iter_pages()|length %}
                                <button class="adw-button flat" disabled>…</button>
                            {% endif %}
                        {% endfor %}

                        {% if comments_pagination.has_next %}
                             <a href="{{ url_for('profile.view_profile', user_id=user_profile.id, comments_page=comments_pagination.next_num) }}" class="adw-button icon-only" aria-label="Next comments page">
                                <span class="adw-icon icon-actions-go-next-symbolic"></span>
                            </a>
                        {% else %}
                            <button class="adw-button icon-only" disabled aria-label="Next comments page">
                                <span class="adw-icon icon-actions-go-next-symbolic"></span>
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="adw-status-page">
                    <span class="adw-icon icon-content-message-symbolic adw-status-page-icon app-status-page-icon"></span>
                    <h3 class="adw-status-page-title">No Comments Yet</h3>
                    <p class="adw-status-page-description">{{ user_profile.full_name or user_profile.username }} has not made any comments.</p>
                </div>
            {% endif %}
        </div>

        {# User Photo Gallery Section #}
        <div class="adw-preferences-group" role="group" aria-labelledby="user-gallery-title-{{user_profile.id}}">
            <div class="adw-preferences-group__title-container">
                <h2 class="adw-preferences-group__title title-2" id="user-gallery-title-{{user_profile.id}}">Photo Gallery</h2>
            </div>

            {% if current_user == user_profile %}
            <div class="adw-list-box profile-gallery-upload-box">
                <div class="adw-action-row">
                    <h3 class="adw-action-row__title">Upload New Photo to Gallery</h3>
                </div>
                <form method="POST" action="{{ url_for('profile.upload_gallery_photo') }}" enctype="multipart/form-data" class="gallery-upload-form">
                    {{ gallery_upload_form.hidden_tag() if gallery_upload_form else '' }} {# CSRF token #}
                    <div class="adw-entry-row {{ 'has-error' if gallery_upload_form and gallery_upload_form.photos.errors else '' }}">
                        <div class="adw-entry-row-text-content">
                            {# The label for the actual input is not strictly needed if it's visually hidden, but good for accessibility if it were ever shown #}
                            <label for="{{ gallery_upload_form.photos.id if gallery_upload_form else 'gallery_photos_input_actual' }}" class="adw-entry-row-title visually-hidden">{{ gallery_upload_form.photos.label.text if gallery_upload_form else 'Photo Files' }}</label>
                            <span class="adw-entry-row-title">{{ gallery_upload_form.photos.label.text if gallery_upload_form else 'Photo Files' }}</span> {# Display label text separately #}
                            {% if gallery_upload_form and gallery_upload_form.photos.errors %}<span class="adw-entry-row-subtitle error-text">{{ gallery_upload_form.photos.errors|join(' ') }}</span>{% endif %}
                        </div>
                        {# Visually hide the actual input but keep it for functionality. Ensure ID matches if label `for` is used. #}
                        {{ gallery_upload_form.photos(class="visually-hidden", multiple="multiple", id=(gallery_upload_form.photos.id if gallery_upload_form else 'gallery_photos_input_actual')) if gallery_upload_form }}
                        <button type="button" class="adw-button outlined" id="custom_gallery_photo_upload_button" aria-controls="{{ gallery_upload_form.photos.id if gallery_upload_form else 'gallery_photos_input_actual' }}">
                            <span class="adw-icon icon-actions-document-open-symbolic"></span> Choose Files...
                        </button>
                    </div>
                    <div id="gallery_selected_files_display" class="adw-list-box flat compact" style="margin: var(--spacing-xs) var(--spacing-m) var(--spacing-m) var(--spacing-m); display: none; max-height: 150px; overflow-y: auto;">
                        {# Selected file names will be populated here by JS #}
                    </div>
                    {# Caption Textarea - Revised Structure #}
                    <div class="form-field-container {{ 'has-error' if gallery_upload_form and gallery_upload_form.caption.errors else '' }}" style="padding: var(--spacing-s) var(--spacing-m) var(--spacing-m) var(--spacing-m);">
                        <label for="{{ gallery_upload_form.caption.id if gallery_upload_form else 'gallery_caption_input' }}" class="adw-label" style="display: block; margin-bottom: var(--spacing-xs);">{{ gallery_upload_form.caption.label.text if gallery_upload_form else 'Caption (for all photos)' }}</label>
                        {% if gallery_upload_form and gallery_upload_form.caption.errors %}
                            <p class="adw-label caption error-text" style="margin-bottom: var(--spacing-xs);">{{ gallery_upload_form.caption.errors|join(' ') }}</p>
                        {% endif %}
                        {{ gallery_upload_form.caption(class="adw-entry", rows="2", placeholder="Optional caption for all photos in this batch...", style="width: 100%; min-height: 60px; box-sizing: border-box;") if gallery_upload_form }}
                    </div>
                   <div class="form-actions-end" style="padding: 0 var(--spacing-m) var(--spacing-m) var(--spacing-m);">
                       {{ gallery_upload_form.submit(class="adw-button suggested-action", id="gallery_upload_submit_button") if gallery_upload_form }} {# Submit button label already changed in forms.py, added ID #}
                   </div>
                </form>
            </div>
            {% endif %}

            {% set gallery_photos_preview = user_profile.gallery_photos.order_by(UserPhoto.uploaded_at.desc()).limit(6).all() %}
            {% set total_gallery_photos = user_profile.gallery_photos.count() %}

            {% if gallery_photos_preview %}
                <div class="profile-gallery-grid">
                    {% for photo in gallery_photos_preview %}
                    <div class="adw-card gallery-photo-card">
                        <img src="{{ url_for('static', filename='uploads/gallery_pics/' + photo.image_filename) }}"
                             alt="{{ photo.caption or ('Gallery image by ' ~ (user_profile.full_name or user_profile.username)) }}"
                             class="gallery-photo-image clickable-gallery-photo"
                             data-fullsrc="{{ url_for('static', filename='uploads/gallery_pics/' + photo.image_filename) }}"
                             data-caption="{{ photo.caption or '' }}"
                              data-photoid="{{ photo.id }}" {# Added photo ID #}
                             style="cursor: pointer;"
                             title="View full-size photo">
                        {% if photo.caption %}
                        <div class="adw-card__content gallery-photo-caption">
                            <p class="adw-label body-2">{{ photo.caption }}</p>
                        </div>
                        {% endif %}
                        {% if current_user == user_profile or current_user.is_admin %}
                        <div class="adw-card__actions gallery-photo-actions">
                             <form method="POST" action="{{ url_for('profile.delete_gallery_photo', photo_id=photo.id) }}" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="adw-button destructive-action flat small" onclick="return confirm('Are you sure you want to delete this photo?');">
                                    <span class="adw-icon icon-actions-edit-delete-symbolic"></span> Delete
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% if total_gallery_photos > gallery_photos_preview|length %}
                <div class="adw-box justify-center" style="margin-top: var(--spacing-m);">
                    <a href="{{ url_for('profile.view_gallery', user_id=user_profile.id) }}" class="adw-button">
                        View All Photos ({{ total_gallery_photos }}) <span class="adw-icon icon-actions-go-next-symbolic"></span>
                    </a>
                </div>
                {% endif %}
            {% else %}
                <div class="adw-status-page">
                    <span class="adw-icon icon-media-image-symbolic adw-status-page-icon app-status-page-icon"></span>
                    <h3 class="adw-status-page-title">Empty Gallery</h3>
                    <p class="adw-status-page-description">{{ user_profile.full_name or user_profile.username }} has not uploaded any photos to their gallery yet.</p>
                    {% if current_user != user_profile %}
                    <p class="adw-status-page-description">Check back later!</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Full-size profile photo dialog logic
    const avatarContainer = document.getElementById('profile-page-avatar-container');
    const fullSizePhotoDialog = document.getElementById('profile-photo-dialog');
    const fullSizePhotoImg = document.getElementById('full-profile-photo-img');
    const profileAvatarImg = document.getElementById('profile-page-avatar-img');

    if (avatarContainer && fullSizePhotoDialog && fullSizePhotoImg && profileAvatarImg) {
        customElements.whenDefined('adw-dialog').then(() => {
            avatarContainer.addEventListener('click', () => {
                const photoUrl = profileAvatarImg.src; // Get the src from the visible avatar
                if (photoUrl) {
                    fullSizePhotoImg.src = photoUrl;
                    fullSizePhotoDialog.open();
                }
            });
        }).catch(error => {
            console.error("profile.html: Failed to initialize full-size photo dialog; adw-dialog definition not found.", error);
        });
    } else {
        if (!avatarContainer) console.warn("profile.html: Avatar container not found.");
        if (!fullSizePhotoDialog) console.warn("profile.html: Full-size photo dialog element not found.");
        if (!fullSizePhotoImg) console.warn("profile.html: Full-size photo img element not found.");
        if (!profileAvatarImg) console.warn("profile.html: Profile avatar img element not found.");
    }

    // Full-size gallery photo dialog logic
    const galleryPhotoDialog = document.getElementById('gallery-photo-dialog');
    const fullGalleryPhotoImg = document.getElementById('full-gallery-photo-img');
    const fullGalleryPhotoCaption = document.getElementById('full-gallery-photo-caption');
    const galleryPhotoCommentsList = document.getElementById('gallery-photo-comments-list');
    const newGalleryCommentForm = document.getElementById('new-gallery-comment-form');
    const galleryCommentText = document.getElementById('gallery-comment-text');
    const galleryCommentPhotoIdInput = document.getElementById('gallery-comment-photo-id');
    const galleryCommentError = document.getElementById('gallery-comment-error');
    const placeholderComment = galleryPhotoCommentsList ? galleryPhotoCommentsList.querySelector('.placeholder-comment') : null;
    const clickableGalleryPhotos = document.querySelectorAll('.clickable-gallery-photo'); // These are the thumbnails

    const galleryImageLoader = document.getElementById('gallery-image-loader');
    const galleryNavPrev = document.getElementById('gallery-nav-prev');
    const galleryNavNext = document.getElementById('gallery-nav-next');

    let allGalleryPhotoData = [];
    let currentGalleryPhotoIndex = -1;

    // Populate allGalleryPhotoData from the thumbnails on the page
    function collectGalleryPhotoData() {
        allGalleryPhotoData = Array.from(clickableGalleryPhotos).map((thumb, index) => ({
            index: index,
            src: thumb.dataset.fullsrc,
            caption: thumb.dataset.caption,
            id: thumb.dataset.photoid,
            thumbnailElement: thumb // Keep a reference if needed
        }));
    }
    collectGalleryPhotoData(); // Initial collection

    function showImageLoading(show) {
        if (galleryImageLoader) galleryImageLoader.style.display = show ? 'block' : 'none';
        if (fullGalleryPhotoImg) fullGalleryPhotoImg.classList.toggle('loading', show);
    }

    function updateGalleryDialogNavButtons() {
        if (!galleryNavPrev || !galleryNavNext) return;
        if (allGalleryPhotoData.length <= 1) {
            galleryNavPrev.style.display = 'none';
            galleryNavNext.style.display = 'none';
            return;
        }
        galleryNavPrev.style.display = (currentGalleryPhotoIndex > 0) ? 'block' : 'none';
        galleryNavNext.style.display = (currentGalleryPhotoIndex < allGalleryPhotoData.length - 1) ? 'block' : 'none';
    }

    async function loadPhotoInDialog(photoData) {
        if (!photoData || !fullGalleryPhotoImg || !galleryPhotoDialog.open) return;

        showImageLoading(true);

        // Preload image to wait for it to be ready
        const tempImg = new Image();
        tempImg.onload = () => {
            fullGalleryPhotoImg.src = photoData.src;
            fullGalleryPhotoImg.alt = photoData.caption || "Full-size gallery photo";
            if (fullGalleryPhotoCaption) fullGalleryPhotoCaption.textContent = photoData.caption || '';
            if (galleryCommentPhotoIdInput) galleryCommentPhotoIdInput.value = photoData.id;

            fetchGalleryComments(photoData.id); // Fetch comments for the new photo
            showImageLoading(false);
            updateGalleryDialogNavButtons();
        };
        tempImg.onerror = () => {
            console.error("Failed to load image:", photoData.src);
            if (fullGalleryPhotoCaption) fullGalleryPhotoCaption.textContent = "Error loading image.";
            // Optionally, display a placeholder or error image
            fullGalleryPhotoImg.src = ""; // Clear src or set to a placeholder
            showImageLoading(false);
            updateGalleryDialogNavButtons(); // Still update nav, maybe allow navigation away
        };
        tempImg.src = photoData.src;
    }

    function showNextGalleryPhoto() {
        if (currentGalleryPhotoIndex < allGalleryPhotoData.length - 1) {
            currentGalleryPhotoIndex++;
            loadPhotoInDialog(allGalleryPhotoData[currentGalleryPhotoIndex]);
        }
    }

    function showPrevGalleryPhoto() {
        if (currentGalleryPhotoIndex > 0) {
            currentGalleryPhotoIndex--;
            loadPhotoInDialog(allGalleryPhotoData[currentGalleryPhotoIndex]);
        }
    }

    if (galleryNavNext) galleryNavNext.addEventListener('click', showNextGalleryPhoto);
    if (galleryNavPrev) galleryNavPrev.addEventListener('click', showPrevGalleryPhoto);

    // Keyboard navigation for gallery dialog
    function handleGalleryKeydown(event) {
        if (!galleryPhotoDialog || !galleryPhotoDialog.isOpen()) return; // Check if dialog is open

        if (event.key === 'ArrowRight') {
            showNextGalleryPhoto();
        } else if (event.key === 'ArrowLeft') {
            showPrevGalleryPhoto();
        } else if (event.key === 'Escape') {
            galleryPhotoDialog.close(); // Close dialog on Escape
        }
    }


    // Helper function to format date (basic, can be improved)
    function formatCommentDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) + ' ' +
               date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function displayGalleryComments(comments) {
        galleryPhotoCommentsList.innerHTML = ''; // Clear existing
        if (!comments || comments.length === 0) {
            if(placeholderComment) {
                placeholderComment.style.display = ''; // Show placeholder
                placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'No comments yet.';
                galleryPhotoCommentsList.appendChild(placeholderComment);
            }
            return;
        }
        if(placeholderComment) placeholderComment.style.display = 'none';

        comments.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('adw-action-row'); // Use Adwaita styling for list items
            commentDiv.innerHTML = `
                <span class="adw-avatar size-small" style="margin-right: var(--spacing-s);">
                    <img src="${comment.author.profile_photo_url}" alt="${comment.author.full_name || comment.author.username} avatar">
                </span>
                <span class="adw-action-row-text-content">
                    <a href="${comment.author.profile_url}" class="adw-link adw-action-row-title">${comment.author.full_name || comment.author.username}</a>
                    <span class="adw-action-row-subtitle">${comment.text}</span>
                    <small class="adw-label caption">${formatCommentDate(comment.created_at)}</small>
                </span>
            `;
            galleryPhotoCommentsList.appendChild(commentDiv);
        });
    }

    async function fetchGalleryComments(photoId) {
        if(placeholderComment) {
            placeholderComment.style.display = '';
            placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Loading comments...';
            if (galleryPhotoCommentsList.childElementCount === 0) {
                 galleryPhotoCommentsList.appendChild(placeholderComment);
            }
        }
        try {
            const response = await fetch(`/photo/api/photos/${photoId}/comments`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const comments = await response.json();
            displayGalleryComments(comments);
        } catch (error) {
            console.error('Error fetching gallery comments:', error);
            if(placeholderComment) placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Could not load comments.';
        }
    }

    if (galleryPhotoDialog && fullGalleryPhotoImg && fullGalleryPhotoCaption && galleryPhotoCommentsList && clickableGalleryPhotos.length > 0) {
        customElements.whenDefined('adw-dialog').then(() => {
            clickableGalleryPhotos.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    // Find the index of the clicked thumbnail in our collected data
                    const clickedPhotoData = allGalleryPhotoData.find(p => p.thumbnailElement === thumb);
                    if (clickedPhotoData) {
                        currentGalleryPhotoIndex = clickedPhotoData.index;
                        loadPhotoInDialog(clickedPhotoData); // Load the clicked photo
                        galleryPhotoDialog.open(); // Open the dialog
                        document.addEventListener('keydown', handleGalleryKeydown); // Add keydown listener when dialog opens
                    } else {
                        console.error("Clicked photo data not found in collected list.");
                        // Fallback to original behavior if data not found (should not happen)
                        const photoUrl = thumb.dataset.fullsrc;
                        const caption = thumb.dataset.caption;
                        const photoId = thumb.dataset.photoid;
                        if (photoUrl && photoId) {
                            fullGalleryPhotoImg.src = photoUrl; // This would bypass loading indicator
                            if (fullGalleryPhotoCaption) fullGalleryPhotoCaption.textContent = caption || '';
                            if (galleryCommentPhotoIdInput) galleryCommentPhotoIdInput.value = photoId;
                            fetchGalleryComments(photoId);
                            galleryPhotoDialog.open();
                            document.addEventListener('keydown', handleGalleryKeydown);
                        }
                    }
                });
            });

            // Remove keydown listener when dialog closes
            if (galleryPhotoDialog) {
                galleryPhotoDialog.addEventListener('close', () => { // Assuming 'close' event is standard for <adw-dialog>
                    document.removeEventListener('keydown', handleGalleryKeydown);
                    // Hide nav buttons when dialog closes
                    if(galleryNavPrev) galleryNavPrev.style.display = 'none';
                    if(galleryNavNext) galleryNavNext.style.display = 'none';
                });
            }

        }).catch(error => {
            console.error("profile.html: Failed to initialize gallery photo dialog; adw-dialog definition not found.", error);
        });
    } else {
        // Warnings for missing elements
        if (!galleryPhotoDialog) console.warn("profile.html: Gallery photo dialog element not found.");
        // ... other warnings
    }

    if (newGalleryCommentForm && galleryCommentText && galleryCommentPhotoIdInput && galleryCommentError) {
        newGalleryCommentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const photoId = galleryCommentPhotoIdInput.value;
            const commentText = galleryCommentText.value.trim();
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');


            if (!commentText) {
                galleryCommentError.textContent = "Comment cannot be empty.";
                galleryCommentError.style.display = 'block';
                return;
            }
            galleryCommentError.style.display = 'none';

            try {
                const response = await fetch(`/photo/api/photos/${photoId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ text: commentText })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.errors ? JSON.stringify(errorData.errors) : `HTTP error! status: ${response.status}`);
                }

                // const newComment = await response.json(); // Not strictly needed if refetching
                galleryCommentText.value = ''; // Clear textarea
                fetchGalleryComments(photoId); // Refresh comments list
            } catch (error) {
                console.error('Error posting comment:', error);
                galleryCommentError.textContent = "Could not post comment: " + error.message;
                galleryCommentError.style.display = 'block';
            }
        });
    }


    // Script for profile bio expander
    const profileBioExpander = document.querySelector('.profile-bio-expander');
    if (profileBioExpander) {
        const header = profileBioExpander.querySelector('.adw-action-row.activatable');
        const content = profileBioExpander.querySelector('.adw-expander-row-content');
        const icon = profileBioExpander.querySelector('.adw-expander-row-icon');

        if (header && content && icon) {
            header.addEventListener('click', () => {
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                content.classList.toggle('expanded', !isExpanded);
                profileBioExpander.classList.toggle('expanded', !isExpanded); // For icon rotation
            });
        }
    }

    // Gallery Photo Upload Enhancement
    const galleryUploadForm = document.querySelector('form.gallery-upload-form');
    const customUploadButton = document.getElementById('custom_gallery_photo_upload_button');
    {# Determine the actual file input ID carefully based on how WTForms generates it or if gallery_upload_form is None #}
    {% if gallery_upload_form and gallery_upload_form.photos %}
    const actualFileInput = document.getElementById('{{ gallery_upload_form.photos.id }}');
    {% else %}
    const actualFileInput = document.getElementById('gallery_photos_input_actual'); // Fallback ID
    {% endif %}
    const selectedFilesDisplay = document.getElementById('gallery_selected_files_display');
    const gallerySubmitButton = document.getElementById('gallery_upload_submit_button');

    if (customUploadButton && actualFileInput && selectedFilesDisplay) {
        customUploadButton.addEventListener('click', () => {
            actualFileInput.click(); // Trigger click on the hidden file input
        });

        actualFileInput.addEventListener('change', () => {
            if (actualFileInput.files && actualFileInput.files.length > 0) {
                selectedFilesDisplay.innerHTML = ''; // Clear previous selections
                selectedFilesDisplay.style.display = 'block'; // Show the list box
                Array.from(actualFileInput.files).forEach(file => {
                    const fileRow = document.createElement('div');
                    fileRow.classList.add('adw-action-row');
                    fileRow.style.padding = 'var(--spacing-xxs) var(--spacing-xs)'; // Make it more compact

                    const fileNameSpan = document.createElement('span');
                    fileNameSpan.classList.add('adw-action-row-title');
                    fileNameSpan.textContent = file.name;
                    fileRow.appendChild(fileNameSpan);

                    const fileSizeSpan = document.createElement('span');
                    fileSizeSpan.classList.add('adw-action-row-subtitle');
                    fileSizeSpan.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
                    fileRow.appendChild(fileSizeSpan);

                    selectedFilesDisplay.appendChild(fileRow);
                });
            } else {
                selectedFilesDisplay.innerHTML = '';
                selectedFilesDisplay.style.display = 'none'; // Hide if no files selected
            }
        });
    }

    if (galleryUploadForm && gallerySubmitButton) {
        galleryUploadForm.addEventListener('submit', () => {
            // Ensure files are selected before disabling and showing spinner,
            // otherwise client-side validation (like 'required') might be bypassed visually.
            // HTML5 validation should prevent form submission if 'required' is on the input.
            // If using JS to check, do it here. For now, assume HTML5 'required' on original input works.
            if (actualFileInput && actualFileInput.files && actualFileInput.files.length === 0 && actualFileInput.hasAttribute('required')) {
                 // Optionally provide a visual cue here if the browser doesn't, though standard validation should handle it.
                return; // Don't change button state if client-side validation fails early.
            }

            gallerySubmitButton.disabled = true;
            // Attempt to use an Adwaita-like spinner.
            // If adw-spinner and micro classes are not defined in the main CSS, this might not display correctly.
            // A simple text change is a safe fallback.
            gallerySubmitButton.innerHTML = '<span class="adw-spinner micro" role="status" aria-hidden="true"></span> Uploading...';
            // Fallback if spinner class is not effective:
            // gallerySubmitButton.textContent = 'Uploading...';
        });
    }
});
</script>

{# TODO: Move this to a global CSS file #}
<style>
    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    .adw-spinner.micro {
        display: inline-block;
        width: 1em; /* Adjust size as needed */
        height: 1em; /* Adjust size as needed */
        border: 2px solid currentColor; /* Use current text color for spinner */
        border-right-color: transparent; /* Creates the spinning effect */
        border-radius: 50%;
        animation: adw-spinner-spin .75s linear infinite;
        vertical-align: text-bottom; /* Aligns spinner nicely with text */
        margin-right: .5em; /* Space between spinner and text */
    }
    @keyframes adw-spinner-spin {
        to { transform: rotate(360deg); }
    }

    /* Styles for profile gallery grid */
    .profile-gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: var(--spacing-m, 16px);
        margin-top: var(--spacing-m, 16px);
    }

    .gallery-photo-card {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-radius: var(--radius-l); /* Match Adwaita card rounding */
    }

    .gallery-photo-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        background-color: var(--img-bg-color, var(--secondary-bg-color, #f0f0f0)); /* Use theme variable or fallback */
        /* Removed border-radius from here, apply to parent .gallery-photo-card or .adw-card */
    }
    .adw-card.gallery-photo-card .adw-card__content.gallery-photo-caption { /* Target more specifically if using adw-card structure */
        padding: var(--spacing-s);
        /* text-align: center; */ /* Optional */
    }


    /* Styles for gallery dialog navigation */
    #gallery-photo-dialog .dialog-image-content {
        /* Ensure position:relative is set on this element (done inline for now) */
    }
    .gallery-nav-button {
        position: absolute;
        top: calc(35% - 16px); /* Vertically center on the 70vh image approx, minus half button height */
        transform: translateY(-50%);
        background-color: var(--secondary-bg-color-alpha-75, rgba(0,0,0,0.3)); /* Use theme variable with alpha or fallback */
        color: var(--primary-fg-color, white); /* Use theme variable or fallback */
        border: none;
        /* padding: var(--spacing-s); already on adw-button */
        cursor: pointer;
        z-index: 10; /* Above the image */
        /* border-radius: var(--radius-full); already on adw-button circular */
        /* font-size: 1.5em; /* Handled by icon size */
        line-height: 1;
        width: 32px; /* Explicit size for circular button */
        height: 32px;
        box-shadow: var(--shadow-s);
    }
    .gallery-nav-button.prev {
        left: var(--spacing-m);
    }
    .gallery-nav-button.next {
        right: var(--spacing-m);
    }
    .gallery-nav-button:hover {
        background-color: var(--secondary-bg-color-alpha-90, rgba(0,0,0,0.6)); /* Darker on hover */
    }
    .gallery-nav-button .adw-icon {
         /* Adwaita icons should adapt, but if they are SVG and need specific color: */
        /* fill: currentColor; */
    }

    /* Spinner for image loading in dialog */
    #gallery-image-loader.adw-spinner.large {
        width: 48px; /* Example size */
        height: 48px;
        border-width: 4px;
         /* Ensure it's above the semi-transparent image during loading */
        z-index: 5; /* Below nav buttons, above image */
    }
    #full-gallery-photo-img.loading {
        opacity: 0.3; /* Make image semi-transparent while its replacement loads */
    }

    .form-actions-end {
        text-align: right; /* Aligns inline-block or inline children to the right */
        margin-top: var(--spacing-m); /* Add some default margin if needed */
    }
</style>
{% endblock %}
