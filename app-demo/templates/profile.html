{% extends "base.html" %}

{% block title %}Profile: {{ user_profile.username }}{% endblock %}

{% block headerbar %}
<adw-header-bar>
    <adw-window-title slot="title" title="{{ user_profile.username }}'s Profile"></adw-window-title>
    <adw-button slot="start" icon-name="go-previous-symbolic" href="{{ url_for('index') }}" aria-label="Back to Home"></adw-button>
    {% if current_user == user_profile %}
    <adw-button slot="end" text="Edit Profile" href="{{ url_for('edit_profile') }}" suggested></adw-button>
    {% endif %}
</adw-header-bar>
{% endblock %}

{% block content %}
<adw-clamp class="adw-clamp-xl">
    <adw-box orientation="vertical" spacing="l" style="padding-top: var(--spacing-l);">

        {# User Header Info #}
        <adw-box orientation="horizontal" spacing="xl" align="center">
            <adw-avatar image="{{ url_for('static', filename=user_profile.profile_photo_url) if user_profile.profile_photo_url else default_avatar_url }}" text="{{ user_profile.username }}" size="96"></adw-avatar>
            <adw-box orientation="vertical" spacing="xs">
                <adw-label title-level="1">{{ user_profile.full_name or user_profile.username }}</adw-label>
                {% if user_profile.full_name %}
                <adw-label is-caption>@{{ user_profile.username }}</adw-label>
                {% endif %}
            </adw-box>
        </adw-box>

        {# Profile Details Group #}
        <adw-preferences-group title="About {{user_profile.username}}">
            {% if user_profile.profile_info %}
            <adw-expander-row title="Bio" subtitle="View user's biography">
                <div style="padding: var(--spacing-m); white-space: pre-wrap;">
                    {{ user_profile.profile_info | safe }}
                </div>
            </adw-expander-row>
            {% else %}
            <adw-action-row title="Bio" subtitle="No bio provided."></adw-action-row>
            {% endif %}

            {% if user_profile.location %}
            <adw-action-row title="Location" subtitle="{{ user_profile.location }}"></adw-action-row>
            {% endif %}

            {% if user_profile.website_url %}
                {% if user_profile.website_url.startswith('http://') or user_profile.website_url.startswith('https://') %}
                <adw-action-row title="Website" subtitle="{{ user_profile.website_url }}" href="{{ user_profile.website_url }}" target="_blank" activatable></adw-action-row>
                {% else %}
                <adw-action-row title="Website" subtitle="{{ user_profile.website_url }} (Not a valid link)"></adw-action-row>
                {% endif %}
            {% endif %}

            {% if current_user == user_profile %}
            <adw-action-row title="Profile Privacy" subtitle="{{ 'Public' if user_profile.is_profile_public else 'Private (Only you can see full details)' }}"></adw-action-row>
            {% endif %}
        </adw-preferences-group>

        {# User Posts Section #}
        <adw-preferences-group title="Posts by {{ user_profile.username }}">
            {% if posts_pagination and posts_pagination.items %}
                <adw-list-box selectable>
                    {% for post in posts_pagination.items %}
                    <adw-action-row href="{{ url_for('view_post', post_id=post.id) }}" title="{{ post.title }}{% if not post.is_published and current_user == post.author %} (Draft){% endif %}" subtitle="{% if post.is_published and post.published_at %}Published: {{ post.published_at.strftime('%Y-%m-%d %H:%M') }} UTC{% elif not post.is_published %}Draft - Last updated: {{ post.updated_at.strftime('%Y-%m-%d %H:%M') }} UTC{% else %}Created: {{ post.created_at.strftime('%Y-%m-%d %H:%M') }} UTC{% endif %}" activatable></adw-action-row>
                    {% endfor %}
                </adw-list-box>

                {# Pagination Controls - Using Adwaita ToggleGroup for a more native feel #}
                {% if posts_pagination.pages > 1 %}
                <adw-box orientation="horizontal" justify="center" style="margin-top: var(--spacing-l);">
                    <adw-toggle-group>
                        {% if posts_pagination.has_prev %}
                            <adw-button icon-name="go-previous-symbolic" href="{{ url_for('profile', username=user_profile.username, page=posts_pagination.prev_num) }}"></adw-button>
                        {% else %}
                            <adw-button icon-name="go-previous-symbolic" disabled></adw-button>
                        {% endif %}

                        {% for page_num in posts_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if page_num == posts_pagination.page %}
                                    <adw-button text="{{ page_num }}" suggested disabled aria-current="page"></adw-button>
                                {% else %}
                                    <adw-button text="{{ page_num }}" href="{{ url_for('profile', username=user_profile.username, page=page_num) }}"></adw-button>
                                {% endif %}
                            {% elif loop.index != 1 and loop.index != posts_pagination.pages + 2 %} {# Avoid ellipsis at very start/end if not needed #}
                                <adw-button text="â€¦" flat disabled style="pointer-events: none;"></adw-button>
                            {% endif %}
                        {% endfor %}

                        {% if posts_pagination.has_next %}
                            <adw-button icon-name="go-next-symbolic" href="{{ url_for('profile', username=user_profile.username, page=posts_pagination.next_num) }}"></adw-button>
                        {% else %}
                            <adw-button icon-name="go-next-symbolic" disabled></adw-button>
                        {% endif %}
                    </adw-toggle-group>
                </adw-box>
                {% endif %}
            {% else %}
                <adw-status-page icon-name="document-new-symbolic" title="No Posts Yet" description="{{ user_profile.username }} has not made any posts.">
                </adw-status-page>
            {% endif %}
        </adw-preferences-group>
    </adw-box>
</adw-clamp>
{% endblock %}
