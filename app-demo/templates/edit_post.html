{% extends "base.html" %}

{% block title %}Edit Post: {{ post.title }}{% endblock %}

{% block content %}
<div class="main-content-clamped">
    <h1 style="margin-bottom: var(--spacing-l);">Edit Post</h1> {# Using h1 for page title #}
    <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}" novalidate>
        {{ form.hidden_tag() }} {# CSRF token #}
        <adw-list-box style="margin-bottom: var(--spacing-l);">
            <adw-entry-row
                title="{{ form.title.label.text }}"
                name="{{ form.title.name }}"
                id="{{ form.title.id or 'title_field' }}"
                placeholder="Enter post title"
                value="{{ form.title.data or '' }}"
                {% if form.title.flags.required %}required{% endif %}
                subtitle="{{ form.title.errors[0] if form.title.errors else '' }}">
            </adw-entry-row>

            {# Content Field - Tiptap Editor #}
            <div class="adw-row" style="padding: var(--spacing-s) var(--spacing-m); display: flex; flex-direction: column;">
                {{ form.content.label(class_='adw-label', style='margin-bottom: var(--spacing-xs);') }}
                {# Hidden textarea that Tiptap will sync to. Value is pre-filled by WTForms. #}
                {{ form.content(id=form.content.id or 'content_field', style='display:none;') }}
                {# Tiptap editor container and toolbar #}
                <div id="tiptap-toolbar" class="tiptap-toolbar">
                    <button type="button" id="bold-btn">B</button>
                    <button type="button" id="italic-btn">I</button>
                    <button type="button" id="strike-btn">S</button>
                    <button type="button" id="bulletList-btn">UL</button>
                    <button type="button" id="orderedList-btn">OL</button>
                    <button type="button" id="blockquote-btn">"</button>
                    <button type="button" id="h1-btn">H1</button>
                    <button type="button" id="h2-btn">H2</button>
                    <button type="button" id="h3-btn">H3</button>
                    <button type="button" id="p-btn">P</button>
                    <button type="button" id="clear-btn">Clear</button>
                </div>
                <div id="tiptap-editor-container"></div> {# Tiptap will mount here #}

                {% if form.content.errors %}
                    <div class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs);">
                        {% for error in form.content.errors %}{{ error }}<br>{% endfor %}
                    </div>
                {% endif %}
            </div>

            {# Categories Field #}
            <div class="adw-row" style="padding: var(--spacing-s) var(--spacing-m); display: flex; flex-direction: column;">
                {{ form.categories.label(class_='adw-label', style='margin-bottom: var(--spacing-s); font-weight: bold;') }}
                <div class="adw-checkbox-group" style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                    {{ form.categories() }} {# Renders as a list of checkboxes, pre-selected by WTForms obj=post #}
                </div>
                {% if form.categories.errors %}
                    <div class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs);">
                        {% for error in form.categories.errors %}{{ error }}<br>{% endfor %}
                    </div>
                {% endif %}
            </div>

            <adw-entry-row
                title="{{ form.tags_string.label.text }}"
                name="{{ form.tags_string.name }}"
                id="{{ form.tags_string.id or 'tags_string_field' }}"
                placeholder="e.g., tech, travel, food"
                value="{{ form.tags_string.data or '' }}"
                subtitle="{{ form.tags_string.errors[0] if form.tags_string.errors else 'Comma-separated values.' }}">
            </adw-entry-row>
        </adw-list-box>

        <adw-action-row>
            <div slot="suffix" style="display: flex; gap: var(--spacing-s);">
                <a href="{{ url_for('view_post', post_id=post.id) }}" class="adw-button">Cancel</a>
                {{ form.submit(class_='adw-button suggested-action', label='Update Post') }}
            </div>
        </adw-action-row>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module">
    // This script is nearly identical to create_post.html's Tiptap script.
    // The key difference is that `contentTextarea.value` will contain the
    // existing post content, which Tiptap will load.
    if (window.Tiptap && window.Tiptap.Core && window.Tiptap.StarterKit) {
        const { Editor } = window.Tiptap.Core;
        const StarterKit = window.Tiptap.StarterKit;
        const Placeholder = window.Tiptap.Placeholder;

        const contentTextarea = document.getElementById('{{ form.content.id or "content_field" }}');
        const editorContainer = document.getElementById('tiptap-editor-container');
        const form = contentTextarea.closest('form');

        const editor = new Editor({
            element: editorContainer,
            extensions: [
                StarterKit.configure({
                    // heading: { levels: [1, 2, 3] },
                }),
                Placeholder.configure({
                    placeholder: 'Write your blog post here...',
                })
            ],
            // For edit_post.html, contentTextarea.value is pre-filled by Flask/WTForms
            // with the existing post content. Tiptap will pick this up.
            content: contentTextarea.value,
            onUpdate: ({ editor }) => {
                contentTextarea.value = editor.getHTML();
            },
        });

        // Toolbar button actions
        const toolbar = document.getElementById('tiptap-toolbar');
        toolbar.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const action = e.target.id.replace('-btn', '');
            switch(action) {
                case 'bold': editor.chain().focus().toggleBold().run(); break;
                case 'italic': editor.chain().focus().toggleItalic().run(); break;
                case 'strike': editor.chain().focus().toggleStrike().run(); break;
                case 'bulletList': editor.chain().focus().toggleBulletList().run(); break;
                case 'orderedList': editor.chain().focus().toggleOrderedList().run(); break;
                case 'blockquote': editor.chain().focus().toggleBlockquote().run(); break;
                case 'h1': editor.chain().focus().toggleHeading({ level: 1 }).run(); break;
                case 'h2': editor.chain().focus().toggleHeading({ level: 2 }).run(); break;
                case 'h3': editor.chain().focus().toggleHeading({ level: 3 }).run(); break;
                case 'p': editor.chain().focus().setParagraph().run(); break;
                case 'clear': editor.chain().focus().clearContent().run(); break;
            }
        });

        // Update button states based on editor selection
        editor.on('transaction', () => {
            document.getElementById('bold-btn').classList.toggle('is-active', editor.isActive('bold'));
            document.getElementById('italic-btn').classList.toggle('is-active', editor.isActive('italic'));
            document.getElementById('strike-btn').classList.toggle('is-active', editor.isActive('strike'));
            document.getElementById('bulletList-btn').classList.toggle('is-active', editor.isActive('bulletList'));
            document.getElementById('orderedList-btn').classList.toggle('is-active', editor.isActive('orderedList'));
            document.getElementById('blockquote-btn').classList.toggle('is-active', editor.isActive('blockquote'));
            document.getElementById('h1-btn').classList.toggle('is-active', editor.isActive('heading', { level: 1 }));
            document.getElementById('h2-btn').classList.toggle('is-active', editor.isActive('heading', { level: 2 }));
            document.getElementById('h3-btn').classList.toggle('is-active', editor.isActive('heading', { level: 3 }));
        });

        // Ensure content is synced before form submission
        if (form) {
            form.addEventListener('submit', () => {
                contentTextarea.value = editor.getHTML();
            });
        }

        // Destroy editor when page unloads
        window.addEventListener('beforeunload', () => {
            if (editor && !editor.isDestroyed) {
                editor.destroy();
            }
        });

    } else {
        console.error('Tiptap is not loaded. Rich text editor will not function.');
        const contentTextarea = document.getElementById('{{ form.content.id or "content_field" }}');
        if(contentTextarea) contentTextarea.style.display = 'block'; // Fallback
    }
</script>
{% endblock %}
