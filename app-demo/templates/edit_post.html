{% extends "base.html" %}

{% block title %}Edit Post: {{ post.title }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .adw-checkbox-row label {
    vertical-align: middle;
    margin-left: var(--spacing-s);
  }
  .adw-checkbox-row .adw-action-row__title {
    margin-left: var(--spacing-s);
  }
  .adw-preferences-group .errors {
    color: var(--error-color);
    font-size: var(--font-size-small);
    margin-top: var(--spacing-xxs);
    padding-left: var(--spacing-m);
  }
</style>
{% endblock %}

{% block content %}
<adw-clamp class="main-content-clamped">
  <adw-preferences-page title="Edit Post: {{ post.title }}">
    <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}" novalidate>
        {{ form.hidden_tag() }} {# CSRF token #}

        <adw-preferences-group title="Post Details">
            <adw-list-box>
                <adw-entry-row
                    title="{{ form.title.label.text }}"
                    name="{{ form.title.name }}"
                    id="{{ form.title.id or 'title_field' }}"
                    placeholder="Enter post title"
                    value="{{ form.title.data or '' }}"
                    {% if form.title.flags.required %}required{% endif %}
                    subtitle="{{ form.title.errors[0] if form.title.errors else '' }}"
                    class="{{ 'has-error' if form.title.errors else '' }}">
                </adw-entry-row>

                <adw-action-row title="{{ form.content.label.text }}" subtitle="Edit your post content below.">
                    <div slot="suffix" style="width:100%;">
                        {# Use adw-textarea-standalone for consistent multiline entry styling #}
                        {{ form.content(id=form.content.id or 'content_field_edit', class='adw-textarea-standalone', style='width: 100%; min-height: 200px; resize: vertical;', rows='10') }}
                        {% if form.content.errors %}
                            <div class="errors" style="color: var(--error-color); font-size: var(--font-size-small); margin-top: var(--spacing-xs);">
                                {% for error in form.content.errors %}{{ error }}<br>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </adw-action-row>
            </adw-list-box>
        </adw-preferences-group>

        <adw-preferences-group title="{{ form.categories.label.text }}">
            <adw-list-box class="{{ 'has-error' if form.categories.errors else '' }}">
                {% for subfield in form.categories %}
                <adw-action-row class="adw-checkbox-row">
                    <adw-checkbox slot="prefix"
                                  name="{{ subfield.name }}"
                                  id="{{ subfield.id }}"
                                  value="{{ subfield.widget.attrs.get('value', subfield.data) }}"
                                  label="{{ subfield.label.text }}"
                                  {% if subfield.data %}checked{% endif %}>
                    </adw-checkbox>
                    {% if loop.first and form.categories.errors %}
                        <adw-label slot="subtitle" class="error-text" style="color: var(--error-color);">{{ form.categories.errors|join('; ') }}</adw-label>
                    {% endif %}
                </adw-action-row>
                {% endfor %}
            </adw-list-box>
            {# Errors handled in the loop now #}
            {# {% if form.categories.errors %}
            <adw-list-box> <adw-action-row subtitle="{{ form.categories.errors|join(' ') }}" class="error-row"></adw-action-row> </adw-list-box>
            {% endif %} #}
            {% endif %}
        </adw-preferences-group>

        <adw-preferences-group title="Tags">
            <adw-list-box>
                <adw-entry-row
                    title="{{ form.tags_string.label.text }}"
                    name="{{ form.tags_string.name }}"
                    id="{{ form.tags_string.id or 'tags_string_field' }}"
                    placeholder="e.g., tech, travel, food"
                    value="{{ form.tags_string.data or '' }}" {# Pre-filled by WTForms obj=post #}
                    subtitle="{{ form.tags_string.errors[0] if form.tags_string.errors else 'Comma-separated values.' }}"
                    class="{{ 'has-error' if form.tags_string.errors else '' }}">
                </adw-entry-row>
            </adw-list-box>
        </adw-preferences-group>

        <adw-action-row>
            <div slot="suffix" style="display: flex; justify-content: flex-end; gap: var(--spacing-s); width: 100%;">
                <adw-button flat href="{{ url_for('view_post', post_id=post.id) }}">Cancel</adw-button>
                <adw-button type="submit" suggested label="{{ form.submit.label.text if form.submit.label else 'Update Post' }}"></adw-button>
            </div>
        </adw-action-row>
    </form>
  </adw-preferences-page>
</adw-clamp>
{% endblock %}

{% block scripts %}
{{ super() }}
{# No Tiptap-specific scripts needed anymore for edit_post.html #}
{% endblock %}
