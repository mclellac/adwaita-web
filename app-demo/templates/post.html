{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block header_title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="post-view"> {# Removed adw-clamp content-clamp as base.html provides clamp #}
    <article class="post-article">
        <header class="post-header">
            <h1 class="adw-title-1">{{ post.title }}{% if not post.is_published and current_user == post.author %} <span class="adw-label caption draft-indicator">(Draft)</span>{% endif %}</h1>
            <div class="post-meta-detail">
                <p class="adw-label body">
                    By: <a href="{{ url_for('profile', username=post.author.username) }}" class="adw-link">{{ post.author.username if post.author else 'Unknown Author' }}</a>
                    {% if post.is_published and post.published_at %}
                        on <time datetime="{{ post.published_at.isoformat() }}">{{ post.published_at.strftime('%Y-%m-%d %H:%M') }} UTC</time> (Published)
                    {% else %}
                         (Draft created: <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>)
                    {% endif %}
                </p>
                {% if post.updated_at and post.updated_at != post.created_at and (post.published_at is none or post.updated_at != post.published_at) %}
                    <p class="adw-label caption last-updated">(Last updated: <time datetime="{{ post.updated_at.isoformat() }}">{{ post.updated_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>)</p>
                {% endif %}
            </div>

            {% if post.categories %}
            <div class="post-terms post-categories">
                <strong class="adw-label caption post-meta-terms-label">Categories:</strong>
                {% for category in post.categories %}
                    <a href="{{ url_for('posts_by_category', category_slug=category.slug) }}" class="adw-button flat compact">{{ category.name }}</a>
                {% endfor %}
            </div>
            {% endif %}

            {% if post.tags %}
            <div class="post-terms post-tags">
                <strong class="adw-label caption post-meta-terms-label">Tags:</strong>
                {% for tag in post.tags %}
                  <a href="{{ url_for('posts_by_tag', tag_slug=tag.slug) }}" class="adw-button flat compact">{{ tag.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <div class="post-content styled-text-content"> {# Added styled-text-content for prose styling #}
            {{ post.content | safe }}
        </div>

        {% if post.author %}
        <section class="author-bio-section adw-card">
            <h3 class="adw-title-3">About {{ post.author.full_name or post.author.username }}</h3>
            <div class="adw-box adw-box-spacing-m author-bio-content">
                <span class="adw-avatar size-large">
                     {% set author_avatar = url_for('static', filename=post.author.profile_photo_url) if post.author.profile_photo_url else url_for('static', filename='img/default_avatar.png') %}
                     <img src="{{ author_avatar }}" alt="{{ post.author.username }} avatar" class="adw-avatar__image">
                </span>
                <div class="author-bio-text-content">
                    {% if post.author.profile_info %}
                    <p class="adw-label body author-bio-text">
                        {{ post.author.profile_info | safe }}
                    </p>
                    {% else %}
                    <p class="adw-label body author-bio-text-placeholder">This author has not provided a bio yet.</p>
                    {% endif %}
                    <a href="{{ url_for('profile', username=post.author.username) }}" class="adw-button flat view-profile-button">View Profile of {{ post.author.username }}</a>
                </div>
            </div>
        </section>
        {% endif %}

        <section class="share-buttons-section">
            <h4 class="adw-title-4">Share this post:</h4>
            <div class="adw-box adw-box-spacing-s share-buttons-container">
                <a href="https://twitter.com/intent/tweet?url={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}&text={{ post.title|urlencode }}"
                    target="_blank" rel="noopener noreferrer" aria-label="Share on Twitter" class="adw-button flat">Twitter</a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}"
                    target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook" class="adw-button flat">Facebook</a>
                <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}&title={{ post.title|urlencode }}&summary={{ (post.content|striptags|truncate(120))|urlencode }}"
                    target="_blank" rel="noopener noreferrer" aria-label="Share on LinkedIn" class="adw-button flat">LinkedIn</a>
                <a href="mailto:?subject={{ post.title|urlencode }}&body=Check%20out%20this%20post%3A%20{{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}"
                    aria-label="Share via Email" class="adw-button flat">Email</a>
            </div>
        </section>

        {% if post.author == current_user %}
        <div class="post-actions-container adw-box adw-box-spacing-s">
            <a href="{{ url_for('edit_post', post_id=post.id) }}" class="adw-button">Edit Post</a>
            <button id="open-delete-dialog-btn" class="adw-button destructive-action">Delete Post</button>
        </div>

        <div class="adw-dialog" id="delete-confirm-dialog" role="alertdialog" aria-labelledby="delete-dialog-title" aria-modal="true" hidden>
            <header class="adw-header-bar adw-dialog__header">
                 <h2 class="adw-header-bar__title" id="delete-dialog-title">Confirm Deletion</h2>
            </header>
            <div class="adw-dialog__content">
                <p class="adw-label body">Are you sure you want to delete this post? This action cannot be undone.</p>
            </div>
            <footer class="adw-dialog__actions">
                <button id="cancel-delete-btn" class="adw-button flat">Cancel</button>
                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" id="delete-post-form" class="delete-post-form-inline">
                    {{ csrf_token() }} {# Flask-WTF CSRF token #}
                    <button id="confirm-delete-btn" type="submit" class="adw-button destructive-action">Delete</button>
                </form>
            </footer>
        </div>
        {% endif %}
    </article>

    <hr class="section-divider">

    <section class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" class="adw-title-2">Comments ({{ comments|length }})</h2>
        {% if comments %}
            <div class="adw-list-box comments-list">
                {% for comment in comments %}
                <article class="adw-card comment-card"> {# Changed div to article, added adw-card #}
                    <header class="comment-header adw-box adw-box-spacing-s comment-header-box">
                        <span class="adw-avatar size-medium">
                           {% set comment_avatar = url_for('static', filename=comment.author.profile_photo_url) if comment.author.profile_photo_url else url_for('static', filename='img/default_avatar.png') %}
                           <img src="{{ comment_avatar }}" alt="{{ comment.author.username }} avatar" class="adw-avatar__image">
                        </span>
                        <div class="comment-author-meta">
                             <a href="{{ url_for('profile', username=comment.author.username) }}" class="adw-link comment-author-link-strong">{{ comment.author.username }}</a>
                            <small class="adw-label caption comment-timestamp"><time datetime="{{ comment.created_at.isoformat() }}">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time></small>
                        </div>
                    </header>
                    <p class="comment-text styled-text-content">{{ comment.text }}</p> {# Added styled-text-content #}
                    {% if current_user.is_authenticated and (comment.author == current_user or post.author == current_user) %}
                        <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" onsubmit="return confirm('Are you sure you want to delete this comment?');" class="comment-delete-form-container">
                            {{ delete_form.hidden_tag() }} {# Assuming delete_form is passed for CSRF #}
                            <button type="submit" class="adw-button destructive-action compact">Delete Comment</button>
                        </form>
                    {% endif %}
                </article>
                {% endfor %}
            </div>
        {% else %}
            <p class="adw-label body">No comments yet.</p>
        {% endif %}
    </section>

    {% if current_user.is_authenticated %}
    <section class="comment-form-section adw-list-box form-section" aria-labelledby="leave-comment-heading">
         <header class="adw-list-box-header">
            <h3 id="leave-comment-heading" class="adw-title-3">Leave a Comment</h3>
        </header>
        <form method="POST" action="{{ url_for('view_post', post_id=post.id) }}" class="stacked-form">
            {{ form.hidden_tag() }} {# Flask-WTF CSRF token #}
            <div class="form-field-row comment-form-field-row {{ 'has-error' if form.text.errors else '' }}"> {# More standard form field structure #}
                 <label for="{{ form.text.id or 'comment_text_input' }}" class="adw-label">{{ form.text.label.text }}</label>
                 <textarea name="{{ form.text.name }}" id="{{ form.text.id or 'comment_text_input' }}" class="adw-entry adw-textarea" rows="4">{{ form.text.data or ''}}</textarea>
            </div>
            {% if form.text.errors %}
            <div class="form-field-error">
                <span class="adw-label caption error-text">{{form.text.errors|join(' ')}}</span>
            </div>
            {% endif %}
            <div class="form-actions-container comment-form-actions">
                 <button type="submit" class="adw-button suggested-action">{{ form.submit.label.text }}</button>
            </div>
        </form>
    </section>
    {% else %}
    <div class="login-prompt-comment">
        <p class="adw-label body"><a href="{{ url_for('login', next=request.url) }}" class="adw-link">Login</a> to leave a comment.</p>
    </div>
    {% endif %}

    {% if related_posts %}
    <section class="related-posts-section related-posts-container" aria-labelledby="related-posts-heading">
        <h2 id="related-posts-heading" class="adw-title-2">Related Posts</h2>
        <div class="adw-list-box">
            {% for related_post in related_posts %}
            <a href="{{ url_for('view_post', post_id=related_post.id) }}" class="adw-action-row activatable">
                <div class="adw-action-row-content">
                    <span class="adw-action-row-title">{{ related_post.title }}</span>
                    {% if related_post.author %}
                    <span class="adw-action-row-subtitle">By {{ related_post.author.username }}</span>
                    {% endif %}
                </div>
                <span class="adw-action-row__chevron"></span>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <div class="adw-box adw-box-spacing-s back-to-posts-container">
         <a href="{{ url_for('index') }}" class="adw-button"><span class="adw-icon icon-actions-go-previous-symbolic"></span> Back to Posts</a>
    </div>
</div>

<script>
// Delete post dialog script
document.addEventListener('DOMContentLoaded', () => {
    const deleteDialogEl = document.getElementById('delete-confirm-dialog');
    const openDialogBtn = document.getElementById('open-delete-dialog-btn');
    const cancelBtn = document.getElementById('cancel-delete-btn');
    const confirmBtn = document.getElementById('confirm-delete-btn'); // Get the confirm button

    if (openDialogBtn && deleteDialogEl) {
        openDialogBtn.addEventListener('click', (event) => {
            event.preventDefault();
            deleteDialogEl.removeAttribute('hidden'); // Show dialog using 'hidden' attribute
            if (typeof deleteDialogEl.showModal === "function") { // Use <dialog>.showModal() if available
                // deleteDialogEl.showModal(); // This would be ideal but might not be polyfilled/styled for all browsers without more work
            }
            // Basic focus management: focus the first focusable element in the dialog
            const firstFocusable = deleteDialogEl.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) {
                firstFocusable.focus();
            }
        });
    }

    if (cancelBtn && deleteDialogEl) {
        cancelBtn.addEventListener('click', () => {
            deleteDialogEl.setAttribute('hidden', 'true'); // Hide dialog
            // if (typeof deleteDialogEl.close === "function") { // For native <dialog>
            //     deleteDialogEl.close();
            // }
        });
    }

    if (confirmBtn && deleteDialogEl) { // Add event listener for confirm button
        confirmBtn.addEventListener('click', () => {
            // This will submit the form. The dialog will disappear on page reload.
            // If it were an AJAX delete, we'd definitely hide it here:
            // deleteDialogEl.setAttribute('hidden', 'true');
        });
    }

    // Optional: Close dialog on ESC key
    if (deleteDialogEl) {
        deleteDialogEl.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                deleteDialogEl.setAttribute('hidden', 'true');
                // if (typeof deleteDialogEl.close === "function") { // For native <dialog>
                //    deleteDialogEl.close();
                // }
            }
        });
    }
});
</script>
{% endblock %}
