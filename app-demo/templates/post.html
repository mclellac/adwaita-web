{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block header_title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="post-view"> {# Removed adw-clamp content-clamp as base.html provides clamp #}
    <article class="post-article">
        <header class="post-header">
            <h1 class="adw-title-1">{{ post.title }}{% if not post.is_published and current_user == post.author %} <span class="adw-label caption draft-indicator">(Draft)</span>{% endif %}</h1>
            <div class="post-meta-detail">
                <p class="adw-label body">
                    By: <a href="{{ url_for('profile', username=post.author.username) }}" class="adw-link">{{ post.author.username if post.author else 'Unknown Author' }}</a>
                    {% if post.is_published and post.published_at %}
                        on <time datetime="{{ post.published_at.isoformat() }}">{{ post.published_at.strftime('%Y-%m-%d %H:%M') }} UTC</time> (Published)
                    {% else %}
                         (Draft created: <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>)
                    {% endif %}
                </p>
                {% if post.updated_at and post.updated_at != post.created_at and (post.published_at is none or post.updated_at != post.published_at) %}
                    <p class="adw-label caption last-updated">(Last updated: <time datetime="{{ post.updated_at.isoformat() }}">{{ post.updated_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>)</p>
                {% endif %}
            </div>

            {% if post.categories %}
            <div class="post-terms post-categories">
                <strong class="adw-label caption post-meta-terms-label">Categories:</strong>
                {% for category in post.categories %}
                    <a href="{{ url_for('posts_by_category', category_slug=category.slug) }}" class="adw-button flat compact">{{ category.name }}</a>
                {% endfor %}
            </div>
            {% endif %}

            {% if post.tags %}
            <div class="post-terms post-tags">
                <strong class="adw-label caption post-meta-terms-label">Tags:</strong>
                {% for tag in post.tags %}
                  <a href="{{ url_for('posts_by_tag', tag_slug=tag.slug) }}" class="adw-button flat compact">{{ tag.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <div class="post-content styled-text-content"> {# Added styled-text-content for prose styling #}
            {{ post.content | safe }}
        </div>

        {% if post.author %}
        <section class="author-bio-section adw-card">
            <h3 class="adw-title-3">About {{ post.author.full_name or post.author.username }}</h3>
            <div class="adw-box adw-box-spacing-m author-bio-content">
                <span class="adw-avatar size-large">
                     {% set author_avatar = url_for('static', filename=post.author.profile_photo_url) if post.author.profile_photo_url else url_for('static', filename='img/default_avatar.png') %}
                     <img src="{{ author_avatar }}" alt="{{ post.author.username }} avatar" class="adw-avatar__image">
                </span>
                <div class="author-bio-text-content">
                    {% if post.author.profile_info %}
                    <p class="adw-label body author-bio-text">
                        {{ post.author.profile_info | safe }}
                    </p>
                    {% else %}
                    <p class="adw-label body author-bio-text-placeholder">This author has not provided a bio yet.</p>
                    {% endif %}
                    <a href="{{ url_for('profile', username=post.author.username) }}" class="adw-button flat view-profile-button">View Profile of {{ post.author.username }}</a>
                </div>
            </div>
        </section>
        {% endif %}

        <section class="share-buttons-section">
            <h4 class="adw-title-4">Share this post:</h4>
            <div class="adw-box adw-box-spacing-s share-buttons-container">
                <a href="https://twitter.com/intent/tweet?url={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}&text={{ post.title|urlencode }}"
                    target="_blank" rel="noopener noreferrer" aria-label="Share on Twitter" class="adw-button flat">Twitter</a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}"
                    target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook" class="adw-button flat">Facebook</a>
                <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}&title={{ post.title|urlencode }}&summary={{ (post.content|striptags|truncate(120))|urlencode }}"
                    target="_blank" rel="noopener noreferrer" aria-label="Share on LinkedIn" class="adw-button flat">LinkedIn</a>
                <a href="mailto:?subject={{ post.title|urlencode }}&body=Check%20out%20this%20post%3A%20{{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}"
                    aria-label="Share via Email" class="adw-button flat">Email</a>
            </div>
        </section>

        {% if post.author == current_user %}
        <div class="post-actions-container adw-box adw-box-spacing-s">
            <a href="{{ url_for('edit_post', post_id=post.id) }}" class="adw-button">Edit Post</a>
            <button id="open-delete-dialog-btn" class="adw-button destructive-action">Delete Post</button>
        </div>

        <adw-dialog id="delete-confirm-dialog" title="Confirm Deletion">
            <div slot="content">
                <p class="adw-label body">Are you sure you want to delete this post? This action cannot be undone.</p>
            </div>
            <div slot="buttons">
                <button id="cancel-delete-btn" class="adw-button flat">Cancel</button>
                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" id="delete-post-form" class="delete-post-form-inline" style="display: inline;">
                    {{ csrf_token() }} {# Flask-WTF CSRF token #}
                    <button id="confirm-delete-btn" type="submit" class="adw-button destructive-action">Delete</button>
                </form>
            </div>
        </adw-dialog>
        {% endif %}
    </article>

    <hr class="section-divider">

    <section class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" class="adw-title-2">Comments ({{ comments|length }})</h2>
        {% if comments %}
            <div class="adw-list-box comments-list">
                {% for comment in comments %}
                <article class="adw-card comment-card comment-item" data-comment-id="{{ comment.id }}"> {# Added comment-item and data-comment-id #}
                    <header class="comment-header adw-box adw-box-spacing-s comment-header-box">
                        <span class="adw-avatar size-medium">
                           {% set comment_avatar = url_for('static', filename=comment.author.profile_photo_url) if comment.author.profile_photo_url else url_for('static', filename='img/default_avatar.png') %}
                           <img src="{{ comment_avatar }}" alt="{{ comment.author.username }} avatar" class="adw-avatar__image">
                        </span>
                        <div class="comment-author-meta">
                             <a href="{{ url_for('profile', username=comment.author.username) }}" class="adw-link comment-author-link-strong">{{ comment.author.username }}</a>
                            <small class="adw-label caption comment-timestamp"><time datetime="{{ comment.created_at.isoformat() }}">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time></small>
                        </div>
                    </header>
                    <p class="comment-text styled-text-content">{{ comment.text }}</p> {# Added styled-text-content #}
                    {% if current_user.is_authenticated and (comment.author == current_user or post.author == current_user) %}
                        {# Removed onsubmit, added class and data attribute for JS targeting #}
                        <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" class="comment-delete-form-container delete-comment-form" data-comment-id="{{ comment.id }}">
                            {{ delete_form.hidden_tag() }} {# Assuming delete_form is passed for CSRF #}
                            <button type="button" class="adw-button destructive-action compact open-delete-comment-dialog-btn" data-comment-id="{{ comment.id }}">Delete Comment</button>
                        </form>
                    {% endif %}
                </article>
                {% endfor %}
            </div>
        {% else %}
            <p class="adw-label body">No comments yet.</p>
        {% endif %}
    </section>

    {# Hidden dialog template for comment deletion, to be cloned by JS #}
    <template id="delete-comment-dialog-template">
        <adw-dialog title="Confirm Comment Deletion">
            <div slot="content">
                <p class="adw-label body">Are you sure you want to delete this comment? This action cannot be undone.</p>
            </div>
            <div slot="buttons">
                <button class="adw-button flat dialog-cancel-btn">Cancel</button>
                <button class="adw-button destructive-action dialog-confirm-delete-comment-btn">Delete</button>
            </div>
        </adw-dialog>
    </template>


    {% if current_user.is_authenticated %}
    <section class="comment-form-section adw-list-box form-section" aria-labelledby="leave-comment-heading">
         <header class="adw-list-box-header">
            <h3 id="leave-comment-heading" class="adw-title-3">Leave a Comment</h3>
        </header>
        <form method="POST" action="{{ url_for('view_post', post_id=post.id) }}" class="stacked-form">
            {{ form.hidden_tag() }} {# Flask-WTF CSRF token #}
            <div class="form-field-row comment-form-field-row {{ 'has-error' if form.text.errors else '' }}"> {# More standard form field structure #}
                 <label for="{{ form.text.id or 'comment_text_input' }}" class="adw-label">{{ form.text.label.text }}</label>
                 <textarea name="{{ form.text.name }}" id="{{ form.text.id or 'comment_text_input' }}" class="adw-entry adw-textarea" rows="4">{{ form.text.data or ''}}</textarea>
            </div>
            {% if form.text.errors %}
            <div class="form-field-error">
                <span class="adw-label caption error-text">{{form.text.errors|join(' ')}}</span>
            </div>
            {% endif %}
            <div class="form-actions-container comment-form-actions">
                 <button type="submit" class="adw-button suggested-action">{{ form.submit.label.text }}</button>
            </div>
        </form>
    </section>
    {% else %}
    <div class="login-prompt-comment">
        <p class="adw-label body"><a href="{{ url_for('login', next=request.url) }}" class="adw-link">Login</a> to leave a comment.</p>
    </div>
    {% endif %}

    {% if related_posts %}
    <section class="related-posts-section related-posts-container" aria-labelledby="related-posts-heading">
        <h2 id="related-posts-heading" class="adw-title-2">Related Posts</h2>
        <div class="adw-list-box">
            {% for related_post in related_posts %}
            <a href="{{ url_for('view_post', post_id=related_post.id) }}" class="adw-action-row activatable">
                <div class="adw-action-row-content">
                    <span class="adw-action-row-title">{{ related_post.title }}</span>
                    {% if related_post.author %}
                    <span class="adw-action-row-subtitle">By {{ related_post.author.username }}</span>
                    {% endif %}
                </div>
                <span class="adw-action-row__chevron"></span>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <div class="adw-box adw-box-spacing-s back-to-posts-container">
         <a href="{{ url_for('index') }}" class="adw-button"><span class="adw-icon icon-actions-go-previous-symbolic"></span> Back to Posts</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Post Deletion Dialog
    const deletePostDialogEl = document.getElementById('delete-confirm-dialog');
    const openDeletePostDialogBtn = document.getElementById('open-delete-dialog-btn');
    const cancelDeletePostBtn = document.getElementById('cancel-delete-btn');
    // const confirmDeletePostBtn = document.getElementById('confirm-delete-btn'); // Form submission handles this

    if (openDeletePostDialogBtn && deletePostDialogEl) {
        openDeletePostDialogBtn.addEventListener('click', (event) => {
            event.preventDefault();
            deletePostDialogEl.open();
        });
    }

    if (cancelDeletePostBtn && deletePostDialogEl) {
        cancelDeletePostBtn.addEventListener('click', () => {
            deletePostDialogEl.close();
        });
    }
    // No special listener for confirmDeletePostBtn needed if it's type="submit" for the form.
    // The dialog will close on form submission due to page navigation.

    // Comment Deletion Dialogs
    const commentDeleteDialogTemplate = document.getElementById('delete-comment-dialog-template');

    document.querySelectorAll('.open-delete-comment-dialog-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const commentId = this.dataset.commentId;
            const formToSubmit = document.querySelector(`.delete-comment-form[data-comment-id="${commentId}"]`);

            if (!formToSubmit) {
                console.error('Could not find delete form for comment ID:', commentId);
                return;
            }

            // Clone the dialog from template
            const dialogClone = commentDeleteDialogTemplate.content.firstElementChild.cloneNode(true);
            document.body.appendChild(dialogClone); // Append to body so it can be shown

            // Handle cancel
            dialogClone.querySelector('.dialog-cancel-btn').addEventListener('click', () => {
                dialogClone.close();
                dialogClone.remove(); // Clean up
            });

            // Handle confirm
            dialogClone.querySelector('.dialog-confirm-delete-comment-btn').addEventListener('click', () => {
                formToSubmit.submit(); // Submit the specific form
                dialogClone.close();
                dialogClone.remove(); // Clean up (though page will likely reload)
            });

            dialogClone.addEventListener('close', () => { // Ensure removal on any close type
                dialogClone.remove();
            });

            dialogClone.open();
        });
    });
});
</script>
{% endblock %}
