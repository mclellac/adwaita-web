{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="main-content-clamped post-view-container">
    <h1>{{ post.title }}</h1>

    <div class="post-meta-detail" style="margin-bottom: var(--spacing-l); color: var(--secondary-text-color);">
        <p style="margin-bottom: var(--spacing-xxs);">By: {{ post.author.username if post.author else 'Unknown Author' }}</p>
        <p style="font-size: 0.9em;">
            <small>Posted on: {{ post.created_at.strftime('%Y-%m-%d %H:%M') if post.created_at else 'N/A' }} UTC</small>
            {% if post.updated_at and post.updated_at != post.created_at %}
                <br><small>(Last updated: {{ post.updated_at.strftime('%Y-%m-%d %H:%M') if post.updated_at else 'N/A' }} UTC)</small>
            {% endif %}
        </p>
    </div>

    <div class="post-content" style="margin-bottom: var(--spacing-xl); white-space: pre-wrap;">
        {{ post.content | safe }}
    </div>

    {% if post.author == current_user %}
    <div class="form-button-container" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-l);"> {# Re-using form-button-container for consistency #}
        <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" id="delete-post-form" style="display: inline;">
            <adw-button id="open-delete-dialog-btn" appearance="destructive">Delete Post</adw-button>
        </form>
        <adw-button href="{{ url_for('edit_post', post_id=post.id) }}">Edit Post</adw-button>
    </div>

    <adw-dialog id="delete-confirm-dialog" title="Confirm Deletion">
        <div slot="content">
            <p>Are you sure you want to delete this post? This action cannot be undone.</p>
        </div>
        <div slot="actions">
            <adw-button id="cancel-delete-btn" appearance="flat">Cancel</adw-button>
            <adw-button id="confirm-delete-btn" appearance="destructive">Delete</adw-button>
        </div>
    </adw-dialog>
    {% endif %}

    <div class="adw-box justify-center" style="margin-top: var(--spacing-l);">
         <adw-button href="{{ url_for('index') }}">Back to Posts</adw-button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const deleteDialog = document.getElementById('delete-confirm-dialog');
    const openDialogBtn = document.getElementById('open-delete-dialog-btn');
    const cancelBtn = document.getElementById('cancel-delete-btn');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const deleteForm = document.getElementById('delete-post-form');

    if (openDialogBtn) { // Only if the delete button is present (post author is current user)
        openDialogBtn.addEventListener('click', () => {
            if (deleteDialog && typeof deleteDialog.showModal === 'function') {
                deleteDialog.showModal();
            } else {
                console.error('Delete dialog not found or showModal not supported.');
            }
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            if (deleteDialog && typeof deleteDialog.close === 'function') {
                deleteDialog.close();
            }
        });
    }

    if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
            if (deleteDialog && typeof deleteDialog.close === 'function') {
                deleteDialog.close();
            }
            if (deleteForm) {
                deleteForm.submit();
            } else {
                console.error('Delete form not found.');
            }
        });
    }
});
</script>
{% endblock %}
