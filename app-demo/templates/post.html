{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<adw-clamp max-width="800px" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
    <article class="post-article">
        <header style="margin-bottom: var(--spacing-l);">
            <h1>{{ post.title }}{% if not post.is_published and current_user == post.author %} <span style="color: var(--secondary-text-color); font-size: var(--font-size-large);">(Draft)</span>{% endif %}</h1>
            <div class="post-meta-detail" style="color: var(--secondary-text-color); font-size: var(--font-size-small);">
                <p style="margin-bottom: var(--spacing-xxs);">
                    By: <a href="{{ url_for('profile', username=post.author.username) }}">{{ post.author.username if post.author else 'Unknown Author' }}</a>
                    {% if post.is_published and post.published_at %}
                        on <time datetime="{{ post.published_at.isoformat() }}">{{ post.published_at.strftime('%Y-%m-%d %H:%M') }} UTC</time> (Published)
                    {% else %}
                         (Draft created: <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>)
                    {% endif %}
                </p>
                {% if post.updated_at and post.updated_at != post.created_at and (post.published_at is none or post.updated_at != post.published_at) %}
                    <p><small>(Last updated: <time datetime="{{ post.updated_at.isoformat() }}">{{ post.updated_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>)</small></p>
                {% endif %}
            </div>

            {% if post.categories %}
            <div class="post-categories" style="margin-top: var(--spacing-s); display:flex; flex-wrap:wrap; gap:var(--spacing-xs); align-items:center;">
                <adw-label is_body="true"><strong>Categories:</strong></adw-label>
                {% for category in post.categories %}
                    <adw-button flat class="small" href="{{ url_for('posts_by_category', category_slug=category.slug) }}">{{ category.name }}</adw-button>
                {% endfor %}
            </div>
            {% endif %}

            {% if post.tags %}
            <div class="post-tags" style="margin-top: var(--spacing-xs); display:flex; flex-wrap:wrap; gap:var(--spacing-xs); align-items:center;">
                <adw-label is_body="true"><strong>Tags:</strong></adw-label>
                {% for tag in post.tags %}
                  <adw-button flat class="small" href="{{ url_for('posts_by_tag', tag_slug=tag.slug) }}">{{ tag.name }}</adw-button>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <div class="post-content" style="margin-top: var(--spacing-l); margin-bottom: var(--spacing-xl); line-height: 1.7;">
            {{ post.content | safe }}
        </div>

        {% if post.author %}
        <div class="author-bio-section" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-xl); padding: var(--spacing-l); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); background-color: var(--window-bg-color); box-shadow: var(--box-shadow-sm);">
            <h3 style="margin-top:0; margin-bottom:var(--spacing-m);">About {{ post.author.full_name or post.author.username }}</h3>
            <adw-box orientation="horizontal" spacing="m" style="align-items: flex-start;">
                <adw-avatar size="64"
                            image-src="{{ url_for('static', filename=post.author.profile_photo_url) if post.author.profile_photo_url else url_for('static', filename='img/default_avatar.png') }}"
                            text="{{ post.author.username[0]|upper if post.author.username else 'A' }}">
                </adw-avatar>
                <div style="display:flex; flex-direction: column; flex-grow:1;">
                    {% if post.author.profile_info %}
                    <p class="author-bio-text" style="font-size: var(--font-size-body); color: var(--window-fg-color); margin-top: 0; margin-bottom:var(--spacing-s); white-space: pre-wrap;">
                        {{ post.author.profile_info | safe }}
                    </p>
                    {% else %}
                    <p style="font-size: var(--font-size-body); color: var(--secondary-text-color); margin-top:0;">This author has not provided a bio yet.</p>
                    {% endif %}
                    <adw-button flat href="{{ url_for('profile', username=post.author.username) }}" style="align-self: flex-start; margin-top: var(--spacing-s);">View Profile of {{ post.author.username }}</adw-button>
                </div>
            </adw-box>
        </div>
        {% endif %}

        <div class="share-buttons-section" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
            <h4 style="margin-bottom: var(--spacing-s);">Share this post:</h4>
            <adw-box orientation="horizontal" spacing="s" style="flex-wrap: wrap; gap: var(--spacing-s);">
                <adw-button
                    href="https://twitter.com/intent/tweet?url={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}&text={{ post.title|urlencode }}"
                    target="_blank" rel="noopener noreferrer"
                    aria-label="Share on Twitter"
                    class="flat">
                    <span slot="label">Twitter</span>
                </adw-button>
                <adw-button
                    href="https://www.facebook.com/sharer/sharer.php?u={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}"
                    target="_blank" rel="noopener noreferrer"
                    aria-label="Share on Facebook"
                    class="flat">
                    <span slot="label">Facebook</span>
                </adw-button>
                <adw-button
                    href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}&title={{ post.title|urlencode }}&summary={{ (post.content|striptags|truncate(120))|urlencode }}"
                    target="_blank" rel="noopener noreferrer"
                    aria-label="Share on LinkedIn"
                    class="flat">
                    <span slot="label">LinkedIn</span>
                </adw-button>
                <adw-button
                    href="mailto:?subject={{ post.title|urlencode }}&body=Check%20out%20this%20post%3A%20{{ request.url_root[:-1] }}{{ url_for('view_post', post_id=post.id) }}"
                    aria-label="Share via Email"
                    class="flat">
                    <span slot="label">Email</span>
                </adw-button>
            </adw-box>
        </div>

        {% if post.author == current_user %}
        <div class="post-actions" style="margin-bottom: var(--spacing-l); display:flex; gap: var(--spacing-s);">
            <adw-button href="{{ url_for('edit_post', post_id=post.id) }}">Edit Post</adw-button>
            {# Delete button triggers dialog; actual form submission is handled by JS #}
            <adw-button id="open-delete-dialog-btn" destructive>Delete Post</adw-button>
        </div>

        <adw-dialog id="delete-confirm-dialog" title="Confirm Deletion">
            <div slot="content">
                <p>Are you sure you want to delete this post? This action cannot be undone.</p>
            </div>
            <div slot="buttons" style="display:flex; gap: var(--spacing-s); justify-content: flex-end;">
                <adw-button id="cancel-delete-btn" class="flat">Cancel</adw-button>
                {# This form is submitted via JS after dialog confirmation #}
                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" id="delete-post-form" style="display: none;">
                    {{ csrf_token() }} {# Explicit CSRF token for non-FlaskForm POST #}
                </form>
                <adw-button id="confirm-delete-btn" class="destructive-action">Delete</adw-button>
            </div>
        </adw-dialog>
        {% endif %}
    </article>

    <hr style="margin: var(--spacing-xl) 0;">

    <section class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" style="margin-bottom:var(--spacing-l);">Comments ({{ comments|length }})</h2>
        {% if comments %}
            <adw-list-box>
                {% for comment in comments %}
                <adw-box orientation="vertical" class="comment-card" style="padding: var(--spacing-m); border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <div style="display:flex; align-items:center; gap:var(--spacing-s);">
                            <adw-avatar text="{{ comment.author.username[0] if comment.author.username else '?' }}" image-src="{{ url_for('static', filename=comment.author.profile_photo_url) if comment.author.profile_photo_url else url_for('static', filename='img/default_avatar.png') }}" size="32"></adw-avatar>
                            <strong><a href="{{ url_for('profile', username=comment.author.username) }}">{{ comment.author.username }}</a></strong>
                        </div>
                        <small class="text-muted" style="font-size: 0.85em; color: var(--secondary-text-color);"><time datetime="{{ comment.created_at.isoformat() }}">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time></small>
                    </div>
                    <p style="white-space: pre-wrap; margin-left: calc(32px + var(--spacing-s)); margin-bottom: var(--spacing-s);">{{ comment.text }}</p>
                    {% if current_user.is_authenticated and (comment.author == current_user or post.author == current_user) %}
                        <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" onsubmit="return confirm('Are you sure you want to delete this comment?');" style="margin-left: calc(32px + var(--spacing-s)); text-align: right;">
                            {{ delete_form.hidden_tag() }} {# CSRF for delete comment form (passed from route) #}
                            <adw-button type="submit" destructive class="compact small">Delete Comment</adw-button>
                        </form>
                    {% endif %}
                </adw-box>
                {% endfor %}
            </adw-list-box>
        {% else %}
            <p>No comments yet.</p>
        {% endif %}
    </section>

    {% if current_user.is_authenticated %}
    <section class="comment-form-section" style="margin-top: var(--spacing-xl;" aria-labelledby="leave-comment-heading">
        <adw-preferences-group title="Leave a Comment" id="leave-comment-heading">
            <form method="POST" action="{{ url_for('view_post', post_id=post.id) }}">
                {{ form.hidden_tag() }} {# CSRF token for comment form #}
                <adw-list-box>
                    <adw-action-row title="{{ form.text.label.text }}">
                         <div slot="suffix" style="width:100%;">
                            {{ form.text(rows="4", class="adw-textarea-standalone", style="width: 100%; min-height: 80px;", id=form.text.id) }}
                         </div>
                    </adw-action-row>
                    {% if form.text.errors %}
                    <adw-action-row class="error-row" subtitle="{{form.text.errors|join(' ')}}"></adw-action-row>
                    {% endif %}
                    <adw-action-row>
                        <div slot="suffix" style="width:100%; display:flex; justify-content:flex-end;">
                             <adw-button type="submit" suggested>{{ form.submit.label.text }}</adw-button>
                        </div>
                    </adw-action-row>
                </adw-list-box>
            </form>
        </adw-preferences-group>
    </section>
    {% else %}
    <div style="margin-top: var(--spacing-xl);">
        <p><a href="{{ url_for('login', next=request.url) }}">Login</a> to leave a comment.</p>
    </div>
    {% endif %}


    <div class="adw-box justify-content-center" style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
         <adw-button href="{{ url_for('index') }}">Back to Posts</adw-button>
    </div>
</adw-clamp>

<script>
// Delete post dialog script remains largely the same.
// Ensure csrf_token() is available for the hidden form if not using Flask-WTF form for delete.
// The current delete_post_form is hidden and submitted by JS.
// It should have a CSRF token if it's a POST request not managed by a FlaskForm object directly.
// Adding {{ csrf_token() }} directly into the hidden form.
document.addEventListener('DOMContentLoaded', () => {
    const deleteDialog = document.getElementById('delete-confirm-dialog');
    const openDialogBtn = document.getElementById('open-delete-dialog-btn');
    const cancelBtn = document.getElementById('cancel-delete-btn');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const deleteForm = document.getElementById('delete-post-form');

    if (openDialogBtn) {
        openDialogBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (deleteDialog && typeof deleteDialog.open === 'function') {
                deleteDialog.open();
            } else {
                console.error('Delete dialog not found or does not have an open method.');
            }
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            if (deleteDialog && typeof deleteDialog.close === 'function') {
                deleteDialog.close();
            }
        });
    }

    if (confirmBtn && deleteForm) { // Ensure deleteForm exists
        confirmBtn.addEventListener('click', () => {
            if (deleteDialog && typeof deleteDialog.close === 'function') {
                deleteDialog.close();
            }
            deleteForm.submit();
        });
    } else if (confirmBtn && !deleteForm) {
         console.error('Delete form (delete-post-form) not found for confirm button.');
    }
});
</script>
{% endblock %}
