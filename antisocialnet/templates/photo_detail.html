{% extends "base.html" %}
{% from "_macros.html" import like_button_and_count %}

{% block page_title %}Photo by {{ photo.author.full_name or ('User ' ~ photo.author.id) }}{% endblock %}

{% block header_title %}Photo by {{ photo.author.full_name or ('User ' ~ photo.author.id) }}{% endblock %}

{% block content %}
<div class="post-view">
    <article class="post-article adw-card blog-content-card">
        <header class="post-header">
            <div class="post-meta-detail">
                <p class="adw-label body">
                    By: <a href="{{ url_for('profile.view_profile', user_id=photo.author.id) }}" class="adw-link">{{ photo.author.full_name or ('User ' ~ photo.author.id) if photo.author else 'Unknown Author' }}</a>&nbsp;
                    on <span class="adw-calendar"><span class="adw-icon icon-x-office-calendar-symbolic"></span><time datetime="{{ photo.uploaded_at.isoformat() }}">{{ photo.uploaded_at | human_readable_date }}</time></span>
                </p>
            </div>
        </header>

        <div class="post-content styled-text-content">
            <img src="{{ url_for('static', filename=photo.image_filename) }}" alt="{{ photo.caption or 'User photo' }}" style="max-width: 100%; height: auto;"/>
            {% if photo.caption %}
                <p>{{ photo.caption }}</p>
            {% endif %}
        </div>

        <footer class="adw-card__actions post-interaction-footer" style="padding-top: var(--spacing-m); margin-top: var(--spacing-m); border-top: 1px solid var(--border-color);">
            {{ like_button_and_count(photo, 'photo', current_user) }}
        </footer>

        {% if photo.author %}
        <section class="author-bio-section adw-card">
            <h3 class="adw-title-3">About {{ photo.author.full_name or ('User ' ~ photo.author.id) }}</h3>
            <div class="adw-box adw-box-spacing-m author-bio-content">
                <span class="adw-avatar size-large">
                     {% set author_avatar = url_for('static', filename=photo.author.profile_photo_url) if photo.author.profile_photo_url else default_avatar_url %}
                     <img src="{{ author_avatar }}" alt="{{ photo.author.full_name or ('User ' ~ photo.author.id) }} avatar" class="adw-avatar__image">
                </span>
                <div class="author-bio-text-content">
                    {% if photo.author.profile_info %}
                    <p class="adw-label body author-bio-text">
                        {{ photo.author.profile_info | safe }}
                    </p>
                    {% else %}
                    <p class="adw-label body author-bio-text-placeholder">This author has not provided a bio yet.</p>
                    {% endif %}
                    <a href="{{ url_for('profile.view_profile', user_id=photo.author.id) }}" class="adw-button flat view-profile-button">View Profile of {{ photo.author.full_name or ('User ' ~ photo.author.id) }}</a>
                </div>
            </div>
        </section>
        {% endif %}
    </article>

    <hr class="section-divider">

    {# Macro to render a single comment and its replies recursively #}
    {% macro render_comment_with_replies(comment, photo, delete_comment_form, current_user, form, is_reply=false) %}
    <div class="comment-item {% if is_reply %}comment-reply-item{% else %}comment-top-level-item{% endif %}"
         id="comment-{{ comment.id }}"
         {% if is_reply %}style="margin-left: 30px; margin-top: var(--spacing-s); padding-top: var(--spacing-s); border-top: 1px dashed var(--divider-color);"{% endif %}>

        <header class="comment-header adw-box adw-box-spacing-s comment-header-box">
            <span class="adw-avatar size-medium">
               {% set comment_avatar = url_for('static', filename=comment.author.profile_photo_url) if comment.author.profile_photo_url else default_avatar_url %}
               <img src="{{ comment_avatar }}" alt="{{ comment.author.full_name or ('User ' ~ comment.author.id) }} avatar" class="adw-avatar__image">
            </span>
            <div class="comment-author-meta">
                 <a href="{{ url_for('profile.view_profile', user_id=comment.author.id) }}" class="adw-link comment-author-link-strong">{{ comment.author.full_name or ('User ' ~ comment.author.id) }}</a>
                <small class="adw-label caption comment-timestamp"><time datetime="{{ comment.created_at.isoformat() }}">{{ comment.created_at | human_readable_date }}</time></small>
            </div>
        </header>
        <div class="comment-text styled-text-content">{{ comment.text | markdown }}</div>

        <div class="comment-actions adw-box adw-box-horizontal adw-box-spacing-s align-center">
            {% if current_user.is_authenticated %}
            <button class="adw-button flat compact reply-button" data-comment-id="{{ comment.id }}" data-comment-author="{{ (comment.author.full_name or ('User ' ~ comment.author.id)) | e }}">Reply</button>
            {% endif %}
            {{ like_button_and_count(comment, 'photocomment', current_user) }}

            {% if current_user.is_authenticated and (comment.author == current_user or photo.author == current_user or current_user.is_admin) %}
            <form method="POST" action="{{ url_for('photo.delete_photo_comment', comment_id=comment.id) }}" style="display: inline;" class="comment-delete-form" id="delete-comment-form-{{ comment.id }}">
                {{ delete_comment_form.hidden_tag() }}
                <button type="button" class="adw-button destructive-action compact comment-delete-button" data-form-id="delete-comment-form-{{ comment.id }}" data-comment-id="{{ comment.id }}">Delete</button>
            </form>
            {% endif %}
        </div>
        <div class="reply-form-container" id="reply-form-for-{{ comment.id }}" style="display: none; margin-top: var(--spacing-s);">
        </div>

        {% if comment.replies | length > 0 %}
            <div class="comment-replies-container" style="margin-top: var(--spacing-s);">
                {% for reply_comment in comment.replies %}
                    {{ render_comment_with_replies(reply_comment, photo, delete_comment_form, current_user, form, is_reply=true) }}
                {% endfor %}
            </div>
        {% endif %}
    </div>
    {% endmacro %}

    <section class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" class="adw-title-2">Comments ({{ photo.comments.count() }})</h2>
        {% if photo.comments.first() %}
            <div class="adw-list-box comments-list flat">
                {% for comment in photo.comments %}
                    <article class="adw-card comment-card" id="comment-card-for-{{ comment.id }}">
                        {{ render_comment_with_replies(comment, photo, delete_comment_form, current_user, form, is_reply=false) }}
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <p class="adw-label body">No comments yet.</p>
        {% endif %}
    </section>

    {% if current_user.is_authenticated %}
    <section class="comment-form-section adw-list-box form-section" aria-labelledby="leave-comment-heading" style="margin-top: var(--spacing-l);">
         <header class="adw-list-box-header">
            <h3 id="leave-comment-heading" class="adw-title-3">Leave a Comment</h3>
        </header>
        <form method="POST" action="{{ url_for('photo.view_photo_detail', photo_id=photo.id) }}" class="stacked-form" id="main-comment-form" style="padding: var(--spacing-m);">
            {{ comment_form.hidden_tag() }}
            {{ comment_form.parent_id(id="main_parent_id_input", type="hidden") }}

            <div class="adw-action-row column-layout {{ 'has-error' if comment_form.text.errors else '' }}">
                <label for="{{ comment_form.text.id or 'comment_text_input' }}" class="adw-action-row-title" style="margin-bottom: var(--spacing-xs);">{{ comment_form.text.label.text }}</label>
                {% if comment_form.text.errors %}
                    <span class="adw-action-row-subtitle error-text" style="margin-bottom: var(--spacing-xs);">{{comment_form.text.errors|join(' ')}}</span>
                {% endif %}
                <textarea name="{{ comment_form.text.name }}" id="{{ comment_form.text.id or 'comment_text_input' }}" class="adw-entry" rows="4" style="width: 100%; min-height: 80px; box-sizing: border-box;" placeholder="Enter your comment here...">{{ comment_form.text.data or ''}}</textarea>
            </div>

            <div class="form-actions-container form-actions-end comment-form-actions adw-box adw-box-horizontal adw-box-spacing-s justify-end" style="margin-top: var(--spacing-m); padding: 0;">
                 <button type="submit" class="adw-button suggested-action" id="main-comment-submit-button">{{ comment_form.submit.label.text }}</button>
                 <span class="adw-spinner small" id="main-comment-spinner" style="display: none;"></span>
            </div>
        </form>
    </section>
    {% else %}
    <div class="login-prompt-comment">
        <p class="adw-label body"><a href="{{ url_for('auth.login', next=request.url) }}" class="adw-link">Login</a> to leave a comment.</p>
    </div>
    {% endif %}

    <div class="adw-box adw-box-spacing-s back-to-posts-container">
         <a href="{{ url_for('profile.view_gallery', user_id=photo.author.id) }}" class="adw-button"><span class="adw-icon icon-actions-go-previous-symbolic"></span> Back to Gallery</a>
    </div>
</div>
{% endblock %}
