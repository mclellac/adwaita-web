{% extends "base.html" %}

{% block title %}Post{% endblock %}

{% block header_title %}Post{% endblock %}

{% block content %}
<div class="post-view">
    <div id="post-container"></div>
    <div id="comments-container" class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" class="adw-title-2">Comments</h2>
        <div id="comments-list" class="adw-list-box comments-list flat"></div>
    </div>
    <div id="loading-indicator" class="adw-status-page">
        <adw-spinner size="l" active></adw-spinner>
        <h3 class="adw-status-page-title">Loading...</h3>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const postContainer = document.getElementById('post-container');
        const commentsContainer = document.getElementById('comments-container');
        const commentsList = document.getElementById('comments-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        const postId = window.location.pathname.split('/').pop();

        async function fetchPostAndComments() {
            loadingIndicator.style.display = 'block';
            postContainer.innerHTML = '';
            commentsList.innerHTML = '';

            try {
                const postResponse = await fetch(`/api/v1/item/post/${postId}`);
                if (!postResponse.ok) {
                    throw new Error('Failed to fetch post');
                }
                const postData = await postResponse.json();
                renderPost(postData);

                const commentsResponse = await fetch(`/api/v1/item/post/${postId}/comments`);
                if (!commentsResponse.ok) {
                    throw new Error('Failed to fetch comments');
                }
                const commentsData = await commentsResponse.json();
                renderComments(commentsData.comments);

            } catch (error) {
                console.error('Error fetching data:', error);
                postContainer.innerHTML = '<p>Error loading post. Please try again later.</p>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderPost(post) {
            const article = document.createElement('article');
            article.className = 'post-article adw-card blog-content-card';

            let content = `
                <header class="post-header">
                    <div class="post-meta-detail">
                        <p class="adw-label body">
                            By: <a href="/profile/${post.actor.id}" class="adw-link">${post.actor.full_name}</a>
                            on <time datetime="${post.timestamp}">${new Date(post.timestamp).toLocaleString()}</time>
                        </p>
                    </div>
                    <div class="post-terms post-categories">
                        <strong class="adw-label caption post-meta-terms-label">Categories:</strong>
                        ${post.data.categories.map(c => `<a href="/posts/category/${c.slug}" class="adw-button flat compact">${c.name}</a>`).join('')}
                    </div>
                    <div class="post-terms post-tags">
                        <strong class="adw-label caption post-meta-terms-label">Tags:</strong>
                        ${post.data.tags.map(t => `<a href="/posts/tag/${t.slug}" class="adw-button flat compact tag-pill">${t.name}</a>`).join('')}
                    </div>
                </header>
                <div class="post-content styled-text-content">
                    ${post.data.content_html_preview}
                </div>
                <footer class="adw-card__actions post-interaction-footer" style="padding-top: var(--spacing-m); margin-top: var(--spacing-m); border-top: 1px solid var(--border-color);">
                    <adw-like-button item-id="${post.data.post_id}" item-type="post" initial-liked="${post.data.is_liked_by_current_user}" initial-like-count="${post.data.like_count}"></adw-like-button>
                </footer>
            `;
            article.innerHTML = content;
            postContainer.appendChild(article);
        }

        function renderComments(comments) {
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="adw-label body">No comments yet.</p>';
                return;
            }

            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.id = `comment-${comment.data.comment_id}`;

                let content = `
                    <header class="comment-header adw-box adw-box-spacing-s comment-header-box">
                        <span class="adw-avatar size-medium">
                           <img src="${comment.actor.profile_photo_url}" alt="${comment.actor.full_name} avatar" class="adw-avatar__image">
                        </span>
                        <div class="comment-author-meta">
                             <a href="/profile/${comment.actor.id}" class="adw-link comment-author-link-strong">${comment.actor.full_name}</a>
                            <small class="adw-label caption comment-timestamp"><time datetime="${comment.timestamp}">${new Date(comment.timestamp).toLocaleString()}</time></small>
                        </div>
                    </header>
                    <div class="comment-text styled-text-content">${comment.data.text_html}</div>
                    <div class="comment-actions adw-box adw-box-horizontal adw-box-spacing-s align-center">
                        <adw-like-button item-id="${comment.data.comment_id}" item-type="comment" initial-liked="${comment.data.is_liked_by_current_user}" initial-like-count="${comment.data.like_count}"></adw-like-button>
                    </div>
                `;
                commentDiv.innerHTML = content;
                commentsList.appendChild(commentDiv);
            });
        }

        fetchPostAndComments();
    });
</script>
{% endblock %}
