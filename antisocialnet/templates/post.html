{% extends "base.html" %}
{% from "_macros.html" import like_button_and_count, render_comment_with_replies %}

{% block page_title %}Post by {{ post.author.full_name or ('User ' ~ post.author.id) }}{% endblock %}

{% block header_title %}Post by {{ post.author.full_name or ('User ' ~ post.author.id) }}{% endblock %}

{% block content %}
<div class="adw-clamp">
    <div class="adw-card">
        <div class="adw-card-header">
            <h1 class="adw-title-1">{{ post.title }}</h1>
            <div class="adw-subtitle">
                By: <a href="{{ url_for('profile.view_profile', user_id=post.author.id) }}">{{ post.author.full_name or ('User ' ~ post.author.id) if post.author else 'Unknown Author' }}</a>
                on {{ post.created_at.strftime('%B %d, %Y') }}
            </div>
        </div>
        <div class="adw-card-content">
            {{ post.content | markdown }}
        </div>
    </div>

    <div class="adw-box" style="margin-top: 1rem;">
        {{ like_button_and_count(post, 'post', current_user) }}
        <form method="POST" action="{{ url_for('repost.repost_post_route', post_id=post.id) }}" style="display: inline;">
            <button type="submit" class="adw-button flat compact">
                <span class="adw-icon icon-actions-find-and-replace-symbolic"></span>
                <span class="adw-label caption">{{ post.repost_count }}</span>
            </button>
        </form>
    </div>

    {% if post.author == current_user %}
    <div class="adw-box" style="margin-top: 1rem;">
        <a href="{{ url_for('post.edit_post', post_id=post.id) }}" class="adw-button">Edit Post</a>
        <button id="open-delete-dialog-btn" class="adw-button destructive-action">Delete Post</button>
    </div>

    <adw-dialog id="delete-confirm-dialog" title="Confirm Deletion">
        <div slot="content">
            <p>Are you sure you want to delete this post? This action cannot be undone.</p>
        </div>
        <div slot="footer">
            <button id="cancel-delete-btn" class="adw-button flat">Cancel</button>
            <form method="POST" action="{{ url_for('post.delete_post', post_id=post.id) }}" style="display: inline;">
                {{ delete_post_form.hidden_tag() }}
                <button type="submit" class="adw-button destructive-action">Delete</button>
            </form>
        </div>
    </adw-dialog>
    {% endif %}

    <hr style="margin: 2rem 0;">

    <h2 class="adw-title-2">Comments ({{ post.comments.count() }})</h2>
    {% if post.comments.first() %}
        <div class="adw-list-box">
            {% for comment in post.comments %}
                {{ render_comment_with_replies(comment, post, delete_comment_form, flag_comment_form, current_user, form, is_reply=false) }}
            {% endfor %}
        </div>
    {% else %}
        <p>No comments yet.</p>
    {% endif %}

    {% if current_user.is_authenticated %}
    <div class="adw-list-box" style="margin-top: 1rem;">
        <div class="adw-list-box-header">
            <h3 class="adw-title-3">Leave a Comment</h3>
        </div>
        <form method="POST" action="{{ url_for('post.view_post', post_id=post.id) }}" style="padding: 1rem;">
            {{ form.hidden_tag() }}
            {{ form.parent_id(id="main_parent_id_input", type="hidden") }}

            <div class="adw-entry-row">
                {{ form.text.label }}
                {{ form.text(class="adw-entry", rows="4") }}
                {% if form.text.errors %}
                    <div class="adw-subtitle" style="color: var(--destructive-color);">{{form.text.errors|join(' ')}}</div>
                {% endif %}
            </div>

            <div class="adw-box" style="margin-top: 1rem;">
                 <button type="submit" class="adw-button suggested-action">{{ form.submit.label.text }}</button>
            </div>
        </form>
    </div>
    {% else %}
    <p><a href="{{ url_for('auth.login', next=request.url) }}">Login</a> to leave a comment.</p>
    {% endif %}

    {% if related_posts %}
    <h2 class="adw-title-2" style="margin-top: 2rem;">Related Posts</h2>
    <div class="adw-list-box">
        {% for related_post in related_posts %}
        <a href="{{ url_for('post.view_post', post_id=related_post.id) }}" class="adw-action-row">
            <div class="adw-action-row-text-content">
                <span class="adw-action-row-title">{{ related_post.title }}</span>
                <span class="adw-action-row-subtitle">{{ related_post.content | striptags | truncate(80) }}</span>
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <div class="adw-box" style="margin-top: 2rem;">
         <a href="{{ url_for('general.index') }}" class="adw-button"><span class="adw-icon icon-actions-go-previous-symbolic"></span> Back to Posts</a>
    </div>

    <adw-dialog id="delete-comment-confirm-dialog" title="Confirm Comment Deletion">
        <div slot="content">
            <p>Are you sure you want to delete this comment? This action cannot be undone.</p>
        </div>
        <div slot="footer">
            <button id="cancel-comment-delete-btn" class="adw-button flat">Cancel</button>
            <form method="POST" action="" id="confirm-delete-comment-form-actual" style="display: inline;">
                 {{ delete_comment_form.hidden_tag() }}
                <button id="confirm-comment-delete-btn" type="submit" class="adw-button destructive-action">Delete Comment</button>
            </form>
        </div>
    </adw-dialog>
</div>

<script>
// Threaded comments reply script & post/comment dialog logic is now primarily handled by app-layout.js
// Any page-specific variations or initializations needed beyond global handlers can go here.
// For post.html, the dialogs (delete post, delete comment) are expected to be handled by app-layout.js.

document.addEventListener('DOMContentLoaded', () => {
    // Specific logic for comment deletion dialog on this page, if different from global app-layout.js
    // This example assumes app-layout.js handles the #delete-comment-confirm-dialog
    // and its trigger buttons (.comment-delete-button) correctly.
    // If post.html's comment deletion needs unique handling not covered by app-layout's generic setup, add here.
    // For now, we assume app-layout.js covers it.

    // Threaded comments reply script
    const mainCommentForm = document.getElementById('main-comment-form');
    if (!mainCommentForm) return; // If no comment form, do nothing

    const mainParentIdInput = document.getElementById('main_parent_id_input');
    const mainCommentTextArea = mainCommentForm.querySelector('textarea[name="text"]');
    const mainCommentSubmitButton = mainCommentForm.querySelector('button[type="submit"]');
    const mainCommentLabel = mainCommentForm.querySelector('label[for="' + (mainCommentTextArea ? mainCommentTextArea.id : '') + '"]');
    const originalFormContainer = mainCommentForm.parentElement; // Store original parent

    document.querySelectorAll('.reply-button').forEach(button => {
        button.addEventListener('click', () => {
            const commentId = button.dataset.commentId;
            const commentAuthor = button.dataset.commentAuthor || 'user';
            const replyFormContainer = document.getElementById(`reply-form-for-${commentId}`);

            if (!replyFormContainer) return;

            // Detach form from current parent before appending to new one
            if (mainCommentForm.parentElement) {
                mainCommentForm.parentElement.removeChild(mainCommentForm);
            }

            replyFormContainer.appendChild(mainCommentForm);
            if(mainParentIdInput) mainParentIdInput.value = commentId;
            if(mainCommentSubmitButton) mainCommentSubmitButton.textContent = 'Post Reply';
            if(mainCommentLabel) mainCommentLabel.textContent = `Reply to ${commentAuthor}`;
            if(mainCommentTextArea) {
                mainCommentTextArea.placeholder = `Replying to ${commentAuthor}...`;
                mainCommentTextArea.focus();
            }
            replyFormContainer.style.display = 'block';

            // Hide other reply forms that might have been opened
            document.querySelectorAll('.reply-form-container').forEach(container => {
                if (container.id !== replyFormContainer.id) {
                    container.style.display = 'none';
                    // Do not clear their content if they didn't have the main form
                }
            });
        });
    });

    // Logic to move the form back if user clicks the main "Leave a Comment" section header
    const mainCommentSectionHeader = document.getElementById('leave-comment-heading');
    if(mainCommentSectionHeader && originalFormContainer) {
        mainCommentSectionHeader.addEventListener('click', (event) => {
            // Prevent if the click is on the form itself if it's already there
            if (originalFormContainer.contains(event.target) && event.target !== mainCommentSectionHeader) {
                return;
            }

            if (mainCommentForm.parentElement !== originalFormContainer) {
                if (mainCommentForm.parentElement) { // Detach if attached elsewhere
                    mainCommentForm.parentElement.removeChild(mainCommentForm);
                }
                originalFormContainer.appendChild(mainCommentForm);
                if(mainParentIdInput) mainParentIdInput.value = '';
                if(mainCommentSubmitButton) mainCommentSubmitButton.textContent = 'Post Comment';
                if(mainCommentLabel) mainCommentLabel.textContent = 'Comment';
                if(mainCommentTextArea) mainCommentTextArea.placeholder = 'Enter your comment here...';

                document.querySelectorAll('.reply-form-container').forEach(container => {
                    container.style.display = 'none';
                });
            }
        });
    }

    // Main comment form spinner
    const mainCommentSubmitButtonElement = document.getElementById('main-comment-submit-button');
    const mainCommentSpinnerElement = document.getElementById('main-comment-spinner');

    if (mainCommentForm && mainCommentSubmitButtonElement && mainCommentSpinnerElement) { // mainCommentForm already defined above
        mainCommentForm.addEventListener('submit', function() {
            // Check if the event target is the main form, not a reply form if it got moved.
            // This is important because the same form element is moved around.
            // The listener is on mainCommentForm, so it will always fire for this form.
            mainCommentSubmitButtonElement.disabled = true;
            mainCommentSpinnerElement.style.display = 'inline-block';
        });
    }
});
</script>
{% endblock %}
