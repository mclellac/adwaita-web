{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block header_title %}Post{% endblock %}

{% block content %}
<div class="post-view">
    <article class="post-article adw-card blog-content-card">
        <header class="post-header">
            <h1 class="adw-title-1">{{ post.title }}</h1>
            <div class="post-meta-detail">
                <p class="adw-label body">
                    By: <a href="{{ url_for('profile.view_profile', user_id=post.author.id) }}" class="adw-link">{{ post.author.full_name }}</a>
                    on <time datetime="{{ post.created_at.isoformat() }}">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</time>
                </p>
            </div>
            {% if post.categories %}
            <div class="post-terms post-categories">
                <strong class="adw-label caption post-meta-terms-label">Categories:</strong>
                {% for category in post.categories %}
                    <a href="{{ url_for('post.posts_by_category', category_slug=category.slug) }}" class="adw-button flat compact">{{ category.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
            {% if post.tags %}
            <div class="post-terms post-tags">
                <strong class="adw-label caption post-meta-terms-label">Tags:</strong>
                {% for tag in post.tags %}
                    <a href="{{ url_for('post.posts_by_tag', tag_slug=tag.slug) }}" class="adw-button flat compact tag-pill">{{ tag.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </header>
        <div class="post-content styled-text-content">
            {{ post.content_html | safe }}
        </div>
        <footer class="adw-card__actions post-interaction-footer" style="padding-top: var(--spacing-m); margin-top: var(--spacing-m); border-top: 1px solid var(--border-color);">
            <adw-like-button item-id="{{ post.id }}" item-type="post" initial-liked="{{ current_user.has_liked_item('post', post.id) }}" initial-like-count="{{ post.likes.count() }}"></adw-like-button>
        </footer>
    </article>

    <div id="comments-container" class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" class="adw-title-2">Comments</h2>
        <div id="comments-list" class="adw-list-box comments-list flat">
            {% for comment in post.comments | sort(attribute='created_at') %}
                {% if not comment.parent_id %}
                    {% include '_comment.html' %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div id="comment-form-container" class="comment-form-section">
        <h2 class="adw-title-2">Leave a Comment</h2>
        <form id="comment-form" method="POST" action="{{ url_for('post.view_post', post_id=post.id) }}">
            {{ form.hidden_tag() }}
            {{ form.parent_id }}
            <div class="form-group">
                {{ form.text(class="adw-textarea", rows="4", placeholder="Write a comment...") }}
            </div>
            <button type="submit" class="adw-button suggested-action">Submit</button>
        </form>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.reply-button').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const username = this.dataset.username;
            const formContainer = document.getElementById(`reply-form-container-${commentId}`);

            if (formContainer.style.display === 'none') {
                // Hide any other open reply forms
                document.querySelectorAll('.reply-form-container').forEach(container => {
                    container.style.display = 'none';
                    container.innerHTML = '';
                });

                formContainer.style.display = 'block';
                formContainer.innerHTML = `
                    <form method="POST" action="{{ url_for('post.view_post', post_id=post.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="parent_id" value="${commentId}">
                        <textarea name="text" class="adw-textarea" rows="3">@${username} </textarea>
                        <div class="adw-box adw-box-horizontal adw-box-spacing-s" style="margin-top: 8px;">
                            <button type="submit" class="adw-button suggested-action">Submit Reply</button>
                            <button type="button" class="adw-button cancel-reply">Cancel</button>
                        </div>
                    </form>
                `;
                formContainer.querySelector('.cancel-reply').addEventListener('click', () => {
                    formContainer.style.display = 'none';
                    formContainer.innerHTML = '';
                });
            } else {
                formContainer.style.display = 'none';
                formContainer.innerHTML = '';
            }
        });
    });

    document.querySelectorAll('.show-replies-button').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const repliesContainer = document.getElementById(`replies-for-${commentId}`);
            if (repliesContainer.style.display === 'none') {
                repliesContainer.style.display = 'block';
                this.textContent = 'Hide replies';
            } else {
                repliesContainer.style.display = 'none';
                this.textContent = `Show replies (${repliesContainer.children.length})`;
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %}
