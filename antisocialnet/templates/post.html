{% extends "base.html" %}

{% block title %}Post{% endblock %}

{% block header_title %}Post{% endblock %}

{% block content %}
<div class="post-view">
    <div id="post-container"></div>
    <div id="comments-container" class="comments-section" aria-labelledby="comments-heading">
        <h2 id="comments-heading" class="adw-title-2">Comments</h2>
        <div id="comments-list" class="adw-list-box comments-list flat"></div>
    </div>
    <div id="loading-indicator" class="adw-status-page">
        <adw-spinner size="l" active></adw-spinner>
        <h3 class="adw-status-page-title">Loading...</h3>
    </div>
    <div id="comment-form-container" class="comment-form-section">
        <h2 class="adw-title-2">Leave a Comment</h2>
        <form id="comment-form" method="POST" action="{{ url_for('post.view_post', post_id=post.id) }}">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.text(class="adw-textarea", rows="4") }}
            </div>
            <button type="submit" class="adw-button suggested-action">Submit</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const postContainer = document.getElementById('post-container');
        const commentsContainer = document.getElementById('comments-container');
        const commentsList = document.getElementById('comments-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        const postId = window.location.pathname.split('/').pop();

        async function fetchPostAndComments() {
            loadingIndicator.style.display = 'block';
            postContainer.innerHTML = '';
            commentsList.innerHTML = '';

            try {
                const postResponse = await fetch(`/api/v1/item/post/${postId}`);
                if (!postResponse.ok) {
                    throw new Error('Failed to fetch post');
                }
                const postData = await postResponse.json();
                renderPost(postData);

                const commentsResponse = await fetch(`/api/v1/item/post/${postId}/comments`);
                if (!commentsResponse.ok) {
                    throw new Error('Failed to fetch comments');
                }
                const commentsData = await commentsResponse.json();
                renderComments(commentsData.comments, postData);

            } catch (error) {
                console.error('Error fetching data:', error);
                postContainer.innerHTML = '<p>Error loading post. Please try again later.</p>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderPost(post) {
            const article = document.createElement('article');
            article.className = 'post-article adw-card blog-content-card';

            let content = `
                <header class="post-header">
                    <div class="post-meta-detail">
                        <p class="adw-label body">
                            By: <a href="/profile/${post.actor.id}" class="adw-link">${post.actor.full_name}</a>
                            on <time datetime="${post.timestamp}">${new Date(post.timestamp).toLocaleString()}</time>
                        </p>
                    </div>
                    <div class="post-terms post-categories">
                        <strong class="adw-label caption post-meta-terms-label">Categories:</strong>
                        ${post.data.categories.map(c => `<a href="/posts/category/${c.slug}" class="adw-button flat compact">${c.name}</a>`).join('')}
                    </div>
                    <div class="post-terms post-tags">
                        <strong class="adw-label caption post-meta-terms-label">Tags:</strong>
                        ${post.data.tags.map(t => `<a href="/posts/tag/${t.slug}" class="adw-button flat compact tag-pill">${t.name}</a>`).join('')}
                    </div>
                </header>
                <div class="post-content styled-text-content">
                    ${post.data.content_html_preview}
                </div>
                <footer class="adw-card__actions post-interaction-footer" style="padding-top: var(--spacing-m); margin-top: var(--spacing-m); border-top: 1px solid var(--border-color);">
                    <adw-like-button item-id="${post.data.post_id}" item-type="post" initial-liked="${post.data.is_liked_by_current_user}" initial-like-count="${post.data.like_count}"></adw-like-button>
                </footer>
            `;
            article.innerHTML = content;
            postContainer.appendChild(article);
        }

        function renderComments(comments, post) {
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="adw-label body">No comments yet.</p>';
                return;
            }

            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.id = `comment-${comment.data.comment_id}`;

                let content = `
                    <header class="comment-header adw-box adw-box-spacing-s comment-header-box">
                        <span class="adw-avatar size-medium">
                           <img src="${comment.actor.profile_photo_url}" alt="${comment.actor.full_name} avatar" class="adw-avatar__image">
                        </span>
                        <div class="comment-author-meta">
                             <a href="/profile/${comment.actor.id}" class="adw-link comment-author-link-strong">${comment.actor.full_name}</a>
                            <small class="adw-label caption comment-timestamp"><time datetime="${comment.timestamp}">${new Date(comment.timestamp).toLocaleString()}</time></small>
                        </div>
                    </header>
                    <div class="comment-text styled-text-content">${comment.data.text_html}</div>
                    <div class="comment-actions adw-box adw-box-horizontal adw-box-spacing-s align-center">
                        <button class="adw-button flat circular reply-button" data-comment-id="${comment.data.comment_id}" data-username="${comment.actor.full_name}"><span class="adw-icon icon-actions-mail-reply-sender-symbolic"></span></button>
                        <a href="/comment/${comment.data.comment_id}/edit" class="adw-button flat circular edit-comment-button" data-comment-id="${comment.data.comment_id}"><span class="adw-icon icon-actions-document-edit-symbolic"></span></a>
                        <form action="/comment/${comment.data.comment_id}/delete" method="post" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="adw-button flat circular" onclick="return confirm('Are you sure you want to delete this comment?');"><span class="adw-icon icon-actions-edit-delete-symbolic"></span></button>
                        </form>
                        <adw-like-button item-id="${comment.data.comment_id}" item-type="comment" initial-liked="${comment.data.is_liked_by_current_user}" initial-like-count="${comment.data.like_count}"></adw-like-button>
                    </div>
                    <div class="reply-form-container" id="reply-form-container-${comment.data.comment_id}" style="display: none; margin-top: 10px;"></div>
                `;
                commentDiv.innerHTML = content;
                commentsList.appendChild(commentDiv);
            });

            document.querySelectorAll('.reply-button').forEach(button => {
                button.addEventListener('click', function() {
                    const commentId = this.dataset.commentId;
                    const username = this.dataset.username;
                    const container = document.getElementById(`reply-form-container-${commentId}`);

                    if (container.style.display === 'none') {
                        container.style.display = 'block';
                        container.innerHTML = `
                            <form action="/posts/${post.data.post_id}" method="POST" class="reply-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="parent_id" value="${commentId}">
                                <textarea name="text" class="adw-textarea" rows="3">@${username} </textarea>
                                <button type="submit" class="adw-button suggested-action">Submit Reply</button>
                                <button type="button" class="adw-button cancel-reply">Cancel</button>
                            </form>
                        `;
                        container.querySelector('.cancel-reply').addEventListener('click', () => {
                            container.style.display = 'none';
                        });
                    } else {
                        container.style.display = 'none';
                    }
                });
            });
        }

        fetchPostAndComments();
    });
</script>
{% endblock %}
