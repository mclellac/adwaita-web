{% extends "base.html" %}

{% block title %}Settings - {{ super() }}{% endblock %}

{% block header_title %}Settings{% endblock %}

{# The headerbar is already in base.html, this specific one can be simplified or removed if base.html's is sufficient #}
{# For now, let's assume base.html handles the main header, and this content block is for the page content itself #}

{% block content %}
<div class="adw-preferences-page" role="main" style="padding-top: var(--spacing-l);"> {# Keep adw-preferences-page, remove its header, add padding if needed #}

    <section class="adw-preferences-group" aria-labelledby="appearance-group-title">
        <div class="adw-preferences-group__title-container">
            <h2 class="adw-preferences-group__title" id="appearance-group-title">Appearance</h2>
        </div>
        <div class="adw-list-box"> {# Rows are typically within a list-box for borders etc. #}
            <div class="adw-combo-row" id="theme-combo-row">
                <div class="adw-combo-row-text-content">
                    <span class="adw-combo-row-title">Theme</span>
                    <span class="adw-combo-row-subtitle">Select your preferred interface theme</span>
                </div>
                <select name="theme" class="adw-combo-row-select">
                    {% set current_theme = current_user.theme or 'system' %}
                    <option value="system" {% if current_theme == 'system' %}selected{% endif %}>System Default</option>
                    <option value="light" {% if current_theme == 'light' %}selected{% endif %}>Light</option>
                    <option value="dark" {% if current_theme == 'dark' %}selected{% endif %}>Dark</option>
                </select>
            </div>

            <div class="adw-combo-row" id="accent-color-combo-row">
                <div class="adw-combo-row-text-content">
                    <span class="adw-combo-row-title">Accent Color</span>
                    <span class="adw-combo-row-subtitle">Choose a site-wide accent color</span>
                </div>
                <select name="accent_color" class="adw-combo-row-select">
                    {% set current_accent = current_user.accent_color or 'default' %}
                    <option value="default" {% if current_accent == 'default' %}selected{% endif %}>Default (Blue)</option>
                    <option value="teal" {% if current_accent == 'teal' %}selected{% endif %}>Teal</option>
                    <option value="green" {% if current_accent == 'green' %}selected{% endif %}>Green</option>
                    <option value="yellow" {% if current_accent == 'yellow' %}selected{% endif %}>Yellow</option>
                    <option value="orange" {% if current_accent == 'orange' %}selected{% endif %}>Orange</option>
                    <option value="red" {% if current_accent == 'red' %}selected{% endif %}>Red</option>
                    <option value="pink" {% if current_accent == 'pink' %}selected{% endif %}>Pink</option>
                    <option value="purple" {% if current_accent == 'purple' %}selected{% endif %}>Purple</option>
                    <option value="slate" {% if current_accent == 'slate' %}selected{% endif %}>Slate</option>
                </select>
            </div>
        </div>
    </section>

    <section class="adw-preferences-group" aria-labelledby="account-group-title">
        <div class="adw-preferences-group__title-container">
            <h2 class="adw-preferences-group__title" id="account-group-title">Account</h2>
        </div>
        <div class="adw-list-box">
            <a href="{{ url_for('auth.change_password_page') }}" class="adw-action-row activatable">
                <div class="adw-action-row-content">
                    <span class="adw-action-row-title">Change Password</span>
                    <span class="adw-action-row-subtitle">Update your account password</span>
                </div>
                <div class="adw-action-row-suffix">
                    <span class="adw-icon-navigation-chevron-right-symbolic"></span>
                </div>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="adw-action-row activatable destructive-action">
                <div class="adw-action-row-content">
                    <span class="adw-action-row-title">Logout</span>
                    <span class="adw-action-row-subtitle">Sign out of your account</span>
                </div>
                <div class="adw-action-row-suffix">
                    <span class="adw-icon-navigation-chevron-right-symbolic"></span>
                </div>
            </a>
        </div>
    </section>

    {% if current_user.is_admin and site_settings_form %}
    <section class="adw-preferences-group" aria-labelledby="site-settings-group-title">
        <div class="adw-preferences-group__title-container">
            <h2 class="adw-preferences-group__title" id="site-settings-group-title">Site Settings (Admin)</h2>
            <p class="adw-preferences-group__description">
                Configure global settings for the application. These settings affect all users.
            </p>
        </div>
        {# The form submission will go to the admin.site_settings endpoint #}
        <form method="POST" action="{{ url_for('admin.site_settings') }}" class="stacked-form" id="site-settings-admin-form" style="padding-top: var(--spacing-s);">
            {{ site_settings_form.hidden_tag() }} {# CSRF token for this specific form #}

            <div class="adw-list-box"> {# Wrap settings in a list-box for consistent styling #}
                {# Site Title #}
                <div class="adw-entry-row {{ 'has-error' if site_settings_form.site_title.errors else '' }}">
                    <label for="{{ site_settings_form.site_title.id or 'site_title_input_admin' }}" class="adw-entry-row-title">{{ site_settings_form.site_title.label.text }}</label>
                    <input type="text" id="{{ site_settings_form.site_title.id or 'site_title_input_admin' }}" name="{{ site_settings_form.site_title.name }}" value="{{ site_settings_form.site_title.data or '' }}" class="adw-entry adw-entry-row-entry" required>
                    {% if site_settings_form.site_title.errors %}
                        <span class="adw-label caption error-text adw-entry-row-subtitle">{{ site_settings_form.site_title.errors|join(' ') }}</span>
                    {% endif %}
                </div>

                {# Posts Per Page - Using adw-spin-row component #}
                {# Note: The adw-spin-row is a custom element, ensure its JS is loaded and it works. #}
                {# For simplicity, if adw-spin-row is problematic, could revert to simple number input. #}
                {# Assuming adw-spin-row correctly uses its name attribute for form submission. #}
                <adw-spin-row title="{{ site_settings_form.posts_per_page.label.text }}"
                              id="{{ site_settings_form.posts_per_page.id or 'posts_per_page_input_admin' }}"
                              name="{{ site_settings_form.posts_per_page.name }}"
                              value="{{ site_settings_form.posts_per_page.data or '10' }}"
                              min="1"
                              max="100"
                              step="1"
                              subtitle="Number of posts to display per page."
                              class="{{ 'has-error' if site_settings_form.posts_per_page.errors else '' }}">
                </adw-spin-row>
                {% if site_settings_form.posts_per_page.errors %}
                <div class="adw-row form-field-error" style="padding-left: var(--spacing-m);"> {# Simple error display for spin-row #}
                    <span class="adw-label caption error-text">{{ site_settings_form.posts_per_page.errors|join(' ') }}</span>
                </div>
                {% endif %}

                {# Allow New User Registrations #}
                <div class="adw-switch-row {{ 'has-error' if site_settings_form.allow_registrations.errors else '' }}">
                     <div class="adw-action-row__text">
                        <label for="{{ site_settings_form.allow_registrations.id or 'allow_registrations_input_admin' }}" class="adw-action-row__title">{{ site_settings_form.allow_registrations.label.text }}</label>
                        <span class="adw-action-row__subtitle">Enable or disable new user sign-ups.</span>
                        {% if site_settings_form.allow_registrations.errors %}
                            <span class="adw-label caption error-text">{{ site_settings_form.allow_registrations.errors|join(' ') }}</span>
                        {% endif %}
                    </div>
                    <div class="adw-switch-row__switch">
                        <label class="adw-switch">
                            <input type="checkbox"
                                   name="{{ site_settings_form.allow_registrations.name }}"
                                   id="{{ site_settings_form.allow_registrations.id or 'allow_registrations_input_admin' }}"
                                   {% if site_settings_form.allow_registrations.data %}checked{% endif %}
                                   >
                            <span class="adw-switch-slider"></span>
                        </label>
                    </div>
                </div>
            </div> {# End adw-list-box for Site Settings #}

            <div class="adw-box horizontal justify-end form-actions-container adw-box-spacing-s" style="margin-top: var(--spacing-l); padding: var(--spacing-m); border-top: 1px solid var(--border-color); background-color: var(--list-row-bg-color);">
                {{ site_settings_form.submit(class="adw-button suggested-action", value="Save Site Settings", id="site-settings-submit-button") }}
                <span class="adw-spinner small" id="site-settings-spinner" style="display: none;"></span>
            </div>
        </form>
    </section>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const themeComboRow = document.getElementById('theme-combo-row');
    const accentComboRow = document.getElementById('accent-color-combo-row');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (themeComboRow) {
        const themeSelect = themeComboRow.querySelector('select.adw-combo-row-select');
        if (themeSelect) {
            themeSelect.addEventListener('change', function() {
                const newTheme = this.value;
                console.log('Theme changed to:', newTheme);

                if (csrfToken) {
                    fetch("{{ url_for('general.save_theme_preference') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ theme: newTheme })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Theme save response:', data);
                        if (data.status === 'success') {
                            if (window.Adw && Adw.createToast) {
                                Adw.createToast(data.message || 'Theme saved! Reloading...', { timeout: 2000 });
                            }
                            setTimeout(() => location.reload(), 500); // Reload after a short delay
                        } else {
                            if (window.Adw && Adw.createToast) {
                                Adw.createToast(data.message || 'Failed to save theme.', { type: 'error' });
                            } else {
                                alert(data.message || 'Failed to save theme.'); // Fallback
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error saving theme:', error);
                        if (window.Adw && Adw.createToast) {
                            Adw.createToast('Error saving theme preference.', { type: 'error' });
                        } else {
                            alert('Error saving theme preference.'); // Fallback
                        }
                    });
                }
            });
        }
    }

    if (accentComboRow) {
        const accentSelect = accentComboRow.querySelector('select.adw-combo-row-select');
        if (accentSelect) {
            accentSelect.addEventListener('change', function() {
                const newAccent = this.value;
                console.log('Accent color changed to:', newAccent);

                if (csrfToken) {
                    fetch("{{ url_for('general.save_accent_color_preference') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ accent_color: newAccent })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Accent save response:', data);
                        if (data.status === 'success') {
                            if (window.Adw && Adw.createToast) {
                                Adw.createToast(data.message || 'Accent color saved! Reloading...', { timeout: 2000 });
                            }
                            setTimeout(() => location.reload(), 500); // Reload after a short delay
                        } else {
                            if (window.Adw && Adw.createToast) {
                                Adw.createToast(data.message || 'Failed to save accent color.', { type: 'error' });
                            } else {
                                alert(data.message || 'Failed to save accent color.'); // Fallback
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error saving accent color:', error);
                        if (window.Adw && Adw.createToast) {
                            Adw.createToast('Error saving accent color preference.', { type: 'error' });
                        } else {
                            alert('Error saving accent color preference.'); // Fallback
                        }
                    });
                }
            });
        }
    }

    // Site Settings form spinner
    const siteSettingsForm = document.getElementById('site-settings-admin-form');
    const siteSettingsSubmitButton = document.getElementById('site-settings-submit-button');
    const siteSettingsSpinner = document.getElementById('site-settings-spinner');

    if (siteSettingsForm && siteSettingsSubmitButton && siteSettingsSpinner) {
        siteSettingsForm.addEventListener('submit', function() {
            siteSettingsSubmitButton.disabled = true;
            siteSettingsSpinner.style.display = 'inline-block';
        });
    }
});
</script>
{% endblock %}
