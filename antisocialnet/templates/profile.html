{% extends "base.html" %}

{% block title %}Profile: {{ user_profile.full_name or ('User ' ~ user_profile.id) }}{% endblock %}

{% block header_title %}{{ user_profile.full_name or ('User ' ~ user_profile.id) }}'s Profile{% endblock %}

{% block header_actions_start %}
    {% if current_user == user_profile %}
        <a href="{{ url_for('profile.edit_profile') }}" class="adw-button suggested-action">Edit Profile</a>
    {% elif current_user.is_authenticated %}
        {% if current_user.is_following(user_profile) %}
            <form action="{{ url_for('profile.unfollow_user', user_id=user_profile.id) }}" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="adw-button">Unfollow</button>
            </form>
        {% else %}
            <form action="{{ url_for('profile.follow_user', user_id=user_profile.id) }}" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="adw-button suggested-action">Follow</button>
            </form>
        {% endif %}
    {% endif %}
{% endblock %}

{% block content %}
<div class="adw-clamp">
    <div class="adw-box" style="align-items: center; gap: 1rem;">
        <div class="adw-avatar size-huge">
            {% if user_profile.profile_photo_url %}
            <img src="{{ url_for('static', filename=user_profile.profile_photo_url) }}" alt="{{ user_profile.full_name or ('User ' ~ user_profile.id) }} avatar">
            {% else %}
            <img src="{{ default_avatar_url }}" alt="{{ user_profile.full_name or ('User ' ~ user_profile.id) }} default avatar">
            {% endif %}
        </div>
        <div>
            <h1 class="adw-title-1">{{ user_profile.full_name or ('User ' ~ user_profile.id) }}</h1>
            <div class="adw-subtitle">@{{ user_profile.full_name or ('User' ~ user_profile.id) }}</div>
            <div class="adw-box" style="gap: 1rem;">
                <a href="{{ url_for('profile.followers_list', user_id=user_profile.id) }}"><strong>{{ user_profile.followers.count() }}</strong> Followers</a>
                <a href="{{ url_for('profile.following_list', user_id=user_profile.id) }}"><strong>{{ user_profile.followed.count() }}</strong> Following</a>
            </div>
        </div>
    </div>

    <div class="adw-preferences-group">
        <div class="adw-preferences-group-title">About</div>
        <div class="adw-list-box">
            <div class="adw-expander-row">
                <div class="adw-action-row">
                    <div class="adw-action-row-text">
                        <div class="adw-action-row-title">Biography</div>
                    </div>
                    <div class="adw-expander-row-icon"></div>
                </div>
                <div class="adw-expander-row-content">
                    {{ user_profile.profile_info | safe }}
                </div>
            </div>
        </div>
    </div>

    <div class="adw-preferences-group">
        <div class="adw-preferences-group-title">Posts</div>
        {% if posts_pagination and posts_pagination.items %}
            <div class="adw-list-box">
                {% for post in posts_pagination.items %}
                <a href="{{ url_for('post.view_post', post_id=post.id) }}" class="adw-action-row">
                    <div class="adw-action-row-text">
                        <div class="adw-action-row-title">{{ post.title }}</div>
                        <div class="adw-action-row-subtitle">{{ post.content | truncate(100) }}</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="adw-status-page">
                <div class="adw-status-page-icon icon-content-document-new-symbolic"></div>
                <div class="adw-status-page-title">No Posts Yet</div>
                <div class="adw-status-page-description">{{ user_profile.full_name or ('User ' ~ user_profile.id) }} has not made any posts.</div>
            </div>
        {% endif %}
    </div>

    <div class="adw-preferences-group">
        <div class="adw-preferences-group-title">Comments</div>
        {% if comments_pagination and comments_pagination.items %}
            <div class="adw-list-box">
                {% for comment in comments_pagination.items %}
                <a href="{{ url_for('post.view_post', post_id=comment.post_id, _anchor='comment-' ~ comment.id) }}" class="adw-action-row">
                    <div class="adw-action-row-text">
                        <div class="adw-action-row-title">Comment on post by {% if comment.post %}{{ comment.post.author.full_name or ('User ' ~ comment.post.author.id) }}{% else %}an unknown user{% endif %}</div>
                        <div class="adw-action-row-subtitle">"{{ comment.text | truncate(100) }}"</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="adw-status-page">
                <div class="adw-status-page-icon icon-content-message-symbolic"></div>
                <div class="adw-status-page-title">No Comments Yet</div>
                <div class="adw-status-page-description">{{ user_profile.full_name or ('User ' ~ user_profile.id) }} has not made any comments.</div>
            </div>
        {% endif %}
    </div>

    <div class="adw-preferences-group">
        <div class="adw-preferences-group-title">Photo Gallery</div>
        {% if current_user == user_profile %}
        <div class="adw-list-box">
            <div class="adw-action-row">
                <div class="adw-action-row-title">Upload New Photo to Gallery</div>
            </div>
            <form method="POST" action="{{ url_for('profile.upload_gallery_photo') }}" enctype="multipart/form-data" style="padding: 1rem;">
                {{ gallery_upload_form.hidden_tag() if gallery_upload_form else '' }}
                <div class="adw-entry-row">
                    {{ gallery_upload_form.photos.label }}
                    {{ gallery_upload_form.photos }}
                </div>
                <div class="adw-entry-row">
                    {{ gallery_upload_form.caption.label }}
                    {{ gallery_upload_form.caption(class="adw-entry", rows="2") }}
                </div>
                <div class="adw-box" style="margin-top: 1rem;">
                    {{ gallery_upload_form.submit(class="adw-button suggested-action") if gallery_upload_form }}
                </div>
            </form>
        </div>
        {% endif %}
        {% set gallery_photos_preview = user_profile.gallery_photos.order_by(UserPhoto.uploaded_at.desc()).limit(6).all() %}
        {% if gallery_photos_preview %}
            <div class="adw-box" style="gap: 1rem; flex-wrap: wrap;">
                {% for photo in gallery_photos_preview %}
                <div class="adw-card" style="width: 200px;">
                    <img src="{{ url_for('static', filename=photo.image_filename) }}" alt="{{ photo.caption or ('Gallery image by ' ~ (user_profile.full_name or ('User ' ~ user_profile.id))) }}" style="width: 100%; height: 150px; object-fit: cover;">
                    <div class="adw-card-content">
                        {{ photo.caption }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="adw-status-page">
                <div class="adw-status-page-icon icon-media-image-symbolic"></div>
                <div class="adw-status-page-title">Empty Gallery</div>
                <div class="adw-status-page-description">{{ user_profile.full_name or ('User ' ~ user_profile.id) }} has not uploaded any photos to their gallery yet.</div>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Full-size profile photo dialog logic
    const avatarContainer = document.getElementById('profile-page-avatar-container');
    const fullSizePhotoDialog = document.getElementById('profile-photo-dialog');
    const fullSizePhotoImg = document.getElementById('full-profile-photo-img');
    const profileAvatarImg = document.getElementById('profile-page-avatar-img');

    if (avatarContainer && fullSizePhotoDialog && fullSizePhotoImg && profileAvatarImg) {
        customElements.whenDefined('adw-dialog').then(() => {
            avatarContainer.addEventListener('click', () => {
                const photoUrl = profileAvatarImg.src; // Get the src from the visible avatar
                if (photoUrl) {
                    fullSizePhotoImg.src = photoUrl;
                    fullSizePhotoDialog.open();
                }
            });
        }).catch(error => {
            console.error("profile.html: Failed to initialize full-size photo dialog; adw-dialog definition not found.", error);
        });
    } else {
        if (!avatarContainer) console.warn("profile.html: Avatar container not found.");
        if (!fullSizePhotoDialog) console.warn("profile.html: Full-size photo dialog element not found.");
        if (!fullSizePhotoImg) console.warn("profile.html: Full-size photo img element not found.");
        if (!profileAvatarImg) console.warn("profile.html: Profile avatar img element not found.");
    }

    // Full-size gallery photo dialog logic
    const galleryPhotoDialog = document.getElementById('gallery-photo-dialog');
    const fullGalleryPhotoImg = document.getElementById('full-gallery-photo-img');
    const fullGalleryPhotoCaption = document.getElementById('full-gallery-photo-caption');
    const galleryPhotoCommentsList = document.getElementById('gallery-photo-comments-list');
    const galleryPhotoDialogLikeSection = document.getElementById('gallery-photo-dialog-like-section');
    const newGalleryCommentForm = document.getElementById('new-gallery-comment-form');
    const galleryCommentText = document.getElementById('gallery-comment-text');
    const galleryCommentPhotoIdInput = document.getElementById('gallery-comment-photo-id');
    const galleryCommentError = document.getElementById('gallery-comment-error');
    const placeholderComment = galleryPhotoCommentsList ? galleryPhotoCommentsList.querySelector('.placeholder-comment') : null;
    const clickableGalleryPhotos = document.querySelectorAll('.clickable-gallery-photo');

    // Helper function to format date (basic, can be improved)
    function formatCommentDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) + ' ' +
               date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function displayGalleryComments(comments) {
        galleryPhotoCommentsList.innerHTML = ''; // Clear existing
        if (!comments || comments.length === 0) {
            if(placeholderComment) {
                placeholderComment.style.display = ''; // Show placeholder
                placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'No comments yet.';
                galleryPhotoCommentsList.appendChild(placeholderComment);
            }
            return;
        }
        if(placeholderComment) placeholderComment.style.display = 'none';

        comments.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('adw-action-row'); // Use Adwaita styling for list items
            // API now provides full_name (with 'User ID' fallback) and correct profile_url (ID-based)
            const authorDisplayName = comment.author.full_name;
            const authorProfileUrl = comment.author.profile_url;
            const authorAvatarAlt = comment.author.full_name;

            commentDiv.innerHTML = `
                <span class="adw-avatar size-small" style="margin-right: var(--spacing-s);">
                    <img src="${comment.author.profile_photo_url}" alt="${authorAvatarAlt} avatar">
                </span>
                <span class="adw-action-row-text-content">
                    ${authorProfileUrl ? `<a href="${authorProfileUrl}" class="adw-link adw-action-row-title">${authorDisplayName}</a>` : `<span class="adw-action-row-title">${authorDisplayName}</span>`}
                    <span class="adw-action-row-subtitle">${comment.text}</span>
                    <small class="adw-label caption">${formatCommentDate(comment.created_at)}</small>
                </span>
            `;
            galleryPhotoCommentsList.appendChild(commentDiv);
        });
    }

    async function fetchGalleryComments(photoId) {
        if(placeholderComment) {
            placeholderComment.style.display = '';
            placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Loading comments...';
            if (galleryPhotoCommentsList.childElementCount === 0) {
                 galleryPhotoCommentsList.appendChild(placeholderComment);
            }
        }
        try {
            const response = await fetch(`/photo/api/photos/${photoId}/comments`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const comments = await response.json();
            displayGalleryComments(comments);
        } catch (error) {
            console.error('Error fetching gallery comments:', error);
            if(placeholderComment) placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Could not load comments.';
        }
    }

    // Function to render like button (simplified, assumes current_user context is available or not needed for display)
    // This is a simplified version. A full Jinja macro render via JS is more complex.
    // We'll create the HTML structure directly. This assumes `csrf_token()` is globally available or fetched.
    // For a more robust solution, an API endpoint returning the like status and count would be better
    // than trying to replicate the macro's HTML generation perfectly in JS.
    // However, for now, we construct it.
    async function renderLikeButtonForDialog(photoId, likeSectionElement) {
        if (!likeSectionElement) return;
        likeSectionElement.innerHTML = '<span class="adw-label caption">Loading like status...</span>'; // Placeholder

        const csrfTokenVal = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch(`/api/v1/item/photo/${photoId}/like_details`);
            if (!response.ok) {
                console.error("Failed to fetch like details:", response.status, await response.text());
                likeSectionElement.innerHTML = '<span class="adw-label caption error-text">Could not load like status.</span>';
                return;
            }
            const data = await response.json();

            if (data.status === 'success') {
                let likeButtonHtml = '';
                if (data.current_user_has_liked) {
                    likeButtonHtml = `
                        <form action="/like/unlike/photo/${photoId}" method="POST" class="dialog-like-form" data-action="unlike" data-photoid="${photoId}" style="display: inline-block;">
                            <input type="hidden" name="csrf_token" value="${csrfTokenVal}">
                            <button type="submit" class="adw-button small flat" aria-label="Unlike photo">
                                <span class="adw-icon icon-actions-starred-symbolic"></span> Unlike
                            </button>
                        </form>`;
                } else {
                    likeButtonHtml = `
                        <form action="/like/photo/${photoId}" method="POST" class="dialog-like-form" data-action="like" data-photoid="${photoId}" style="display: inline-block;">
                            <input type="hidden" name="csrf_token" value="${csrfTokenVal}">
                            <button type="submit" class="adw-button small flat suggested-action" aria-label="Like photo">
                                <span class="adw-icon icon-actions-star-symbolic"></span> Like
                            </button>
                        </form>`;
                }
                likeSectionElement.innerHTML = `
                    ${likeButtonHtml}
                    <span class="adw-label caption like-count" style="margin-left: var(--spacing-xs);">${data.like_count}</span>
                `;

                // Add event listeners to newly created forms for dynamic updates
                likeSectionElement.querySelectorAll('.dialog-like-form').forEach(form => {
                    form.addEventListener('submit', async function(event) {
                        event.preventDefault();
                        const currentForm = event.target;
                        const action = currentForm.dataset.action;
                        const photoIdForAction = currentForm.dataset.photoid;

                        try {
                            const likeUnlikeResponse = await fetch(currentForm.action, {
                                method: 'POST',
                                body: new FormData(currentForm) // FormData handles CSRF token
                            });

                            if (likeUnlikeResponse.ok) {
                                // Instead of parsing HTML, just re-fetch and re-render the like button section
                                renderLikeButtonForDialog(photoIdForAction, likeSectionElement);
                            } else {
                                console.error(`Failed to ${action} photo:`, likeUnlikeResponse.status);
                                // Optionally show an error toast or message
                                if (window.Adw && Adw.createToast) {
                                    Adw.createToast(`Failed to ${action} photo.`, { type: 'error' });
                                }
                            }
                        } catch (error) {
                            console.error(`Error during ${action} action:`, error);
                            if (window.Adw && Adw.createToast) {
                                Adw.createToast(`Error during ${action} action.`, { type: 'error' });
                            }
                        }
                    });
                });

            } else {
                likeSectionElement.innerHTML = `<span class="adw-label caption error-text">${data.message || 'Error loading like status.'}</span>`;
            }
        } catch (error) {
            console.error('Error in renderLikeButtonForDialog:', error);
            likeSectionElement.innerHTML = '<span class="adw-label caption error-text">Could not load like status due to a network or script error.</span>';
        }
    }


    if (galleryPhotoDialog && fullGalleryPhotoImg && fullGalleryPhotoCaption && galleryPhotoCommentsList && clickableGalleryPhotos.length > 0) {
        customElements.whenDefined('adw-dialog').then(() => {
            clickableGalleryPhotos.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const photoUrl = thumb.dataset.fullsrc;
                    const caption = thumb.dataset.caption;
                    const photoId = thumb.dataset.photoid;

                    if (photoUrl && photoId) {
                        fullGalleryPhotoImg.src = photoUrl;
                        fullGalleryPhotoImg.alt = caption || "Full-size gallery photo";
                        if (fullGalleryPhotoCaption) {
                             fullGalleryPhotoCaption.textContent = caption || '';
                        }
                        if (galleryCommentPhotoIdInput) {
                            galleryCommentPhotoIdInput.value = photoId;
                        }
                        fetchGalleryComments(photoId);
                        if (galleryPhotoDialogLikeSection) { // Ensure like section exists
                            renderLikeButtonForDialog(photoId, galleryPhotoDialogLikeSection);
                        }
                        galleryPhotoDialog.open();
                    }
                });
            });
        }).catch(error => {
            console.error("profile.html: Failed to initialize gallery photo dialog; adw-dialog definition not found.", error);
        });
    } else {
        // Warnings for missing elements
        if (!galleryPhotoDialog) console.warn("profile.html: Gallery photo dialog element not found.");
        // ... other warnings
    }

    if (newGalleryCommentForm && galleryCommentText && galleryCommentPhotoIdInput && galleryCommentError) {
        newGalleryCommentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const photoId = galleryCommentPhotoIdInput.value;
            const commentText = galleryCommentText.value.trim();
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');


            if (!commentText) {
                galleryCommentError.textContent = "Comment cannot be empty.";
                galleryCommentError.style.display = 'block';
                return;
            }
            galleryCommentError.style.display = 'none';

            try {
                const response = await fetch(`/photo/api/photos/${photoId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ text: commentText })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.errors ? JSON.stringify(errorData.errors) : `HTTP error! status: ${response.status}`);
                }

                // const newComment = await response.json(); // Not strictly needed if refetching
                galleryCommentText.value = ''; // Clear textarea
                fetchGalleryComments(photoId); // Refresh comments list
            } catch (error) {
                console.error('Error posting comment:', error);
                galleryCommentError.textContent = "Could not post comment: " + error.message;
                galleryCommentError.style.display = 'block';
            }
        });
    }


    // Script for profile bio expander
    const profileBioExpander = document.querySelector('.profile-bio-expander');
    if (profileBioExpander) {
        const header = profileBioExpander.querySelector('.adw-action-row.activatable');
        const content = profileBioExpander.querySelector('.adw-expander-row-content');
        const icon = profileBioExpander.querySelector('.adw-expander-row-icon');

        if (header && content && icon) {
            header.addEventListener('click', () => {
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
                content.classList.toggle('expanded', !isExpanded);
                profileBioExpander.classList.toggle('expanded', !isExpanded); // For icon rotation
            });
        }
    }

    // JavaScript for styled file input
    const actualFileInput = document.getElementById('gallery_photos_input_actual');
    const fileNamesSpan = document.getElementById('gallery-photo-filenames');

    if (actualFileInput && fileNamesSpan) {
        actualFileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                if (this.files.length === 1) {
                    fileNamesSpan.textContent = this.files[0].name;
                } else {
                    fileNamesSpan.textContent = `${this.files.length} files selected`;
                }
            } else {
                fileNamesSpan.textContent = 'No files selected';
            }
        });
    }

    // Gallery upload form spinner
    const galleryUploadForm = document.querySelector('form.gallery-upload-form');
    const gallerySubmitButton = document.getElementById('gallery-upload-submit-button');
    const gallerySpinner = document.getElementById('gallery-upload-spinner');

    if (galleryUploadForm && gallerySubmitButton && gallerySpinner) {
        galleryUploadForm.addEventListener('submit', function() {
            gallerySubmitButton.disabled = true;
            gallerySpinner.style.display = 'inline-block';
            // Note: For file uploads, success/failure redirect will negate the need
            // to re-enable the button or hide spinner here, unless it's an AJAX upload.
        });
    }
});
</script>
{% endblock %}
