{% extends "base.html" %}

{% block title %}{{ user_profile.full_name or ('User ' ~ user_profile.id) }}'s Photo Gallery{% endblock %}

{% block header_title %}{{ user_profile.full_name or ('User ' ~ user_profile.id) }}'s Photo Gallery{% endblock %}

{% block header_actions_start %}
    <a href="{{ url_for('profile.view_profile', user_id=user_profile.id) }}" class="adw-button">
        <span class="adw-icon icon-actions-go-previous-symbolic"></span> Back to Profile
    </a>
{% endblock %}

{% block content %}
<div class="adw-clamp adw-clamp-xl">
    {% if gallery_photos %}
        <div class="full-page-gallery-grid" style="padding-top: var(--spacing-l); padding-bottom: var(--spacing-l);"> {# Use new class #}
            {% for photo in gallery_photos %}
            <div class="adw-card gallery-photo-card">
                <img src="{{ url_for('static', filename=photo.image_filename) }}"
                     alt="{{ photo.caption or ('Gallery image by ' ~ (user_profile.full_name or ('User ' ~ user_profile.id))) }}"
                     class="gallery-photo-image clickable-gallery-photo" {# Added clickable class #}
                     data-fullsrc="{{ url_for('static', filename=photo.image_filename) }}"
                     data-caption="{{ photo.caption or '' }}"
                     data-photoid="{{ photo.id }}">
                {% if photo.caption %}
                <div class="adw-card__content gallery-photo-caption">
                    <p class="adw-label body-2">{{ photo.caption }}</p>
                </div>
                {% endif %}
                <div class="adw-card__actions card-secondary-actions">
                    {% from "_macros.html" import like_button_and_count %}
                    {{ like_button_and_count(photo, 'photo', current_user) }}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="adw-status-page" style="margin-top: var(--spacing-xl);">
            <span class="adw-icon icon-media-image-symbolic adw-status-page-icon app-status-page-icon"></span>
            <h3 class="adw-status-page-title">Empty Gallery</h3>
            <p class="adw-status-page-description">{{ (user_profile.full_name or ('User ' ~ user_profile.id)) }} has not uploaded any photos to their gallery yet.</p>
             {% if current_user == user_profile %}
                <p class="adw-status-page-description">You can upload photos from your profile page.</p>
            {% else %}
                <p class="adw-status-page-description">Check back later!</p>
            {% endif %}
            <div class="adw-status-page-actions">
                <a href="{{ url_for('profile.view_profile', user_id=user_profile.id) }}" class="adw-button">Back to Profile</a>
            </div>
        </div>
    {% endif %}
</div>

{# Dialog for Full-Size Gallery Photo (copied from profile.html and moved here) #}
<adw-dialog id="gallery-photo-dialog" title="Gallery Photo">
    <div slot="content" class="dialog-image-content" style="text-align: center; padding: var(--spacing-m);">
        <img id="full-gallery-photo-img" src="" alt="Full-size gallery photo" style="max-width: 100%; max-height: 70vh; display: block; margin: auto;">
        <p id="full-gallery-photo-caption" class="adw-label body-1" style="margin-top: var(--spacing-s);"></p>

        <div id="gallery-photo-dialog-like-section" class="adw-box justify-center" style="margin-bottom: var(--spacing-m);">
            {# Placeholder for JS to fill #}
        </div>

        <hr style="margin: var(--spacing-m) 0;">

        <div class="photo-comments-area" style="max-height: 30vh; overflow-y: auto; text-align: left; margin-bottom: var(--spacing-m);">
            <h3 class="adw-title-4" style="margin-bottom: var(--spacing-s);">Comments</h3>
            <div id="gallery-photo-comments-list" class="adw-list-box flat compact">
                <div class="adw-action-row placeholder-comment" style="display: none;">
                     <span class="adw-action-row-subtitle">No comments yet, or loading...</span>
                </div>
            </div>
        </div>

        {% if current_user.is_authenticated %}
        <form id="new-gallery-comment-form" class="stacked-form" style="text-align: left;">
            <input type="hidden" id="gallery-comment-photo-id" name="photo_id" value="">
            <div class="adw-action-row column-layout">
                 <label for="gallery-comment-text" class="adw-action-row-title" style="margin-bottom: var(--spacing-xs);">Your Comment</label>
                <textarea id="gallery-comment-text" name="text" class="adw-entry" rows="2" placeholder="Write a comment..." required style="width: 100%; min-height: 60px; box-sizing: border-box;"></textarea>
                <div id="gallery-comment-error" class="error-text adw-label caption" style="display:none; margin-top: var(--spacing-xs);"></div>
            </div>
            <div class="form-actions-end" style="margin-top: var(--spacing-s);">
                <button type="submit" class="adw-button suggested-action">Post Comment</button>
            </div>
        </form>
        {% else %}
        <p class="adw-label body-1"><a href="{{ url_for('auth.login', next=request.url) }}" class="adw-link">Login</a> to comment.</p>
        {% endif %}
    </div>
</adw-dialog>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const galleryPhotoDialogEl = document.getElementById('gallery-photo-dialog');
    const fullGalleryPhotoImgEl = document.getElementById('full-gallery-photo-img');
    const fullGalleryPhotoCaptionEl = document.getElementById('full-gallery-photo-caption');
    const galleryPhotoCommentsListEl = document.getElementById('gallery-photo-comments-list');
    const galleryPhotoDialogLikeSectionEl = document.getElementById('gallery-photo-dialog-like-section');
    const placeholderCommentEl = galleryPhotoCommentsListEl ? galleryPhotoCommentsListEl.querySelector('.placeholder-comment') : null;
    const newGalleryCommentFormEl = document.getElementById('new-gallery-comment-form');
    const galleryCommentTextEl = document.getElementById('gallery-comment-text'); // Textarea for comment
    const galleryCommentPhotoIdInputEl = document.getElementById('gallery-comment-photo-id'); // Hidden input in form
    const galleryCommentErrorEl = document.getElementById('gallery-comment-error'); // Error display for comment form


    const clickableGalleryPhotos = document.querySelectorAll('.clickable-gallery-photo');

    if (!galleryPhotoDialogEl || !fullGalleryPhotoImgEl || !fullGalleryPhotoCaptionEl || !galleryPhotoDialogLikeSectionEl || !galleryPhotoCommentsListEl ||
        !newGalleryCommentFormEl || !galleryCommentTextEl || !galleryCommentPhotoIdInputEl || !galleryCommentErrorEl) {
        console.warn("One or more gallery dialog elements (dialog, image, caption, like section, comments list, or comment form elements) not found. Full size photo viewing or interactions may not work.");
        return;
    }

    // --- Like Functionality ---
    async function fetchPhotoDetails(photoId) {
        try {
            const response = await fetch(\`/photo/api/photos/\${photoId}/details\`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error(\`Error fetching photo details for \${photoId}: \${response.status}\`, errorData.message || \`Server returned an error\`);
                return { error: true, message: errorData.message || \`Could not load photo details.\` };
            }
            const data = await response.json();
            if (data.status === \`success\`) {
                return {
                    id: data.id,
                    like_count: data.like_count,
                    user_has_liked: data.user_has_liked,
                    error: false
                };
            } else {
                console.error(\`API error fetching photo details for \${photoId}:\`, data.message);
                return { error: true, message: data.message || \`Failed to get photo details.\` };
            }
        } catch (error) {
            console.error(\`Network or JavaScript error fetching photo details:\`, error);
            return { error: true, message: \`Network error or invalid response while fetching photo details.\` };
        }
    }

    function updateLikeSectionUI(likeSectionElement, photoId, itemType, likeCount, userHasLiked) {
        likeSectionElement.innerHTML = ''; // Clear previous content
        const csrfTokenVal = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'inline';
        form.classList.add('like-form'); // For event delegation

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfTokenVal;
        form.appendChild(csrfInput);

        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action_type';
        form.appendChild(actionInput);

        const button = document.createElement('button');
        button.type = 'submit';
        button.classList.add('adw-button', 'small', 'flat');

        const iconSpan = document.createElement('span');
        iconSpan.classList.add('adw-icon');
        button.appendChild(iconSpan);

        if (userHasLiked) {
            form.action = \`/like/unlike/\${itemType}/\${photoId}\`;
            actionInput.value = 'unlike';
            button.classList.add('unlike-button'); // Add class for specific styling if needed
            button.setAttribute('aria-label', \`Unlike \${itemType}\`);
            iconSpan.classList.add('icon-actions-starred-symbolic');
        } else {
            form.action = \`/like/\${itemType}/\${photoId}\`;
            actionInput.value = 'like';
            button.classList.add('suggested-action', 'like-button'); // Add classes for specific styling
            button.setAttribute('aria-label', \`Like \${itemType}\`);
            iconSpan.classList.add('icon-actions-star-symbolic');
        }
        form.appendChild(button);
        likeSectionElement.appendChild(form);

        const countSpan = document.createElement('span');
        countSpan.classList.add('adw-label', 'caption', 'like-count');
        countSpan.id = \`dialog-like-count-\${itemType}-\${photoId}\`; // Context prefix for dialog
        countSpan.textContent = likeCount;
        likeSectionElement.appendChild(countSpan);
    }

    async function handleLikeUnlikeSubmit(event) {
        event.preventDefault();
        const form = event.target.closest('.like-form');
        if (!form) return;

        const photoId = galleryPhotoDialogEl.dataset.currentPhotoId;
        const itemType = 'photo'; // Hardcoded for gallery photos

        if (!photoId) {
            console.error("No currentPhotoId found on dialog for like/unlike action.");
            return;
        }

        const actionUrl = form.action;
        const csrfToken = form.querySelector('input[name="csrf_token"]').value;
        // const actionType = form.querySelector('input[name="action_type"]').value; // Not strictly needed for body if using form action

        try {
            const response = await fetch(actionUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded' // Standard for form submission
                },
                body: new URLSearchParams({ csrf_token: csrfToken }) // Minimal body, action in URL
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error during like/unlike.' }));
                throw new Error(errorData.message || \`HTTP error! status: \${response.status}\`);
            }

            const data = await response.json();

            if (data.status === 'success') {
                updateLikeSectionUI(galleryPhotoDialogLikeSectionEl, photoId, itemType, data.new_like_count, data.user_has_liked);
            } else {
                throw new Error(data.message || 'Like/unlike action failed.');
            }
        } catch (error) {
            console.error('Error handling like/unlike:', error);
            if (window.Adw && Adw.createToast) {
                Adw.createToast(error.message || 'Could not perform like/unlike action.', { type: 'error' });
            } else {
                alert(error.message || 'Could not perform like/unlike action.');
            }
        }
    }

    galleryPhotoDialogLikeSectionEl.addEventListener('submit', function(event) {
        if (event.target.matches('.like-form')) {
            handleLikeUnlikeSubmit(event);
        }
    });

    async function fetchAndRenderLikes(photoId, likeSectionElement) {
        const details = await fetchPhotoDetails(photoId);
        if (details.error) {
            likeSectionElement.innerHTML = \`<p class='adw-label caption error-text'>\${details.message}</p>\`;
        } else {
            updateLikeSectionUI(likeSectionElement, details.id, 'photo', details.like_count, details.user_has_liked);
        }
    }

    // --- End Like Functionality ---

    // --- Comment Display Functionality ---
    function formatCommentDate(isoString) { // Keep this helper if it's not already global
        const date = new Date(isoString);
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) + ' ' +
               date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function renderCommentItem(comment) {
        const commentDiv = document.createElement('div');
        commentDiv.classList.add('adw-action-row');

        // Avatar
        const avatarSpan = document.createElement('span');
        avatarSpan.classList.add('adw-avatar', 'size-small');
        // avatarSpan.style.marginRight = 'var(--spacing-s)'; // Removed: Styling should be CSS based
        const avatarImg = document.createElement('img');
        avatarImg.src = comment.author.profile_photo_url;
        avatarImg.alt = \`\${comment.author.full_name} avatar\`;
        avatarSpan.appendChild(avatarImg);
        commentDiv.appendChild(avatarSpan);

        // Text Content (Name, Comment, Date)
        const textContentSpan = document.createElement('span');
        textContentSpan.classList.add('adw-action-row-text-content');

        // Author Name (Link or Span)
        if (comment.author.profile_url) {
            const authorLink = document.createElement('a');
            authorLink.href = comment.author.profile_url;
            authorLink.classList.add('adw-link', 'adw-action-row-title');
            authorLink.textContent = comment.author.full_name;
            textContentSpan.appendChild(authorLink);
        } else {
            const authorSpan = document.createElement('span');
            authorSpan.classList.add('adw-action-row-title');
            authorSpan.textContent = comment.author.full_name;
            textContentSpan.appendChild(authorSpan);
        }

        // Comment Text
        const commentTextSpan = document.createElement('span');
        commentTextSpan.classList.add('adw-action-row-subtitle');
        commentTextSpan.textContent = comment.text; // Assuming comment.text is plain text
        textContentSpan.appendChild(commentTextSpan);

        // Date
        const dateSmall = document.createElement('small');
        dateSmall.classList.add('adw-label', 'caption');
        dateSmall.textContent = formatCommentDate(comment.created_at);
        textContentSpan.appendChild(dateSmall);

        commentDiv.appendChild(textContentSpan);
        return commentDiv;
    }

    function displayGalleryComments(comments) {
        galleryPhotoCommentsListEl.innerHTML = ''; // Clear previous comments

        if (!comments || comments.length === 0) {
            if (placeholderCommentEl) {
                placeholderCommentEl.hidden = false;
                placeholderCommentEl.querySelector('.adw-action-row-subtitle').textContent = 'No comments yet.';
                galleryPhotoCommentsListEl.appendChild(placeholderCommentEl);
            }
            return;
        }

        if (placeholderCommentEl) {
            placeholderCommentEl.hidden = true;
        }

        comments.forEach(comment => {
            const commentItemEl = renderCommentItem(comment);
            galleryPhotoCommentsListEl.appendChild(commentItemEl);
        });
    }

    async function fetchAndRenderComments(photoId) {
        if (!galleryPhotoCommentsListEl) return;

        if (placeholderCommentEl) {
            galleryPhotoCommentsListEl.innerHTML = ''; // Clear before showing loading
            placeholderCommentEl.hidden = false;
            placeholderCommentEl.querySelector('.adw-action-row-subtitle').textContent = 'Loading comments...';
            galleryPhotoCommentsListEl.appendChild(placeholderCommentEl);
        }

        try {
            const response = await fetch(\`/photo/api/photos/\${photoId}/comments\`);
            if (!response.ok) {
                throw new Error(\`HTTP error fetching comments: \${response.status}\`);
            }
            const comments = await response.json();
            displayGalleryComments(comments); // This will hide placeholder if comments are found
        } catch (error) {
            console.error('Error fetching gallery comments:', error);
            if (placeholderCommentEl) {
                galleryPhotoCommentsListEl.innerHTML = ''; // Clear before showing error
                placeholderCommentEl.hidden = false;
                placeholderCommentEl.querySelector('.adw-action-row-subtitle').textContent = 'Could not load comments.';
                galleryPhotoCommentsListEl.appendChild(placeholderCommentEl);
            }
        }
    }
    // --- End Comment Display Functionality ---

    // --- Comment Posting Functionality ---
    async function handlePostCommentSubmit(event) {
        event.preventDefault();
        const photoId = galleryCommentPhotoIdInputEl.value;
        const commentText = galleryCommentTextEl.value.trim();
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        if (!commentText) {
            galleryCommentErrorEl.textContent = 'Comment cannot be empty.';
            galleryCommentErrorEl.hidden = false;
            return;
        }
        galleryCommentErrorEl.hidden = true; // Clear previous error

        try {
            const response = await fetch(\`/photo/api/photos/\${photoId}/comments\`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ text: commentText })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ errors: { general: 'Failed to post comment. Server error.'} }));
                // Try to get specific error, otherwise general
                const errorMessage = errorData.errors ?
                                     (errorData.errors.text ? errorData.errors.text.join(', ') : JSON.stringify(errorData.errors)) :
                                     'Failed to post comment.';
                throw new Error(errorMessage);
            }

            // const newComment = await response.json(); // Assuming API returns the new comment or success
            galleryCommentTextEl.value = ''; // Clear textarea
            fetchAndRenderComments(photoId); // Refresh comments list
            galleryCommentErrorEl.hidden = true;

        } catch (error) {
            console.error('Error posting comment:', error);
            galleryCommentErrorEl.textContent = error.message || 'Could not post comment due to a network or server issue.';
            galleryCommentErrorEl.hidden = false;
        }
    }

    if (newGalleryCommentFormEl) { // Ensure form exists before adding listener
        newGalleryCommentFormEl.addEventListener('submit', handlePostCommentSubmit);
    }
    // --- End Comment Posting Functionality ---

    clickableGalleryPhotos.forEach(thumb => {
        thumb.addEventListener('click', function() {
            const photoId = this.dataset.photoid;
            const photoUrl = this.dataset.fullsrc;
            const caption = this.dataset.caption || ''; // Default to empty string if no caption

            if (!photoUrl || !photoId) {
                console.error("Clicked photo thumbnail is missing data-fullsrc or data-photoid.", this);
                return;
            }

            fullGalleryPhotoImgEl.setAttribute('src', photoUrl);
            fullGalleryPhotoImgEl.setAttribute('alt', caption || `Full-size gallery photo for ID \${photoId}`);
            fullGalleryPhotoCaptionEl.textContent = caption;

            galleryPhotoDialogEl.dataset.currentPhotoId = photoId;
            // Also update the hidden input in the comment form
            if (galleryCommentPhotoIdInputEl) {
                galleryCommentPhotoIdInputEl.value = photoId;
            }

            fetchAndRenderLikes(photoId, galleryPhotoDialogLikeSectionEl);
            fetchAndRenderComments(photoId); // Fetch and render comments

            customElements.whenDefined('adw-dialog').then(() => {
                if (typeof galleryPhotoDialogEl.open === 'function') {
                    galleryPhotoDialogEl.open();
                } else {
                    console.error("adw-dialog element does not have an open method.", galleryPhotoDialogEl);
                }
            }).catch(err => {
                console.error("Error waiting for adw-dialog definition:", err);
            });
        });
    });
});
</script>
{% endblock %}
