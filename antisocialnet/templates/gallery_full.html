{% extends "base.html" %}

{% block title %}Photo Gallery{% endblock %}

{% block header_title %}Photo Gallery{% endblock %}

{% block content %}
<div class="adw-clamp adw-clamp-xl">
    <div id="gallery-container" class="full-page-gallery-grid" style="padding-top: var(--spacing-l); padding-bottom: var(--spacing-l);"></div>
    <div id="loading-indicator" class="adw-status-page">
        <adw-spinner size="l" active></adw-spinner>
        <h3 class="adw-status-page-title">Loading...</h3>
    </div>
    <div id="empty-gallery-message" class="adw-status-page" style="display: none;">
        <span class="adw-icon icon-media-image-symbolic adw-status-page-icon app-status-page-icon"></span>
        <h3 class="adw-status-page-title">Empty Gallery</h3>
        <p class="adw-status-page-description">This user has not uploaded any photos to their gallery yet.</p>
    </div>
</div>

<adw-dialog id="gallery-photo-dialog" title="Gallery Photo">
    <div slot="content" class="dialog-image-content" style="text-align: center; padding: var(--spacing-m);">
        <img id="full-gallery-photo-img" src="" alt="Full-size gallery photo" style="max-width: 100%; max-height: 70vh; display: block; margin: auto;">
        <p id="full-gallery-photo-caption" class="adw-label body-1" style="margin-top: var(--spacing-s);"></p>
        <div id="gallery-photo-dialog-like-section" class="adw-box justify-center" style="margin-bottom: var(--spacing-m);"></div>
        <hr style="margin: var(--spacing-m) 0;">
        <div class="photo-comments-area" style="max-height: 30vh; overflow-y: auto; text-align: left; margin-bottom: var(--spacing-m);">
            <h3 class="adw-title-4" style="margin-bottom: var(--spacing-s);">Comments</h3>
            <div id="gallery-photo-comments-list" class="adw-list-box flat compact"></div>
        </div>
    </div>
</adw-dialog>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const galleryContainer = document.getElementById('gallery-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const emptyGalleryMessage = document.getElementById('empty-gallery-message');
        const dialog = document.getElementById('gallery-photo-dialog');
        const dialogImage = document.getElementById('full-gallery-photo-img');
        const dialogCaption = document.getElementById('full-gallery-photo-caption');
        const dialogLikeSection = document.getElementById('gallery-photo-dialog-like-section');
        const dialogCommentsList = document.getElementById('gallery-photo-comments-list');
        const userId = window.location.pathname.split('/')[2];

        async function fetchGallery() {
            loadingIndicator.style.display = 'block';
            galleryContainer.innerHTML = '';
            emptyGalleryMessage.style.display = 'none';

            try {
                const response = await fetch(`/api/v1/user/${userId}/photos`);
                if (!response.ok) {
                    throw new Error('Failed to fetch gallery');
                }
                const data = await response.json();

                if (data.items.length === 0) {
                    emptyGalleryMessage.style.display = 'block';
                } else {
                    data.items.forEach(photo => {
                        const card = createPhotoCard(photo);
                        galleryContainer.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error fetching gallery:', error);
                galleryContainer.innerHTML = '<p>Error loading gallery. Please try again later.</p>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function createPhotoCard(photo) {
            const card = document.createElement('div');
            card.className = 'adw-card gallery-photo-card';
            card.innerHTML = `
                <img src="${photo.data.image_url_large}"
                     alt="${photo.data.caption_html || 'Gallery image'}"
                     class="gallery-photo-image clickable-gallery-photo"
                     data-fullsrc="${photo.data.image_url_large}"
                     data-caption="${photo.data.caption_html || ''}"
                     data-photoid="${photo.data.photo_id}">
                ${photo.data.caption_html ? `
                <div class="adw-card__content gallery-photo-caption">
                    <p class="adw-label body-2">${photo.data.caption_html}</p>
                </div>
                ` : ''}
                <div class="adw-card__actions card-secondary-actions">
                    <adw-like-button item-id="${photo.data.photo_id}" item-type="userphoto" initial-liked="${photo.data.is_liked_by_current_user}" initial-like-count="${photo.data.like_count}"></adw-like-button>
                </div>
            `;
            card.querySelector('.clickable-gallery-photo').addEventListener('click', () => openPhotoDialog(photo));
            return card;
        }

        async function openPhotoDialog(photo) {
            dialogImage.src = photo.data.image_url_large;
            dialogCaption.innerHTML = photo.data.caption_html || '';
            dialog.open();

            // Fetch and render likes and comments
            const [likesResponse, commentsResponse] = await Promise.all([
                fetch(`/api/v1/item/userphoto/${photo.data.photo_id}/like_details`),
                fetch(`/api/v1/item/userphoto/${photo.data.photo_id}/comments`)
            ]);

            if (likesResponse.ok) {
                const likesData = await likesResponse.json();
                renderLikes(likesData);
            }

            if (commentsResponse.ok) {
                const commentsData = await commentsResponse.json();
                renderComments(commentsData.comments);
            }
        }

        function renderLikes(likes) {
            dialogLikeSection.innerHTML = `<adw-like-button item-id="${likes.target_id}" item-type="${likes.target_type}" initial-liked="${likes.current_user_has_liked}" initial-like-count="${likes.like_count}"></adw-like-button>`;
        }

        function renderComments(comments) {
            dialogCommentsList.innerHTML = '';
            if (comments.length === 0) {
                dialogCommentsList.innerHTML = '<p class="adw-label body">No comments yet.</p>';
                return;
            }

            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.innerHTML = `
                    <header class="comment-header adw-box adw-box-spacing-s comment-header-box">
                        <span class="adw-avatar size-medium">
                           <img src="${comment.actor.profile_photo_url}" alt="${comment.actor.full_name} avatar" class="adw-avatar__image">
                        </span>
                        <div class="comment-author-meta">
                             <a href="/profile/${comment.actor.id}" class="adw-link comment-author-link-strong">${comment.actor.full_name}</a>
                            <small class="adw-label caption comment-timestamp"><time datetime="${comment.timestamp}">${new Date(comment.timestamp).toLocaleString()}</time></small>
                        </div>
                    </header>
                    <div class="comment-text styled-text-content">${comment.data.text_html}</div>
                    <div class="comment-actions adw-box adw-box-horizontal adw-box-spacing-s align-center">
                        <adw-like-button item-id="${comment.data.comment_id}" item-type="comment" initial-liked="${comment.data.is_liked_by_current_user}" initial-like-count="${comment.data.like_count}"></adw-like-button>
                    </div>
                `;
                dialogCommentsList.appendChild(commentDiv);
            });
        }

        fetchGallery();
    });
</script>
{% endblock %}
