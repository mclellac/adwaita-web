{% extends "base.html" %}

{% block title %}{{ user_profile.full_name or ('User ' ~ user_profile.id) }}'s Photo Gallery{% endblock %}

{% block header_title %}{{ user_profile.full_name or ('User ' ~ user_profile.id) }}'s Photo Gallery{% endblock %}

{% block header_actions_start %}
    <a href="{{ url_for('profile.view_profile', user_id=user_profile.id) }}" class="adw-button">
        <span class="adw-icon icon-actions-go-previous-symbolic"></span> Back to Profile
    </a>
{% endblock %}

{% block content %}
<div class="adw-clamp adw-clamp-xl">
    {% if gallery_photos %}
        <div class="full-page-gallery-grid" style="padding-top: var(--spacing-l); padding-bottom: var(--spacing-l);"> {# Use new class #}
            {% for photo in gallery_photos %}
            <div class="adw-card gallery-photo-card">
                <img src="{{ url_for('static', filename=photo.image_filename) }}"
                     alt="{{ photo.caption or ('Gallery image by ' ~ (user_profile.full_name or ('User ' ~ user_profile.id))) }}"
                     class="gallery-photo-image clickable-gallery-photo" {# Added clickable class #}
                     data-fullsrc="{{ url_for('static', filename=photo.image_filename) }}"
                     data-caption="{{ photo.caption or '' }}"
                     data-photoid="{{ photo.id }}">
                {% if photo.caption %}
                <div class="adw-card__content gallery-photo-caption">
                    <p class="adw-label body-2">{{ photo.caption }}</p>
                </div>
                {% endif %}
                <div class="adw-card__actions card-secondary-actions">
                    {% from "_macros.html" import like_button_and_count %}
                    {{ like_button_and_count(photo, 'photo', current_user) }}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="adw-status-page" style="margin-top: var(--spacing-xl);">
            <span class="adw-icon icon-media-image-symbolic adw-status-page-icon app-status-page-icon"></span>
            <h3 class="adw-status-page-title">Empty Gallery</h3>
            <p class="adw-status-page-description">{{ (user_profile.full_name or ('User ' ~ user_profile.id)) }} has not uploaded any photos to their gallery yet.</p>
             {% if current_user == user_profile %}
                <p class="adw-status-page-description">You can upload photos from your profile page.</p>
            {% else %}
                <p class="adw-status-page-description">Check back later!</p>
            {% endif %}
            <div class="adw-status-page-actions">
                <a href="{{ url_for('profile.view_profile', user_id=user_profile.id) }}" class="adw-button">Back to Profile</a>
            </div>
        </div>
    {% endif %}
</div>

{# Dialog for Full-Size Gallery Photo (copied from profile.html and moved here) #}
<adw-dialog id="gallery-photo-dialog" title="Gallery Photo">
    <div slot="content" class="dialog-image-content" style="text-align: center; padding: var(--spacing-m);">
        <img id="full-gallery-photo-img" src="" alt="Full-size gallery photo" style="max-width: 100%; max-height: 70vh; display: block; margin: auto;">
        <p id="full-gallery-photo-caption" class="adw-label body-1" style="margin-top: var(--spacing-s);"></p>

        <div id="gallery-photo-dialog-like-section" class="adw-box justify-center" style="margin-bottom: var(--spacing-m);">
            {# Placeholder for JS to fill #}
        </div>

        <hr style="margin: var(--spacing-m) 0;">

        <div class="photo-comments-area" style="max-height: 30vh; overflow-y: auto; text-align: left; margin-bottom: var(--spacing-m);">
            <h3 class="adw-title-4" style="margin-bottom: var(--spacing-s);">Comments</h3>
            <div id="gallery-photo-comments-list" class="adw-list-box flat compact">
                <div class="adw-action-row placeholder-comment" style="display: none;">
                     <span class="adw-action-row-subtitle">No comments yet, or loading...</span>
                </div>
            </div>
        </div>

        {% if current_user.is_authenticated %}
        <form id="new-gallery-comment-form" class="stacked-form" style="text-align: left;">
            <input type="hidden" id="gallery-comment-photo-id" name="photo_id" value="">
            <div class="adw-action-row column-layout">
                 <label for="gallery-comment-text" class="adw-action-row-title" style="margin-bottom: var(--spacing-xs);">Your Comment</label>
                <textarea id="gallery-comment-text" name="text" class="adw-entry" rows="2" placeholder="Write a comment..." required style="width: 100%; min-height: 60px; box-sizing: border-box;"></textarea>
                <div id="gallery-comment-error" class="error-text adw-label caption" style="display:none; margin-top: var(--spacing-xs);"></div>
            </div>
            <div class="form-actions-end" style="margin-top: var(--spacing-s);">
                <button type="submit" class="adw-button suggested-action">Post Comment</button>
            </div>
        </form>
        {% else %}
        <p class="adw-label body-1"><a href="{{ url_for('auth.login', next=request.url) }}" class="adw-link">Login</a> to comment.</p>
        {% endif %}
    </div>
</adw-dialog>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Full-size gallery photo dialog logic (adapted from profile.html)
    const galleryPhotoDialog = document.getElementById('gallery-photo-dialog');
    const fullGalleryPhotoImg = document.getElementById('full-gallery-photo-img');
    const fullGalleryPhotoCaption = document.getElementById('full-gallery-photo-caption');
    const galleryPhotoCommentsList = document.getElementById('gallery-photo-comments-list');
    const galleryPhotoDialogLikeSection = document.getElementById('gallery-photo-dialog-like-section');
    const newGalleryCommentForm = document.getElementById('new-gallery-comment-form');
    const galleryCommentText = document.getElementById('gallery-comment-text');
    const galleryCommentPhotoIdInput = document.getElementById('gallery-comment-photo-id');
    const galleryCommentError = document.getElementById('gallery-comment-error');
    const placeholderComment = galleryPhotoCommentsList ? galleryPhotoCommentsList.querySelector('.placeholder-comment') : null;

    // Selector for clickable photos will be '.clickable-gallery-photo' which needs to be added to images
    const clickableGalleryPhotos = document.querySelectorAll('.clickable-gallery-photo');

    function formatCommentDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) + ' ' +
               date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function displayGalleryComments(comments) {
        if (!galleryPhotoCommentsList) return;
        galleryPhotoCommentsList.innerHTML = '';
        if (!comments || comments.length === 0) {
            if(placeholderComment) {
                placeholderComment.style.display = '';
                placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'No comments yet.';
                galleryPhotoCommentsList.appendChild(placeholderComment);
            }
            return;
        }
        if(placeholderComment) placeholderComment.style.display = 'none';

        comments.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('adw-action-row');
            const authorDisplayName = comment.author.full_name;
            const authorProfileUrl = comment.author.profile_url;
            const authorAvatarAlt = comment.author.full_name;

            commentDiv.innerHTML = `
                <span class="adw-avatar size-small" style="margin-right: var(--spacing-s);">
                    <img src="${comment.author.profile_photo_url}" alt="${authorAvatarAlt} avatar">
                </span>
                <span class="adw-action-row-text-content">
                    ${authorProfileUrl ? `<a href="${authorProfileUrl}" class="adw-link adw-action-row-title">${authorDisplayName}</a>` : `<span class="adw-action-row-title">${authorDisplayName}</span>`}
                    <span class="adw-action-row-subtitle">${comment.text}</span>
                    <small class="adw-label caption">${formatCommentDate(comment.created_at)}</small>
                </span>
            `;
            galleryPhotoCommentsList.appendChild(commentDiv);
        });
    }

    async function fetchGalleryComments(photoId) {
        if (!galleryPhotoCommentsList) {
            if(placeholderComment) placeholderComment.style.display = 'none';
            return;
        }
        if(placeholderComment) {
            placeholderComment.style.display = '';
            placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Loading comments...';
            if (galleryPhotoCommentsList.childElementCount === 0) {
                 galleryPhotoCommentsList.appendChild(placeholderComment);
            }
        }
        try {
            const response = await fetch(\`/photo/api/photos/\${photoId}/comments\`);
            if (!response.ok) {
                throw new Error(\`HTTP error! status: \${response.status}\`);
            }
            const comments = await response.json();
            displayGalleryComments(comments);
        } catch (error) {
            console.error('Error fetching gallery comments:', error);
            if(placeholderComment && galleryPhotoCommentsList.contains(placeholderComment)) {
                 placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Could not load comments.';
            } else if (placeholderComment && galleryPhotoCommentsList) {
                 placeholderComment.querySelector('.adw-action-row-subtitle').textContent = 'Could not load comments.';
                 galleryPhotoCommentsList.appendChild(placeholderComment);
            }
        }
    }

    async function renderLikeButtonForDialog(photoId, likeSectionElement) {
        // This function will now fetch the rendered macro content from the backend
        // or be replaced by a more direct JS DOM manipulation approach after like/unlike.
        // For now, we'll adjust it to handle dynamic updates.
        if (!likeSectionElement) return;
        likeSectionElement.innerHTML = ''; // Clear previous buttons

        try {
            // We need to know if the current user has liked this photo to render the correct initial button.
            // This ideally comes from an API endpoint or was part of the photo data.
            // For now, let's assume we might need to fetch this status or the rendered macro.
            // This is a placeholder - the actual like button rendering will be part of handleLikeSuccess.
            // The initial state will be set when the dialog opens, perhaps by fetching item details including like status.
            // For simplicity in this step, the dynamic rendering will be handled by handleLikeUnlike's success path.
            // We'll call a function that generates the appropriate form based on an assumed 'userHasLiked' status.
            // This part will be more fleshed out when we integrate the actual like status.
            // For now, let's assume the initial state is fetched or known when dialog opens.
            // The actual forms will be added by handleLikeSuccess or an equivalent function.
            // We'll set up a placeholder that gets replaced.
             const photoData = await fetchPhotoData(photoId); // Assume this fetches { ..., like_count: X, user_has_liked: Y }
             updateLikeSectionUI(likeSectionElement, photoId, 'photo', photoData.like_count, photoData.user_has_liked);

        } catch (error) {
            console.error("Error preparing like button for dialog:", error);
            likeSectionElement.innerHTML = "<p class='adw-label caption error-text'>Could not load like actions.</p>";
        }
    }

    // Function to update the like section UI (used for both grid and dialog)
    function updateLikeSectionUI(likeSectionContainer, itemId, itemType, newLikeCount, userHasLiked) {
        const csrfTokenVal = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const contextPrefix = likeSectionContainer.id.startsWith('dialog-') ? 'dialog-' : '';

        let formHtml;
        if (userHasLiked) {
            formHtml = \`
                <form action="/like/unlike/\${itemType}/\${itemId}" method="POST" style="display: inline;" class="like-form">
                    <input type="hidden" name="csrf_token" value="\${csrfTokenVal}">
                    <input type="hidden" name="action_type" value="unlike">
                    <button type="submit" class="adw-button small flat unlike-button" aria-label="Unlike \${itemType}">
                        <span class="adw-icon icon-actions-starred-symbolic"></span>
                    </button>
                </form>
            \`;
        } else {
            formHtml = \`
                <form action="/like/\${itemType}/\${itemId}" method="POST" style="display: inline;" class="like-form">
                    <input type="hidden" name="csrf_token" value="\${csrfTokenVal}">
                    <input type="hidden" name="action_type" value="like">
                    <button type="submit" class="adw-button small flat suggested-action like-button" aria-label="Like \${itemType}">
                        <span class="adw-icon icon-actions-star-symbolic"></span>
                    </button>
                </form>
            \`;
        }
        likeSectionContainer.innerHTML = formHtml + \`<span class="adw-label caption like-count" id="\${contextPrefix}like-count-\${itemType}-\${itemId}">\${newLikeCount}</span>\`;
    }


    async function handleLikeUnlike(event) {
        event.preventDefault();
        const form = event.target.closest('.like-form');
        if (!form) return;

        const itemType = form.closest('.like-section').dataset.itemType;
        const itemId = form.closest('.like-section').dataset.itemId;
        const actionUrl = form.action;
        const csrfToken = form.querySelector('input[name="csrf_token"]').value;
        const actionType = form.querySelector('input[name="action_type"]').value; // 'like' or 'unlike'

        // Optimistic UI update can be added here if desired (e.g., change button state immediately)

        try {
            const response = await fetch(actionUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded' // Flask forms expect this by default
                },
                body: new URLSearchParams({ csrf_token: csrfToken }) // Send CSRF in body too if needed by Flask-WTF
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Unknown error during like/unlike.' }));
                throw new Error(errorData.message || \`HTTP error! status: \${response.status}\`);
            }

            const data = await response.json();

            if (data.status === 'success') {
                const likeSectionContainer = form.closest('.like-section');
                updateLikeSectionUI(likeSectionContainer, itemId, itemType, data.new_like_count, data.user_has_liked);
                 // If inside dialog, ensure the dialog's like section is also updated if it's a different element
                if (galleryPhotoDialog.isOpen() && galleryPhotoDialogLikeSection.dataset.currentPhotoId === itemId) {
                    updateLikeSectionUI(galleryPhotoDialogLikeSection, itemId, itemType, data.new_like_count, data.user_has_liked);
                }


            } else {
                throw new Error(data.message || 'Like/unlike action failed.');
            }
        } catch (error) {
            console.error('Error handling like/unlike:', error);
            if (window.Adw && Adw.createToast) {
                Adw.createToast(error.message || 'Could not perform like/unlike action.', { type: 'error' });
            } else {
                alert(error.message || 'Could not perform like/unlike action.');
            }
            // Optionally, revert optimistic UI update here
        }
    }

    // Event listener for like/unlike forms in the main grid and dialog
    // Using event delegation on a static parent
    const contentArea = document.querySelector('.adw-clamp.adw-clamp-xl'); // Main content area
    if (contentArea) {
        contentArea.addEventListener('submit', function(event) {
            if (event.target.matches('.like-form')) {
                handleLikeUnlike(event);
            }
        });
    }
    // Also for dialog, as it's outside the adw-clamp when active
     if (galleryPhotoDialogLikeSection) {
        galleryPhotoDialogLikeSection.addEventListener('submit', function(event) {
            if (event.target.matches('.like-form')) {
                handleLikeUnlike(event);
            }
        });
    }


    // Helper to fetch initial photo data for dialog, including like status
    async function fetchPhotoData(photoId) {
        try {
            const response = await fetch(`/photo/api/photos/\${photoId}/details`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({})); // Try to parse JSON error, fallback to empty obj
                console.error(`Error fetching photo details for \${photoId}: \${response.status}`, errorData.message || 'Server returned an error');
                return { id: photoId, like_count: 0, user_has_liked: false, error: true, message: errorData.message || 'Could not load photo details.' };
            }
            const data = await response.json();
            if (data.status === 'success') {
                return {
                    id: data.id,
                    like_count: data.like_count,
                    user_has_liked: data.user_has_liked,
                    error: false
                };
            } else { // API returned success HTTP code but status field in JSON is 'error'
                console.error(`API error fetching photo details for \${photoId}:`, data.message);
                return { id: photoId, like_count: 0, user_has_liked: false, error: true, message: data.message || 'Failed to get photo details.'};
            }
        } catch (error) { // Network error or JSON parsing error
            console.error('Network or JavaScript error fetching photo details:', error);
            return { id: photoId, like_count: 0, user_has_liked: false, error: true, message: 'Network error or invalid response.' };
        }
    }


    if (galleryPhotoDialog && fullGalleryPhotoImg && fullGalleryPhotoCaption && galleryPhotoCommentsList) {
        customElements.whenDefined('adw-dialog').then(() => {
            clickableGalleryPhotos.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const photoUrl = thumb.dataset.fullsrc;
                    const caption = thumb.dataset.caption;
                    const photoId = thumb.dataset.photoid;

                    if (photoUrl && photoId) {
                        fullGalleryPhotoImg.src = photoUrl;
                        fullGalleryPhotoImg.alt = caption || "Full-size gallery photo";
                        if (fullGalleryPhotoCaption) {
                             fullGalleryPhotoCaption.textContent = caption || '';
                        }
                        if (galleryCommentPhotoIdInput) {
                            galleryCommentPhotoIdInput.value = photoId;
                        }
                        fetchGalleryComments(photoId);
                        if (galleryPhotoDialogLikeSection) {
                            renderLikeButtonForDialog(photoId, galleryPhotoDialogLikeSection);
                        }
                        galleryPhotoDialog.open();
                    }
                });
            });
        }).catch(error => {
            console.error("gallery_full.html: Failed to initialize gallery photo dialog; adw-dialog definition not found.", error);
        });
    } else {
        if (!galleryPhotoDialog) console.warn("gallery_full.html: Gallery photo dialog element not found (expected in this page if script is to work).");
        if (!clickableGalleryPhotos || clickableGalleryPhotos.length === 0) console.warn("gallery_full.html: No clickable gallery photos found. Ensure images have '.clickable-gallery-photo' class and data attributes.");
    }

    if (newGalleryCommentForm && galleryCommentText && galleryCommentPhotoIdInput && galleryCommentError) {
        newGalleryCommentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const photoId = galleryCommentPhotoIdInput.value;
            const commentText = galleryCommentText.value.trim();
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (!commentText) {
                galleryCommentError.textContent = "Comment cannot be empty.";
                galleryCommentError.style.display = 'block';
                return;
            }
            galleryCommentError.style.display = 'none';

            try {
                const response = await fetch(\`/photo/api/photos/\${photoId}/comments\`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ text: commentText })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.errors ? JSON.stringify(errorData.errors) : \`HTTP error! status: \${response.status}\`);
                }
                galleryCommentText.value = '';
                fetchGalleryComments(photoId);
            } catch (error) {
                console.error('Error posting comment:', error);
                galleryCommentError.textContent = "Could not post comment: " + error.message;
                galleryCommentError.style.display = 'block';
            }
        });
    }
});
</script>
{% endblock %}
